
- [ ] 1.1 Inventory current embedding runtime coupling.
  - [ ] 1.1.1 Trace every import and helper in `src/DocsToKG/DocParsing/embedding/runtime.py` that pulls vLLM, sentence-transformers, SPLADE, or BM25 internals (e.g., `_get_vllm_components`, `_QWEN_LLM_CACHE`, `QwenEmbeddingQueue`, `_get_sparse_encoder_cls`, `_ensure_*_dependencies`); document call sites, inputs, and returned data structures.
  - [ ] 1.1.2 Record existing CLI flags, env vars, and `EmbedCfg` fields (including presets like `EMBED_PROFILE_PRESETS`) that govern dense, sparse, and lexical settings so they can be mapped into the new provider keys and defaults.
  - [ ] 1.1.3 Capture baseline telemetry/manifest fields produced by `write_vectors` and `manifest_log_*` helpers, plus note how tracemalloc/plan-only flows behave today to ensure parity tests cover them.
- [ ] 1.2 Scaffold the provider package.
  - [ ] 1.2.1 Create `DocsToKG/DocParsing/embedding/backends/` with `__init__.py`, `base.py`, and `factory.py`. In `base.py`, define typed Protocols (or ABCs) for `DenseEmbeddingBackend`, `SparseEmbeddingBackend`, `LexicalEmbeddingBackend` including method signatures, expected return types, and documentation for lifecycle expectations. Add a `ProviderError` dataclass carrying `provider`, `category`, `detail`, `retryable`, and optional `wrapped` exception.
  - [ ] 1.2.2 In `factory.py`, implement `ProviderFactory` (`build_providers(cfg: EmbedCfg, telemetry: TelemetrySink) -> ProviderBundle`) that memoizes provider instances, lazily imports modules, applies shared hints (`device`, `dtype`, `batch_size`, `max_concurrency`, `normalize_l2`, `cache_dir`, telemetry tags), and exposes context managers to guarantee `close()` even on exceptions.
  - [ ] 1.2.3 Add shared utilities (e.g., L2 normalization helpers, dtype coercion, safe device resolution) that providers can reuse without re-introducing runtime coupling. Include docstrings so new providers can follow the pattern.
- [ ] 1.3 Implement dense providers.
  - [ ] 1.3.1 Port the existing sentence-transformers dense embedding path into `embedding/backends/dense/sentence_transformers.py`. Respect `embedding.batch_size`, `dense.sentence_transformers.batch_size`, `embedding.cache_dir`, offline validation, dtype/device hints, and normalization. Ensure weights/tokenizer caching honours `embedding.offline`.
  - [ ] 1.3.2 Build `embedding/backends/dense/tei.py` with HTTP session management (requests via httpx), URL validation, TLS defaults (certifi), retry taxonomy, timeout configuration, and concurrency controls that reflect `embedding.max_concurrency` and `dense.tei.max_inflight`. Emit clear errors when `dense.tei.url` missing.
  - [ ] 1.3.3 Migrate the Qwen/vLLM logic into `embedding/backends/dense/qwen_vllm.py`, folding `_QWEN_LLM_CACHE`, `QwenEmbeddingQueue`, `_qwen_embed_direct`, queue depth configuration derived from `files_parallel`, warmup, quantization, dtype coercion, and model directory handling. Handle GPU detection gracefully and honour `embedding.offline`.
  - [ ] 1.3.4 Ensure each dense provider reports telemetry (`provider_name`, `model_id@rev`, `device`, `dtype`, batch/concurrency hints, open/embed latency, normalization status) via callbacks returned by the factory. Document expected telemetry keys inline.
- [ ] 1.4 Implement sparse and lexical providers.
  - [ ] 1.4.1 Wrap SPLADE sentence-transformers usage in `embedding/backends/sparse/splade_st.py`, moving dependency checks (`ensure_splade_dependencies`), attention backend selection, cache directory use, sparsity threshold warnings, and dtype handling into provider-local code.
  - [ ] 1.4.2 Rehost the BM25 stats accumulator/vectorization logic inside `embedding/backends/lexical/local_bm25.py`, ensuring stats accumulation and vectorization share tokenization, respect `lexical.local_bm25.k1`/`b`, preserve deterministic ordering, and report summary telemetry (avgdl, corpus size).
  - [ ] 1.4.3 Provide explicit placeholder implementations (raising `ProviderError(category="init")`) for future providers such as `dense.fallback` and `lexical.pyserini`, plus a `NullProvider` used when a backend is set to `none`. Cover these in tests so the factory handles disabled backends.
- [ ] 1.5 Rework configuration and CLI plumbing.
  - [ ] 1.5.1 Update `EmbedCfg` (and any Pydantic/dataclass loaders) to introduce nested `embedding.*`, `dense.*`, `sparse.*`, and `lexical.*` keys with defaults from the provider spec. Include validation helpers that return precise error messages with remediation tips (e.g., “Set `dense.tei.url` or switch `dense.backend` to `sentence_transformers`.”).
  - [ ] 1.5.2 Implement precedence logic (config file → env var → CLI, CLI wins) in a single location, and ensure each source populates nested keys correctly. Write helper functions to convert CLI flag names into nested dictionary updates.
  - [ ] 1.5.3 Wire every legacy flag/env var (`--bm25-k1`, `--bm25-b`, `--qwen-batch`, `--sparse-model`, `DOCSTOKG_QWEN_DIR`, `DOCSTOKG_TEI_URL`, etc.) into the new keys, emitting one-line deprecation warnings and ensuring “new key wins” when both present. Document mappings in code comments for maintainability.
  - [ ] 1.5.4 Extend the Typer CLI (`DocsToKG.DocParsing.core.embed`) to expose `--dense-backend`, `--sparse-backend`, `--lexical-backend`, and provider-specific options (URL, model ids, batch sizes) while still accepting legacy flags. Update Typer parameter help strings to reference new config keys for discoverability.
- [ ] 1.6 Integrate providers into the runtime.
  - [ ] 1.6.1 Replace runtime calls to `_get_vllm_components`, `_get_sparse_encoder_cls`, `_QWEN_LLM_CACHE`, `_qwen_embed_direct`, and `QwenEmbeddingQueue` with provider instances from `ProviderFactory`. Delete the obsolete helpers once call sites are migrated.
  - [ ] 1.6.2 Ensure `process_pass_a`/`process_chunk_file_vectors` create provider bundles once per run, call `open()` before processing, and invoke `close()` in `finally` blocks even when errors occur or plan-only mode short-circuits.
  - [ ] 1.6.3 Remove backend-specific globals, queues, caches, and dependency guards from `embedding.runtime`, keeping only orchestration, manifest writing, vector writer seams, and telemetry wiring.
  - [ ] 1.6.4 Confirm dense-disabled (`dense.backend=none`), sparse-disabled, and lexical-disabled configurations skip the corresponding work without writing empty vectors or breaking telemetry/manifest invariants. Add explicit runtime checks so `NullProvider` outputs are ignored.
  - [ ] 1.6.5 Update resume/force/quarantine flows so provider errors propagate with detail while still persisting manifest entries consistent with current behaviour.
- [ ] 1.7 Telemetry and error handling.
  - [ ] 1.7.1 Standardize telemetry emission: expose helper functions in `ProviderFactory` that push `provider_name`, version/model revision, `device`, `dtype`, effective batch size, max inflight requests, timings, normalization flag, fallback usage, and telemetry tags from `EmbedCfg` into `StageTelemetry`.
  - [ ] 1.7.2 Route backend failures through `ProviderError`, mapping categories (`init`, `validation`, `network`, `runtime`) to structured telemetry and CLI messaging. Ensure manifest logs and CLI errors surface `detail` plus remediation hints.
  - [ ] 1.7.3 Add optional hooks so providers can attempt fallbacks (e.g., `dense.fallback`: TEI → sentence-transformers) and expose outcome to calling code. Telemetry should include `fallback_used=true` with `fallback_target`.
- [ ] 1.8 Testing & parity verification.
  - [ ] 1.8.1 Write unit tests for the factory covering every backend selection (`qwen_vllm`, `tei`, `sentence_transformers`, `splade_st`, `local_bm25`, `none`) including config precedence and legacy alias mapping. Place tests under `tests/DocParsing/embedding/backends/test_factory.py`.
  - [ ] 1.8.2 Add provider-specific tests: dense outputs normalized and dimensionally correct, TEI URL validation, SPLADE non-negative weights, BM25 stats/vector determinism, error taxonomy mapping, and telemetry fields presence. Use fixtures/mocks so tests run without heavy dependencies where possible.
  - [ ] 1.8.3 Create golden parity tests that run the embed pipeline with default config (`pytest tests/DocParsing/embedding/test_runtime_parity.py`) and assert JSONL/Parquet vectors match pre-refactor expectations (or float-close within tolerance). Include tracemalloc/plan-only mode checks.
  - [ ] 1.8.4 Ensure optional dependency tests skip gracefully when vLLM/TEI libraries are absent, maintaining CI stability. Provide guidance in test docs for enabling GPU/integration tests locally.
  - [ ] 1.8.5 Add regression tests for `dense.backend=none`/`sparse.backend=none`/`lexical.backend=none` to guarantee disabled providers short-circuit cleanly.
- [ ] 1.9 Documentation & migration notes.
  - [ ] 1.9.1 Update DocParsing README/API references to list available providers, required keys, offline expectations, telemetry fields, and configuration examples (`dense.backend=tei` with `DOCSTOKG_TEI_URL`, `embedding.batch_size=64`).
  - [ ] 1.9.2 Extend `docs-instruct` provider guides with best practices for adding new providers, linking to ProviderOverview, and documenting fallback usage.
  - [ ] 1.9.3 Document deprecation timeline for legacy flags/envs, suggest migration plans for downstream automation, and provide a changelog entry summarizing config renames.
  - [ ] 1.9.4 Add a “provider onboarding” checklist to internal docs so future contributors can follow the same pattern (configuration keys, telemetry, tests, docs).
