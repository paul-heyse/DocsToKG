

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P0 — Correctness &amp; run-stoppers (do these first) &mdash; DocsToKG 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />


      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=8d563738"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



          <a href="index.html" class="icon icon-home">
            DocsToKG
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="01-overview/index.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-setup/index.html">1. Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="03-architecture/index.html">1. Architecture Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-api/index.html">1. API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="05-development/index.html">1. Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="06-operations/index.html">1. Operations Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="07-reference/index.html">1. Technical Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DocsToKG</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">P0 — Correctness &amp; run-stoppers (do these first)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/ContentParsingReview.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <p>Absolutely — here’s a <strong>high-fidelity narrative</strong> for each change to <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/DocParsing</span></code>, written so an engineer (or reviewer) understands the <em>why</em>, the <em>shape</em> of the solution, its <em>blast radius</em>, and <em>how we’ll know it worked</em>. No patches here—this is the “design intent + implementation notes” you can hand off.</p>
<hr class="docutils" />
<section id="p0-correctness-run-stoppers-do-these-first">
<h1>P0 — Correctness &amp; run-stoppers (do these first)<a class="headerlink" href="#p0-correctness-run-stoppers-do-these-first" title="Link to this heading"></a></h1>
<section id="decompose-the-god-module-core-py">
<h2>1) Decompose the “god module” (<code class="docutils literal notranslate"><span class="pre">core.py</span></code>)<a class="headerlink" href="#decompose-the-god-module-core-py" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> <code class="docutils literal notranslate"><span class="pre">core.py</span></code> mixes unrelated concerns (HTTP helpers, CLI glue, manifest logging, JSONL I/O, config types). This creates import-time side effects, brittle couplings (e.g., logging depends on HTTP globals), and makes targeted testing painful.</p>
<p><strong>Change (what).</strong> Split <code class="docutils literal notranslate"><span class="pre">core.py</span></code> into focused modules:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">io.py</span></code> — JSONL readers/writers, atomic file writes, path utilities.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">config.py</span></code> — <code class="docutils literal notranslate"><span class="pre">StageConfigBase</span></code> and stage configs; env/file/CLI overlay; <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> invariants.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">env.py</span></code> (or <code class="docutils literal notranslate"><span class="pre">paths.py</span></code>) — data_root detection + path builders <strong>without touching the filesystem</strong> at import.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logging.py</span></code> — structured <code class="docutils literal notranslate"><span class="pre">log_event</span></code>, manifest formatting, summary composition.</p></li>
</ul>
<p><strong>How it works.</strong> Each module exposes a small API; <code class="docutils literal notranslate"><span class="pre">core.py</span></code> can temporarily re-export to keep imports stable during migration. The CLI imports narrow slices, avoiding heavy imports when not needed.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>No accidental behavior during module import.</p></li>
<li><p>Unit tests can focus on one surface (e.g., JSONL streaming) without spinning up everything else.</p></li>
<li><p>Clear ownership (bugs don’t hide “somewhere in core.py”).</p></li>
</ul>
<p><strong>Blast radius.</strong> Medium: call sites importing <code class="docutils literal notranslate"><span class="pre">core</span></code> symbols will need to swap to new modules (or rely on temporary re-exports).</p>
<p><strong>Definition of done.</strong> <code class="docutils literal notranslate"><span class="pre">core.py</span></code> ≤20% of current size; tests run with only <code class="docutils literal notranslate"><span class="pre">io.py</span></code> imported; no unexpected network/filesystem I/O on import.</p>
</section>
<hr class="docutils" />
<section id="make-jsonl-streaming-no-full-file-materialization">
<h2>2) Make JSONL <strong>streaming</strong> (no full-file materialization)<a class="headerlink" href="#make-jsonl-streaming-no-full-file-materialization" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> <code class="docutils literal notranslate"><span class="pre">jsonl_load</span></code> reads whole files into memory; large corpora cause spikes and GC churn even though we already have internal iterators.</p>
<p><strong>Change (what).</strong> Publicly expose a streaming iterator (and an optional batched iterator). Deprecate eager loaders in stage code paths.</p>
<p><strong>How it works.</strong> Callers iterate records (or batches) as generators. Error handling skips malformed lines without aborting the run; backpressure is natural (downstream speed controls memory).</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Predictable memory even for huge inputs.</p></li>
<li><p>Long-running jobs don’t degrade over time.</p></li>
</ul>
<p><strong>Blast radius.</strong> Low/medium: places calling <code class="docutils literal notranslate"><span class="pre">list(jsonl_load(...))</span></code> will switch to loops; tests update to iterate.</p>
<p><strong>Definition of done.</strong> Chunking/embedding stages process identical inputs with flat memory usage profile; fuzzer test with junk lines doesn’t crash.</p>
</section>
<hr class="docutils" />
<section id="harden-resolve-hash-algorithm-env-override-guard">
<h2>3) Harden <code class="docutils literal notranslate"><span class="pre">resolve_hash_algorithm</span></code> (env override guard)<a class="headerlink" href="#harden-resolve-hash-algorithm-env-override-guard" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> A typo like <code class="docutils literal notranslate"><span class="pre">DOCSTOKG_HASH_ALG=sha-1</span></code> bubbles into <code class="docutils literal notranslate"><span class="pre">hashlib.new</span></code>, failing late with opaque stack traces.</p>
<p><strong>Change (what).</strong> Validate env override against <code class="docutils literal notranslate"><span class="pre">hashlib.algorithms_available</span></code>. If unknown/NaN/blank, log a warning and fall back to a safe default (e.g., <code class="docutils literal notranslate"><span class="pre">sha256</span></code>).</p>
<p><strong>How it works.</strong> All hasher construction flows through a single helper that enforces the guard.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Fail-safe behavior; production jobs don’t die from simple typos.</p></li>
<li><p>Observability: the warning tells ops exactly what happened.</p></li>
</ul>
<p><strong>Blast radius.</strong> Very low; centralized.</p>
<p><strong>Definition of done.</strong> Unit test: bogus env → warning + <code class="docutils literal notranslate"><span class="pre">sha256</span></code>; valid env → selected algo.</p>
</section>
<hr class="docutils" />
<section id="recompute-in-dir-doctags-dir-on-finalize-no-import-time-caching">
<h2>4) Recompute <code class="docutils literal notranslate"><span class="pre">in_dir</span></code> / <code class="docutils literal notranslate"><span class="pre">doctags_dir</span></code> on <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> (no import-time caching)<a class="headerlink" href="#recompute-in-dir-doctags-dir-on-finalize-no-import-time-caching" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> Defaults are captured when modules import. Later environment/CLI updates to <code class="docutils literal notranslate"><span class="pre">data_root</span></code> don’t propagate, so stage runs read/write the wrong directories.</p>
<p><strong>Change (what).</strong> Treat <code class="docutils literal notranslate"><span class="pre">data_root</span></code> as the single source of truth. In each config’s <code class="docutils literal notranslate"><span class="pre">finalize()</span></code>, compute derived paths <strong>only if the user didn’t explicitly set them</strong>.</p>
<p><strong>How it works.</strong> <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> resolves: <code class="docutils literal notranslate"><span class="pre">data_root</span> <span class="pre">:=</span> <span class="pre">CLI</span> <span class="pre">&gt;</span> <span class="pre">env</span> <span class="pre">&gt;</span> <span class="pre">default</span></code>. If <code class="docutils literal notranslate"><span class="pre">in_dir/doctags_dir</span></code> are <code class="docutils literal notranslate"><span class="pre">None</span></code>, set them relative to the resolved <code class="docutils literal notranslate"><span class="pre">data_root</span></code>; otherwise leave them as user-overridden.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>“Late” env/CLI overrides always work.</p></li>
<li><p>No invisible shadowing from import-time constants.</p></li>
</ul>
<p><strong>Blast radius.</strong> Low; only path resolution code.</p>
<p><strong>Definition of done.</strong> Changing <code class="docutils literal notranslate"><span class="pre">DOCSTOKG_DATA_ROOT</span></code> between runs changes actual IO locations without restarting the process.</p>
</section>
<hr class="docutils" />
<section id="move-configuration-invariants-into-finalize">
<h2>5) Move configuration <strong>invariants into <code class="docutils literal notranslate"><span class="pre">finalize()</span></code></strong><a class="headerlink" href="#move-configuration-invariants-into-finalize" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> CLI guards exist, but non-CLI code paths (env/config file) can feed invalid values (e.g., <code class="docutils literal notranslate"><span class="pre">min_tokens</span> <span class="pre">&gt;</span> <span class="pre">max_tokens</span></code>, shard index out of bounds).</p>
<p><strong>Change (what).</strong> Validate invariants in <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> for each stage config:</p>
<ul class="simple">
<li><p>Token windows: non-negative; <code class="docutils literal notranslate"><span class="pre">min</span> <span class="pre">≤</span> <span class="pre">max</span></code>.</p></li>
<li><p>Shards: <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">≤</span> <span class="pre">shard_index</span> <span class="pre">&lt;</span> <span class="pre">shard_count</span></code>.</p></li>
<li><p>Parallelism: integers ≥1 where required (e.g., <code class="docutils literal notranslate"><span class="pre">files_parallel</span></code>).</p></li>
<li><p>Any derived fields computed after validation.</p></li>
</ul>
<p><strong>How it works.</strong> Uniform, early failure with clear error messages regardless of entry point.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Fewer “works on CLI; breaks in batch” incidents.</p></li>
<li><p>Errors point to the cause (not downstream stack traces).</p></li>
</ul>
<p><strong>Blast radius.</strong> Low; validation only.</p>
<p><strong>Definition of done.</strong> Config file with bad values fails fast; equivalent CLI runs behave identically.</p>
</section>
</section>
<hr class="docutils" />
<section id="p1-performance-memory">
<h1>P1 — Performance &amp; memory<a class="headerlink" href="#p1-performance-memory" title="Link to this heading"></a></h1>
<section id="remove-redundant-chunk-manifest-index-loads">
<h2>6) Remove redundant <code class="docutils literal notranslate"><span class="pre">chunk_manifest_index</span></code> loads<a class="headerlink" href="#remove-redundant-chunk-manifest-index-loads" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> The index is loaded twice back-to-back in resume mode; it costs an extra filesystem scan for no benefit.</p>
<p><strong>Change (what).</strong> Load once, reuse. If there’s a fast path (e.g., content hash unchanged), branch early.</p>
<p><strong>How it works.</strong> Store the loaded index in a local variable and pass it along the call chain.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Fewer disk hits; faster cold starts.</p></li>
<li><p>Clearer control flow in resume logic.</p></li>
</ul>
<p><strong>Blast radius.</strong> Very low.</p>
<p><strong>Definition of done.</strong> Trace shows a single load per run; timings improve marginally on large manifests.</p>
</section>
<hr class="docutils" />
<section id="avoid-re-tokenizing-unchanged-records-in-coalesce-small-runs">
<h2>7) Avoid re-tokenizing <strong>unchanged</strong> records in <code class="docutils literal notranslate"><span class="pre">coalesce_small_runs</span></code><a class="headerlink" href="#avoid-re-tokenizing-unchanged-records-in-coalesce-small-runs" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> The final re-tokenization pass hits every output record, even those never merged. With large docs and HF tokenizers, this dominates runtime.</p>
<p><strong>Change (what).</strong> Track which records actually changed during merge decisions; only re-tokenize those. Cache token counts as you merge.</p>
<p><strong>How it works.</strong> The merge loop maintains token counts and a <code class="docutils literal notranslate"><span class="pre">changed</span></code> set. Post-processing only touches changed indices.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Big runtime reduction on large files.</p></li>
<li><p>Identical output; fewer tokenizer calls.</p></li>
</ul>
<p><strong>Blast radius.</strong> Low; confined to the coalesce step.</p>
<p><strong>Definition of done.</strong> Profiling shows significant drop in tokenizer calls and wall-clock time for merge-heavy docs.</p>
</section>
<hr class="docutils" />
<section id="make-tqdm-truly-optional">
<h2>8) Make <code class="docutils literal notranslate"><span class="pre">tqdm</span></code> truly <strong>optional</strong><a class="headerlink" href="#make-tqdm-truly-optional" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> The module docstring says <code class="docutils literal notranslate"><span class="pre">tqdm</span></code> is optional, but it’s imported unconditionally—so “light” environments fail to import.</p>
<p><strong>Change (what).</strong> Wrap the import in <code class="docutils literal notranslate"><span class="pre">try/except</span></code>; provide a no-op fallback function.</p>
<p><strong>How it works.</strong> In dev, you see progress bars; in slim environments, the code still runs, just without progress output.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>No unnecessary dependency failures in minimal containers.</p></li>
<li><p>More flexible deployment targets.</p></li>
</ul>
<p><strong>Blast radius.</strong> Very low.</p>
<p><strong>Definition of done.</strong> Uninstall <code class="docutils literal notranslate"><span class="pre">tqdm</span></code>; module still imports and runs.</p>
</section>
<hr class="docutils" />
<section id="bound-the-embedding-model-cache-lru-explicit-flush">
<h2>9) Bound the embedding model cache (LRU) + explicit flush<a class="headerlink" href="#bound-the-embedding-model-cache-lru-explicit-flush" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> <code class="docutils literal notranslate"><span class="pre">_QWEN_LLM_CACHE</span></code> grows unbounded with distinct configs (prompt templates, precision, quantization, etc.); memory won’t be reclaimed until process exit.</p>
<p><strong>Change (what).</strong> Swap to a small LRU (e.g., size 2–3), and expose <code class="docutils literal notranslate"><span class="pre">flush_llm_cache()</span></code> for long-running workers.</p>
<p><strong>How it works.</strong> New entries evict oldest; evicted models are closed if they expose a <code class="docutils literal notranslate"><span class="pre">close()</span></code>/<code class="docutils literal notranslate"><span class="pre">shutdown()</span></code>. A management signal can clear all entries before switching cohorts.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Prevents slow memory/VRAM growth on varied workloads.</p></li>
<li><p>Operators can flush between batches to reclaim resources.</p></li>
</ul>
<p><strong>Blast radius.</strong> Low; localized to embedding loader.</p>
<p><strong>Definition of done.</strong> Memory profile plateaus with alternating configs; explicit flush reclaims memory.</p>
</section>
</section>
<hr class="docutils" />
<section id="p2-api-typing-modularity">
<h1>P2 — API/typing &amp; modularity<a class="headerlink" href="#p2-api-typing-modularity" title="Link to this heading"></a></h1>
<section id="replace-stringly-typed-context-dicts-with-typed-dataclasses">
<h2>10) Replace “stringly-typed” context dicts with <strong>typed dataclasses</strong><a class="headerlink" href="#replace-stringly-typed-context-dicts-with-typed-dataclasses" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> Many paths pass big dicts (e.g., <code class="docutils literal notranslate"><span class="pre">download_context</span></code>) with magic keys and mutations; typos are silent, and validation is fragmented.</p>
<p><strong>Change (what).</strong> Introduce a <code class="docutils literal notranslate"><span class="pre">&#64;dataclass</span></code> (or <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>) for the context shared between CLI and pipeline. Move defaulting/validation into the dataclass.</p>
<p><strong>How it works.</strong> Callers construct <code class="docutils literal notranslate"><span class="pre">DownloadContext(...)</span></code>; unknown fields are obvious; IDEs/types catch mistakes. The pipeline reads attributes—not magic strings.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Eliminates whole classes of bugs (misspelled keys, wrong types).</p></li>
<li><p>Centralizes defaults (one place to read).</p></li>
</ul>
<p><strong>Blast radius.</strong> Medium: all call sites touching the context convert to the dataclass. Doable incrementally with an adapter.</p>
<p><strong>Definition of done.</strong> No direct <code class="docutils literal notranslate"><span class="pre">dict['some_key']</span></code> lookups for context in the pipeline; typing hints pass.</p>
</section>
<hr class="docutils" />
<section id="verify-serializer-provider-contract-on-load">
<h2>11) Verify serializer provider <strong>contract</strong> on load<a class="headerlink" href="#verify-serializer-provider-contract-on-load" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> <code class="docutils literal notranslate"><span class="pre">_resolve_serializer_provider(&quot;module:Class&quot;)</span></code> only checks that the attribute exists; misconfigured classes fail later (at first method call) with confusing errors.</p>
<p><strong>Change (what).</strong> After importing, assert <code class="docutils literal notranslate"><span class="pre">issubclass</span></code> against the expected base/protocol (e.g., <code class="docutils literal notranslate"><span class="pre">ChunkingSerializerProvider</span></code>). Fail fast with a descriptive error.</p>
<p><strong>How it works.</strong> Misconfigurations show up at stage start, not during mid-pipeline operation.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Fewer runtime “mystery” failures.</p></li>
<li><p>Better UX for config authors.</p></li>
</ul>
<p><strong>Blast radius.</strong> Low.</p>
<p><strong>Definition of done.</strong> Bad provider spec produces an immediate <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> with actionable text.</p>
</section>
<hr class="docutils" />
<section id="remove-import-time-filesystem-side-effects">
<h2>12) Remove <strong>import-time</strong> filesystem side effects<a class="headerlink" href="#remove-import-time-filesystem-side-effects" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> Importing <code class="docutils literal notranslate"><span class="pre">chunking.py</span></code> computes defaults and may create directories. That’s surprising for library consumers inspecting types or running dry tests.</p>
<p><strong>Change (what).</strong> Move directory creation and path resolution into <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> or the stage runner. Importing the module should be a no-op beyond definitions.</p>
<p><strong>How it works.</strong> Defaults are stored as callables or <code class="docutils literal notranslate"><span class="pre">default_factory</span></code>; only when a config is materialized (and a stage invoked) do we make directories.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>No hidden I/O on import; safer to embed into other systems.</p></li>
<li><p>Cleaner test environments.</p></li>
</ul>
<p><strong>Blast radius.</strong> Low/medium: remove <code class="docutils literal notranslate"><span class="pre">os.makedirs(...)</span></code> and similar from module top level.</p>
<p><strong>Definition of done.</strong> Importing DocParsing modules never creates folders on disk; stage start does.</p>
</section>
</section>
<hr class="docutils" />
<section id="p3-logging-observability-deduplication">
<h1>P3 — Logging/observability &amp; deduplication<a class="headerlink" href="#p3-logging-observability-deduplication" title="Link to this heading"></a></h1>
<section id="prefer-structured-logging-no-bare-print">
<h2>13) Prefer structured logging; no bare <code class="docutils literal notranslate"><span class="pre">print()</span></code><a class="headerlink" href="#prefer-structured-logging-no-bare-print" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> <code class="docutils literal notranslate"><span class="pre">_validate_chunk_files()</span></code> prints a summary to stdout while the rest of the stage uses structured <code class="docutils literal notranslate"><span class="pre">log_event</span></code>. Mixed styles complicate capture and correlation.</p>
<p><strong>Change (what).</strong> Emit summaries via the logging façade with consistent event names/keys, or return the summary object for the caller to log.</p>
<p><strong>How it works.</strong> Every message includes run id, stage, file id, shard, and any durations/sizes; collectors can parse uniformly.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Clean logs; easier to filter/analyze.</p></li>
<li><p>No interleaving mess with other prints.</p></li>
</ul>
<p><strong>Blast radius.</strong> Very low.</p>
<p><strong>Definition of done.</strong> No <code class="docutils literal notranslate"><span class="pre">print</span></code> in stage code (except explicit user-facing CLI banners).</p>
</section>
<hr class="docutils" />
<section id="deduplicate-helpers-and-schema-version-normalization">
<h2>14) Deduplicate helpers and schema-version normalization<a class="headerlink" href="#deduplicate-helpers-and-schema-version-normalization" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> We have multiple near-copies of <code class="docutils literal notranslate"><span class="pre">dedupe_preserve_order</span></code>, and both <code class="docutils literal notranslate"><span class="pre">ensure_chunk_schema</span></code> and <code class="docutils literal notranslate"><span class="pre">process_pass_a</span></code> normalize schema versions independently.</p>
<p><strong>Change (what).</strong> Keep one canonical helper per concern:</p>
<ul class="simple">
<li><p>One <code class="docutils literal notranslate"><span class="pre">dedupe_preserve_order</span></code> in <code class="docutils literal notranslate"><span class="pre">io.py</span></code>/<code class="docutils literal notranslate"><span class="pre">utils.py</span></code>.</p></li>
<li><p>One <code class="docutils literal notranslate"><span class="pre">ensure_chunk_schema(rec)</span></code> used everywhere.</p></li>
<li><p>Remove accidental double decorators (e.g., <code class="docutils literal notranslate"><span class="pre">&#64;classmethod</span></code> twice).</p></li>
</ul>
<p><strong>How it works.</strong> Every code path that needs schema defaulting calls the single helper; future schema upgrades touch one place.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Prevents drift when taxonomy evolves.</p></li>
<li><p>Simpler reviews (fewer places to check).</p></li>
</ul>
<p><strong>Blast radius.</strong> Low.</p>
<p><strong>Definition of done.</strong> Grep shows a single definition for each helper; callers updated accordingly.</p>
</section>
<hr class="docutils" />
<section id="clarify-who-owns-manifest-logging-and-aggregation">
<h2>15) Clarify who owns <strong>manifest logging and aggregation</strong><a class="headerlink" href="#clarify-who-owns-manifest-logging-and-aggregation" title="Link to this heading"></a></h2>
<p><strong>Problem.</strong> The CLI currently does manifest writes and run summaries while the pipeline already emits structured attempts. Responsibility is blurred, and reuse outside the CLI is harder.</p>
<p><strong>Change (what).</strong> Move manifest composition and aggregation into telemetry (or a small orchestrator module). The CLI coordinates: parse args → build config → call runner → render summaries <strong>from telemetry’s outputs</strong>.</p>
<p><strong>How it works.</strong> Pipeline sends attempt records; telemetry sinks produce per-work manifests and aggregation; the CLI is a thin façade.</p>
<p><strong>Why it reduces risk.</strong></p>
<ul class="simple">
<li><p>Single source of truth for manifest shape.</p></li>
<li><p>The pipeline can be reused by other entry points (service/API) with consistent outputs.</p></li>
</ul>
<p><strong>Blast radius.</strong> Medium: the CLI gets slimmer; telemetry takes on more responsibility.</p>
<p><strong>Definition of done.</strong> Turning off the CLI still yields manifests if the pipeline + telemetry are invoked from another program.</p>
</section>
</section>
<hr class="docutils" />
<section id="cross-cutting-test-plan-what-proves-the-changes-worked">
<h1>Cross-cutting test plan (what proves the changes worked)<a class="headerlink" href="#cross-cutting-test-plan-what-proves-the-changes-worked" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p><strong>Config invariants</strong>: invalid token/shard values fail in <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> regardless of entry path (env/file/CLI).</p></li>
<li><p><strong>JSONL streaming</strong>: huge JSONL files process at a flat memory footprint; malformed lines don’t abort the run.</p></li>
<li><p><strong>Hash guard</strong>: invalid env algorithms produce warnings and fall back; valid ones are honored.</p></li>
<li><p><strong>No import side effects</strong>: importing modules does not create directories; running stages does.</p></li>
<li><p><strong>Serializer contract</strong>: bad provider raises a clear error on start.</p></li>
<li><p><strong>Coalesce optimization</strong>: mock tokenizer indicates fewer calls; wall-clock reduces on large docs.</p></li>
<li><p><strong>Embedding cache</strong>: alternating configs keep memory bounded; <code class="docutils literal notranslate"><span class="pre">flush_llm_cache()</span></code> drops allocations.</p></li>
<li><p><strong>Structured logging</strong>: log stream includes canonical events for validation/summary; no stray prints.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="roll-out-plan-low-thrash">
<h1>Roll-out plan (low thrash)<a class="headerlink" href="#roll-out-plan-low-thrash" title="Link to this heading"></a></h1>
<ol class="arabic simple">
<li><p><strong>Day 0 (P0):</strong> JSONL streaming; hash guard; <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> reroute + invariants.</p></li>
<li><p><strong>Day 1 (P1):</strong> Drop duplicate index load; coalesce optimization; optional <code class="docutils literal notranslate"><span class="pre">tqdm</span></code>; LRU cache + flush.</p></li>
<li><p><strong>Day 2 (P2):</strong> Extract <code class="docutils literal notranslate"><span class="pre">io.py</span></code>, <code class="docutils literal notranslate"><span class="pre">config.py</span></code>, <code class="docutils literal notranslate"><span class="pre">env.py</span></code>, <code class="docutils literal notranslate"><span class="pre">logging.py</span></code>; introduce typed context; keep re-exports in <code class="docutils literal notranslate"><span class="pre">core.py</span></code>.</p></li>
<li><p><strong>Day 3 (P3):</strong> Structured logging for validators; dedupe helpers; centralize schema normalization; plugin contract check.</p></li>
<li><p><strong>Day 4:</strong> Tests/CI gates; remove temporary re-exports once call sites migrate.</p></li>
</ol>
</section>
<hr class="docutils" />
<section id="tl-dr-prioritized">
<h1>TL;DR (prioritized)<a class="headerlink" href="#tl-dr-prioritized" title="Link to this heading"></a></h1>
<p><strong>P0 – Correctness &amp; run-stoppers (do first)</strong></p>
<ol class="arabic simple">
<li><p>Split <code class="docutils literal notranslate"><span class="pre">core.py</span></code> responsibilities that currently couple unrelated behaviors (HTTP, CLI, logging, JSONL, config).</p></li>
<li><p>Make JSONL <strong>streaming</strong>; don’t materialize whole files.</p></li>
<li><p>Guard <code class="docutils literal notranslate"><span class="pre">resolve_hash_algorithm</span></code> against bad env overrides (e.g., <code class="docutils literal notranslate"><span class="pre">sha-1</span></code>).</p></li>
<li><p>Recompute <code class="docutils literal notranslate"><span class="pre">in_dir</span></code>/<code class="docutils literal notranslate"><span class="pre">doctags_dir</span></code> in <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> when <code class="docutils literal notranslate"><span class="pre">data_root</span></code> changes; stop caching import-time defaults.</p></li>
<li><p>Add config <strong>invariant checks in <code class="docutils literal notranslate"><span class="pre">finalize()</span></code></strong> (e.g., <code class="docutils literal notranslate"><span class="pre">min_tokens</span> <span class="pre">≤</span> <span class="pre">max_tokens</span></code>, shard bounds).</p></li>
</ol>
<p><strong>P1 – Performance &amp; memory</strong>
6) Fix redundant work: drop duplicate <code class="docutils literal notranslate"><span class="pre">chunk_manifest_index</span></code> loads; avoid re-tokenizing unchanged records in <code class="docutils literal notranslate"><span class="pre">coalesce_small_runs</span></code>.
7) Make progress/throughput bits robust and lightweight: optional <code class="docutils literal notranslate"><span class="pre">tqdm</span></code> import, and bounded/evictable caches for LLMs.</p>
<p><strong>P2 – API/typing &amp; modularity</strong>
8) Replace ad-hoc context dicts with typed dataclasses; centralize “overlay” logic (env→file→CLI) in a base config.
9) Verify plugin contracts (serializer provider class really implements the expected interface).
10) Remove import-time filesystem side-effects; create directories lazily.</p>
<p><strong>P3 – Logging/observability &amp; duplication</strong>
11) Route prints through structured logging; keep summaries consistent.
12) Deduplicate helpers (e.g., <code class="docutils literal notranslate"><span class="pre">dedupe_preserve_order</span></code>) and schema-version normalization in one place.</p>
<hr class="docutils" />
<p>You got it. Below are <strong>drop-in Python snippets</strong> in the exact order I just described (P0 → P3, items 1–15). They’re written to be easy to paste into your tree under <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/DocParsing/…</span></code>. Names are conservative so they won’t collide; adjust imports to match your package layout.</p>
<hr class="docutils" />
<section id="p0-correctness-run-stoppers">
<h2>P0 — Correctness &amp; run-stoppers<a class="headerlink" href="#p0-correctness-run-stoppers" title="Link to this heading"></a></h2>
<section id="decompose-core-py-into-focused-modules-shim-stubs">
<h3>1) Decompose <code class="docutils literal notranslate"><span class="pre">core.py</span></code> into focused modules (shim + stubs)<a class="headerlink" href="#decompose-core-py-into-focused-modules-shim-stubs" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/core.py  (temporary shim during decomposition)</span>
<span class="c1"># Goal: re-export from focused modules so callers don&#39;t break during the split.</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">iter_jsonl</span><span class="p">,</span> <span class="n">iter_jsonl_batches</span><span class="p">,</span> <span class="n">write_jsonl_atomically</span><span class="p">,</span> <span class="n">dedupe_preserve_order</span><span class="p">,</span> <span class="n">make_hasher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">StageConfigBase</span><span class="p">,</span> <span class="n">ChunkerCfg</span><span class="p">,</span> <span class="n">EmbeddingCfg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">detect_data_root</span><span class="p">,</span> <span class="n">path_doctags</span><span class="p">,</span> <span class="n">path_chunks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_event</span><span class="p">,</span> <span class="n">ManifestWriter</span><span class="p">,</span> <span class="n">Summary</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;iter_jsonl&quot;</span><span class="p">,</span> <span class="s2">&quot;iter_jsonl_batches&quot;</span><span class="p">,</span> <span class="s2">&quot;write_jsonl_atomically&quot;</span><span class="p">,</span> <span class="s2">&quot;dedupe_preserve_order&quot;</span><span class="p">,</span> <span class="s2">&quot;make_hasher&quot;</span><span class="p">,</span>
    <span class="s2">&quot;StageConfigBase&quot;</span><span class="p">,</span> <span class="s2">&quot;ChunkerCfg&quot;</span><span class="p">,</span> <span class="s2">&quot;EmbeddingCfg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detect_data_root&quot;</span><span class="p">,</span> <span class="s2">&quot;path_doctags&quot;</span><span class="p">,</span> <span class="s2">&quot;path_chunks&quot;</span><span class="p">,</span>
    <span class="s2">&quot;log_event&quot;</span><span class="p">,</span> <span class="s2">&quot;ManifestWriter&quot;</span><span class="p">,</span> <span class="s2">&quot;Summary&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/paths.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">def</span><span class="w"> </span><span class="nf">detect_data_root</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DOCSTOKG_DATA_ROOT&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">path_doctags</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="s2">&quot;doctags&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">path_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="s2">&quot;chunks&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/logging.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">logging</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;DocsToKG.DocParsing&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">log_event</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="o">**</span><span class="n">fields</span><span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Summary</span><span class="p">:</span>
    <span class="n">processed</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">succeeded</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">failed</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">duration_s</span><span class="p">:</span> <span class="nb">float</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ManifestWriter</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">Summary</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_row</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">asdict</span><span class="p">(</span><span class="n">summary</span><span class="p">)})</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="streaming-jsonl-and-batched-readers">
<h3>2) Streaming JSONL (and batched) readers<a class="headerlink" href="#streaming-jsonl-and-batched-readers" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/io.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span><span class="o">,</span><span class="w"> </span><span class="nn">shutil</span>

<span class="k">def</span><span class="w"> </span><span class="nf">iter_jsonl</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="c1"># optionally: log_event(&quot;jsonl_decode_error&quot;, path=str(path))</span>
                <span class="k">continue</span>

<span class="k">def</span><span class="w"> </span><span class="nf">iter_jsonl_batches</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]:</span>
    <span class="n">buf</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">iter_jsonl</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">batch_size</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">buf</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">buf</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">buf</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_atomic_write</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
    <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;atom-&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.part&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tmp</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">f</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">write_jsonl_atomically</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">_atomic_write</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dedupe_preserve_order</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">();</span> <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_hasher</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sha256&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;hashlib._Hash&quot;</span><span class="p">:</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DOCSTOKG_HASH_ALG&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">alg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">algorithms_available</span><span class="p">:</span>
        <span class="c1"># optional: log_event(&quot;unknown_hash_alg&quot;, alg=alg, fallback=default)</span>
        <span class="n">alg</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="safe-hash-algorithm-override-already-included-above-as-make-hasher">
<h3>3) Safe hash-algorithm override (already included above as <code class="docutils literal notranslate"><span class="pre">make_hasher</span></code>)<a class="headerlink" href="#safe-hash-algorithm-override-already-included-above-as-make-hasher" title="Link to this heading"></a></h3>
<blockquote>
<div><p>See <code class="docutils literal notranslate"><span class="pre">make_hasher()</span></code> in the snippet just above. It guards env overrides and falls back to <code class="docutils literal notranslate"><span class="pre">sha256</span></code>.</p>
</div></blockquote>
</section>
<hr class="docutils" />
<section id="recompute-dirs-on-finalize-no-import-time-caching">
<h3>4) Recompute dirs on <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> (no import-time caching)<a class="headerlink" href="#recompute-dirs-on-finalize-no-import-time-caching" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/config.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fields</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">detect_data_root</span><span class="p">,</span> <span class="n">path_doctags</span><span class="p">,</span> <span class="n">path_chunks</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">StageConfigBase</span><span class="p">:</span>
    <span class="n">data_root</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_sources</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cfg_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">defaults</span> <span class="ow">or</span> <span class="p">{}))</span>
        <span class="c1"># 1) file</span>
        <span class="k">if</span> <span class="n">cfg_path</span> <span class="ow">and</span> <span class="n">cfg_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="c1"># 2) env for data_root</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DOCSTOKG_DATA_ROOT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dr</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;data_root&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">data_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="c1"># 3) CLI args override</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ChunkerCfg</span><span class="p">(</span><span class="n">StageConfigBase</span><span class="p">):</span>
    <span class="n">in_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">doctags_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">min_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">70</span>
    <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">260</span>
    <span class="n">shard_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">shard_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># … other knobs …</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChunkerCfg&quot;</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_root</span> <span class="ow">or</span> <span class="n">detect_data_root</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_dir</span> <span class="o">=</span> <span class="n">path_doctags</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doctags_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doctags_dir</span> <span class="o">=</span> <span class="n">path_doctags</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">path_chunks</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="c1"># invariants (see item 5)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_tokens</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;min_tokens/max_tokens must be non-negative&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_tokens</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;min_tokens must be ≤ max_tokens&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_count</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;shard_index must be in [0, shard_count)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EmbeddingCfg</span><span class="p">(</span><span class="n">StageConfigBase</span><span class="p">):</span>
    <span class="n">files_parallel</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c1"># …</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EmbeddingCfg&quot;</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_root</span> <span class="ow">or</span> <span class="n">detect_data_root</span><span class="p">()</span>
        <span class="c1"># derive any paths from root if needed…</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_parallel</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;files_parallel must be ≥ 1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="invariant-checks-in-finalize-already-included-above">
<h3>5) Invariant checks in <code class="docutils literal notranslate"><span class="pre">finalize()</span></code> (already included above)<a class="headerlink" href="#invariant-checks-in-finalize-already-included-above" title="Link to this heading"></a></h3>
<blockquote>
<div><p>See <code class="docutils literal notranslate"><span class="pre">ChunkerCfg.finalize()</span></code> and <code class="docutils literal notranslate"><span class="pre">EmbeddingCfg.finalize()</span></code> in the snippet just above (min/max tokens, shard bounds, parallelism).</p>
</div></blockquote>
</section>
</section>
<hr class="docutils" />
<section id="id1">
<h2>P1 — Performance &amp; memory<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<section id="load-chunk-manifest-index-once-resume-path">
<h3>6) Load <code class="docutils literal notranslate"><span class="pre">chunk_manifest_index</span></code> once (resume path)<a class="headerlink" href="#load-chunk-manifest-index-once-resume-path" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/chunking.py  (inside your resume orchestration)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_chunking</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ChunkerCfg</span><span class="p">,</span> <span class="n">manifest_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">manifest_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">resume</span> <span class="ow">and</span> <span class="n">manifest_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">manifest_index</span> <span class="o">=</span> <span class="n">load_chunk_manifest_index</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">)</span>  <span class="c1"># ← single load</span>
    <span class="c1"># pass manifest_index down; do not call load_chunk_manifest_index again</span>
    <span class="n">process_inputs</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">manifest_index</span><span class="o">=</span><span class="n">manifest_index</span><span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="id2">
<h3>7) Avoid re-tokenizing unchanged records in <code class="docutils literal notranslate"><span class="pre">coalesce_small_runs</span></code><a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/chunking.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>

<span class="k">def</span><span class="w"> </span><span class="nf">coalesce_small_runs</span><span class="p">(</span><span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">tokenizer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="c1"># Assume each chunk has &#39;text&#39; and &#39;token_count&#39;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[:]</span>  <span class="c1"># shallow copy</span>
    <span class="n">changed</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># decide if merge is needed (example condition)</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;token_count&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">merged_text</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
            <span class="c1"># approximate new token_count by adding; we will re-tokenize later</span>
            <span class="n">approx_tokens</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;token_count&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;token_count&quot;</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">merged_text</span><span class="p">,</span> <span class="s2">&quot;token_count&quot;</span><span class="p">:</span> <span class="n">approx_tokens</span><span class="p">}</span>
            <span class="k">del</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># mark merged index</span>
            <span class="k">continue</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># re-tokenize ONLY changed indices</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">changed</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;token_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="id3">
<h3>8) Make <code class="docutils literal notranslate"><span class="pre">tqdm</span></code> truly optional<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/embedding.py (top of file)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tqdm</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># no-op fallback</span>
        <span class="k">return</span> <span class="n">it</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="bound-the-embedding-model-cache-lru-flush">
<h3>9) Bound the embedding model cache (LRU) + flush<a class="headerlink" href="#bound-the-embedding-model-cache-lru-flush" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/embedding.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span><span class="w"> </span><span class="nc">_LRU</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">=</span> <span class="n">maxsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># mark as recently used</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">factory</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">evicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">evicted</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">_QWEN_LLM_CACHE</span> <span class="o">=</span> <span class="n">_LRU</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_qwen_model</span><span class="p">(</span><span class="n">cfg_tuple</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">factory</span><span class="p">():</span>
        <span class="c1"># construct the model for this cfg_tuple</span>
        <span class="k">return</span> <span class="n">_make_qwen_model</span><span class="p">(</span><span class="n">cfg_tuple</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_QWEN_LLM_CACHE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg_tuple</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">flush_llm_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_QWEN_LLM_CACHE</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id4">
<h2>P2 — API/typing &amp; modularity<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<section id="replace-context-dicts-with-typed-dataclasses">
<h3>10) Replace context dicts with typed dataclasses<a class="headerlink" href="#replace-context-dicts-with-typed-dataclasses" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/context.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ParsingContext</span><span class="p">:</span>
    <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">data_root</span><span class="p">:</span> <span class="n">Path</span>
    <span class="c1"># IO/paths</span>
    <span class="n">in_dir</span><span class="p">:</span> <span class="n">Path</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="n">Path</span>
    <span class="n">doctags_dir</span><span class="p">:</span> <span class="n">Path</span>
    <span class="c1"># chunking knobs</span>
    <span class="n">min_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">70</span>
    <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">260</span>
    <span class="c1"># execution</span>
    <span class="n">files_parallel</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c1"># feature toggles / misc</span>
    <span class="n">enable_validation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">extra</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>Use <code class="docutils literal notranslate"><span class="pre">ParsingContext</span></code> across CLI → chunking/embedding instead of <code class="docutils literal notranslate"><span class="pre">dict</span></code> lookups; add/adjust fields to match your current usage.</p>
</div></blockquote>
</section>
<hr class="docutils" />
<section id="verify-serializer-provider-contract-early">
<h3>11) Verify serializer provider contract early<a class="headerlink" href="#verify-serializer-provider-contract-early" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/interfaces.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Iterable</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ChunkingSerializerProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/chunking.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChunkingSerializerProvider</span>

<span class="k">def</span><span class="w"> </span><span class="nf">resolve_serializer_provider</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">ChunkingSerializerProvider</span><span class="p">]:</span>
    <span class="n">mod_name</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">cls_name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sep</span> <span class="o">!=</span> <span class="s2">&quot;:&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mod_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cls_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad provider spec </span><span class="si">{</span><span class="n">spec</span><span class="si">!r}</span><span class="s2">; expected &#39;module:Class&#39;&quot;</span><span class="p">)</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">import_module</span><span class="p">(</span><span class="n">mod_name</span><span class="p">),</span> <span class="n">cls_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ChunkingSerializerProvider</span><span class="p">):</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="si">!r}</span><span class="s2"> is not a ChunkingSerializerProvider&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span>  <span class="c1"># type: ignore[return-value]</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="id5">
<h3>12) Remove import-time filesystem side-effects<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># BAD (remove this pattern from module top-level):</span>
<span class="c1"># DEFAULT_ROOT = detect_data_root(); DEFAULT_OUT = path_chunks(DEFAULT_ROOT); DEFAULT_OUT.mkdir(parents=True, exist_ok=True)</span>

<span class="c1"># GOOD: create dirs only when running the stage</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_output_dirs</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ChunkerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">doctags_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Call <code class="docutils literal notranslate"><span class="pre">ensure_output_dirs(cfg)</span></code> in the stage runner just before writing outputs.</p>
</section>
</section>
<hr class="docutils" />
<section id="id6">
<h2>P3 — Logging/observability &amp; deduplication<a class="headerlink" href="#id6" title="Link to this heading"></a></h2>
<section id="structured-logging-for-validators-no-prints">
<h3>13) Structured logging for validators; no prints<a class="headerlink" href="#structured-logging-for-validators-no-prints" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/chunking.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_event</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_validate_chunk_files</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s2">&quot;bytes&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">)}</span>
    <span class="c1"># return the dict; the caller logs it</span>
    <span class="k">return</span> <span class="n">stats</span>

<span class="c1"># CLI / runner:</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">_validate_chunk_files</span><span class="p">(</span><span class="n">input_paths</span><span class="p">)</span>
<span class="n">log_event</span><span class="p">(</span><span class="s2">&quot;chunk_validation&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">stats</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;chunking&quot;</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="deduplicate-helpers-schema-version-normalization">
<h3>14) Deduplicate helpers + schema-version normalization<a class="headerlink" href="#deduplicate-helpers-schema-version-normalization" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/schema.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_chunk_schema</span><span class="p">(</span><span class="n">rec</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">default_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;v1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">rec</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;schema_version&quot;</span><span class="p">,</span> <span class="n">default_version</span><span class="p">)</span>
    <span class="c1"># additional normalization/validation here…</span>
    <span class="k">return</span> <span class="n">rec</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/io.py  (already houses dedupe_preserve_order)</span>
<span class="c1"># Ensure doctags.py imports and reuses: from .io import dedupe_preserve_order</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/doctags.py  (fix accidental double decorator)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DoctagsCfg</span><span class="p">(</span><span class="n">StageConfigBase</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_env</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="c1"># ← ensure this appears only once</span>
        <span class="c1"># construct from env…</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">ensure_chunk_schema(rec)</span></code> anywhere you previously normalized the schema in ad-hoc loops.</p>
</section>
<hr class="docutils" />
<section id="clarify-manifest-ownership-telemetry-sink-owns-it">
<h3>15) Clarify manifest ownership (telemetry sink owns it)<a class="headerlink" href="#clarify-manifest-ownership-telemetry-sink-owns-it" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># src/DocsToKG/DocParsing/telemetry.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Attempt</span><span class="p">:</span>
    <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">started_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">finished_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="nb">bytes</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ManifestEntry</span><span class="p">:</span>
    <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">schema_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">duration_s</span><span class="p">:</span> <span class="nb">float</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TelemetrySink</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attempts_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">manifest_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attempts_path</span> <span class="o">=</span> <span class="n">attempts_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_path</span> <span class="o">=</span> <span class="n">manifest_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">Attempt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attempts_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_manifest_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">ManifestEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_manifest_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># CLI / runner (thin façade):</span>
<span class="n">sink</span> <span class="o">=</span> <span class="n">TelemetrySink</span><span class="p">(</span><span class="n">attempts_path</span><span class="p">,</span> <span class="n">manifest_path</span><span class="p">)</span>
<span class="c1"># pipeline code calls sink.write_attempt(...) and sink.write_manifest_entry(...)</span>
<span class="c1"># CLI only renders summaries from what sink produced.</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="notes">
<h3>Notes<a class="headerlink" href="#notes" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Keep the <strong>temporary re-exports</strong> in <code class="docutils literal notranslate"><span class="pre">core.py</span></code> until all call-sites update; then delete the shim.</p></li>
<li><p>For <strong>percentiles</strong> and other stats in long runs, prefer bounded deques (like you did for ContentDownload) or streaming quantiles if you need precise p-levels.</p></li>
</ul>
<p>If you want these wrapped into specific file-level mini-PRs (e.g., “P0-hotfix set” vs “P2-refactor set”), I can lay them out as commit-ready diffs next.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, DocsToKG Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
