

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Implementation Tasks &mdash; DocsToKG 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            DocsToKG
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../01-overview/index.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../02-setup/index.html">1. Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../03-architecture/index.html">1. Architecture Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../04-api/index.html">1. API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../05-development/index.html">1. Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../06-operations/index.html">1. Operations Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../07-reference/index.html">1. Technical Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DocsToKG</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Implementation Tasks</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/openspec/changes/refactor-docparsing-pipeline/tasks.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="implementation-tasks">
<h1>Implementation Tasks<a class="headerlink" href="#implementation-tasks" title="Link to this heading"></a></h1>
<section id="shared-utilities-infrastructure">
<h2>1. Shared Utilities Infrastructure<a class="headerlink" href="#shared-utilities-infrastructure" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 1.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/DocParsing/_common.py</span></code> module</p>
<ul class="simple">
<li><p>Add module-level docstring: “Shared utilities for DocParsing pipeline stages (path resolution, I/O, logging, batching)”</p></li>
<li><p>Import statements needed: <code class="docutils literal notranslate"><span class="pre">os</span></code>, <code class="docutils literal notranslate"><span class="pre">pathlib.Path</span></code>, <code class="docutils literal notranslate"><span class="pre">logging</span></code>, <code class="docutils literal notranslate"><span class="pre">json</span></code>, <code class="docutils literal notranslate"><span class="pre">socket</span></code>, <code class="docutils literal notranslate"><span class="pre">typing</span></code>, <code class="docutils literal notranslate"><span class="pre">contextlib</span></code>, <code class="docutils literal notranslate"><span class="pre">hashlib</span></code>, <code class="docutils literal notranslate"><span class="pre">datetime</span></code>, <code class="docutils literal notranslate"><span class="pre">time</span></code></p></li>
<li><p>Define <code class="docutils literal notranslate"><span class="pre">__all__</span></code> list: <code class="docutils literal notranslate"><span class="pre">[&quot;detect_data_root&quot;,</span> <span class="pre">&quot;data_doctags&quot;,</span> <span class="pre">&quot;data_chunks&quot;,</span> <span class="pre">&quot;data_vectors&quot;,</span> <span class="pre">&quot;data_manifests&quot;,</span> <span class="pre">&quot;find_free_port&quot;,</span> <span class="pre">&quot;atomic_write&quot;,</span> <span class="pre">&quot;iter_doctags&quot;,</span> <span class="pre">&quot;iter_chunks&quot;,</span> <span class="pre">&quot;jsonl_load&quot;,</span> <span class="pre">&quot;jsonl_save&quot;,</span> <span class="pre">&quot;get_logger&quot;,</span> <span class="pre">&quot;Batcher&quot;,</span> <span class="pre">&quot;manifest_append&quot;,</span> <span class="pre">&quot;compute_content_hash&quot;,</span> <span class="pre">&quot;acquire_lock&quot;]</span></code></p></li>
</ul>
</li>
<li><p>[ ] 1.2 Implement <code class="docutils literal notranslate"><span class="pre">detect_data_root(start:</span> <span class="pre">Path)</span> <span class="pre">-&gt;</span> <span class="pre">Path</span></code> function with env var support</p>
<ul class="simple">
<li><p><strong>Full Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">detect_data_root(start:</span> <span class="pre">Optional[Path]</span> <span class="pre">=</span> <span class="pre">None)</span> <span class="pre">-&gt;</span> <span class="pre">Path</span></code></p></li>
<li><p><strong>Implementation Steps</strong>:</p>
<ol class="arabic simple">
<li><p>Check environment variable: <code class="docutils literal notranslate"><span class="pre">env_root</span> <span class="pre">=</span> <span class="pre">os.getenv(&quot;DOCSTOKG_DATA_ROOT&quot;)</span></code></p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">env_root</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">None</span></code>: validate it exists and return <code class="docutils literal notranslate"><span class="pre">Path(env_root).resolve()</span></code></p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">start</span></code> is None, set to <code class="docutils literal notranslate"><span class="pre">Path.cwd()</span></code>, else resolve it: <code class="docutils literal notranslate"><span class="pre">start</span> <span class="pre">=</span> <span class="pre">start.resolve()</span></code></p></li>
<li><p>Iterate ancestors: <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">anc</span> <span class="pre">in</span> <span class="pre">[start,</span> <span class="pre">*start.parents]:</span></code></p></li>
<li><p>Check each candidate: <code class="docutils literal notranslate"><span class="pre">candidate</span> <span class="pre">=</span> <span class="pre">anc</span> <span class="pre">/</span> <span class="pre">&quot;Data&quot;</span></code></p></li>
<li><p>Validate candidate by checking if it contains expected subdirs: <code class="docutils literal notranslate"><span class="pre">any((candidate</span> <span class="pre">/</span> <span class="pre">d).is_dir()</span> <span class="pre">for</span> <span class="pre">d</span> <span class="pre">in</span> <span class="pre">[&quot;PDFs&quot;,</span> <span class="pre">&quot;HTML&quot;,</span> <span class="pre">&quot;DocTagsFiles&quot;,</span> <span class="pre">&quot;ChunkedDocTagFiles&quot;])</span></code></p></li>
<li><p>Return first valid candidate</p></li>
<li><p>If loop completes without finding, return <code class="docutils literal notranslate"><span class="pre">start</span> <span class="pre">/</span> <span class="pre">&quot;Data&quot;</span></code> (fallback)</p></li>
</ol>
</li>
<li><p><strong>Error Handling</strong>: If env var points to non-existent path, raise <code class="docutils literal notranslate"><span class="pre">FileNotFoundError(f&quot;DOCSTOKG_DATA_ROOT</span> <span class="pre">points</span> <span class="pre">to</span> <span class="pre">non-existent</span> <span class="pre">directory:</span> <span class="pre">{env_root}&quot;)</span></code></p></li>
<li><p><strong>Docstring</strong>: Must include Args, Returns, Raises, Examples sections</p></li>
</ul>
</li>
<li><p>[ ] 1.3 Implement typed path getters: <code class="docutils literal notranslate"><span class="pre">data_doctags()</span></code>, <code class="docutils literal notranslate"><span class="pre">data_chunks()</span></code>, <code class="docutils literal notranslate"><span class="pre">data_vectors()</span></code>, <code class="docutils literal notranslate"><span class="pre">data_manifests()</span></code></p>
<ul>
<li><p><strong>Signature for each</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">data_&lt;name&gt;(root:</span> <span class="pre">Optional[Path]</span> <span class="pre">=</span> <span class="pre">None)</span> <span class="pre">-&gt;</span> <span class="pre">Path</span></code></p></li>
<li><p><strong>Implementation Template</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">data_doctags</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">detect_data_root</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">base</span> <span class="o">/</span> <span class="s2">&quot;DocTagsFiles&quot;</span>
    <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Create identical implementations for:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">data_chunks()</span></code> → <code class="docutils literal notranslate"><span class="pre">&quot;ChunkedDocTagFiles&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data_vectors()</span></code> → <code class="docutils literal notranslate"><span class="pre">&quot;Vectors&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data_manifests()</span></code> → <code class="docutils literal notranslate"><span class="pre">&quot;Manifests&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data_pdfs()</span></code> → <code class="docutils literal notranslate"><span class="pre">&quot;PDFs&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data_html()</span></code> → <code class="docutils literal notranslate"><span class="pre">&quot;HTML&quot;</span></code></p></li>
</ul>
</li>
<li><p>Each function MUST create the directory if it doesn’t exist</p></li>
</ul>
</li>
<li><p>[ ] 1.4 Implement <code class="docutils literal notranslate"><span class="pre">find_free_port(start:</span> <span class="pre">int,</span> <span class="pre">span:</span> <span class="pre">int)</span> <span class="pre">-&gt;</span> <span class="pre">int</span></code> function</p>
<ul>
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">find_free_port(start:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">8000,</span> <span class="pre">span:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">32)</span> <span class="pre">-&gt;</span> <span class="pre">int</span></code></p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">span</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">port</span>  <span class="c1"># Port is free</span>
<span class="c1"># Fallback: let OS assign ephemeral port</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All ports </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">start</span><span class="o">+</span><span class="n">span</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> busy; using OS-assigned port&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 1.5 Implement <code class="docutils literal notranslate"><span class="pre">atomic_write(path:</span> <span class="pre">Path)</span></code> context manager</p>
<ul>
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">&#64;contextlib.contextmanager</span> <span class="pre">def</span> <span class="pre">atomic_write(path:</span> <span class="pre">Path)</span> <span class="pre">-&gt;</span> <span class="pre">Iterator[TextIO]</span></code></p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tmp</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">tmp</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">f</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>  <span class="c1"># Force write to disk</span>
    <span class="n">tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># Atomic rename on POSIX</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">tmp</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">raise</span>
</pre></div>
</div>
</li>
<li><p><strong>Usage Example</strong>: <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">atomic_write(output_path)</span> <span class="pre">as</span> <span class="pre">f:</span> <span class="pre">json.dump(data,</span> <span class="pre">f)</span></code></p></li>
</ul>
</li>
<li><p>[ ] 1.6 Implement <code class="docutils literal notranslate"><span class="pre">iter_doctags(directory:</span> <span class="pre">Path)</span> <span class="pre">-&gt;</span> <span class="pre">Iterator[Path]</span></code> generator</p>
<ul>
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">iter_doctags(directory:</span> <span class="pre">Path)</span> <span class="pre">-&gt;</span> <span class="pre">Iterator[Path]</span></code></p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;*.doctags&quot;</span><span class="p">,</span> <span class="s2">&quot;*.doctag&quot;</span><span class="p">]</span>
<span class="n">found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="k">yield from</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 1.7 Implement <code class="docutils literal notranslate"><span class="pre">iter_chunks(directory:</span> <span class="pre">Path)</span> <span class="pre">-&gt;</span> <span class="pre">Iterator[Path]</span></code> generator</p>
<ul class="simple">
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">iter_chunks(directory:</span> <span class="pre">Path)</span> <span class="pre">-&gt;</span> <span class="pre">Iterator[Path]</span></code></p></li>
<li><p><strong>Implementation</strong>: <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span> <span class="pre">sorted(p</span> <span class="pre">for</span> <span class="pre">p</span> <span class="pre">in</span> <span class="pre">directory.glob(&quot;*.chunks.jsonl&quot;)</span> <span class="pre">if</span> <span class="pre">p.is_file())</span></code></p></li>
<li><p>NOTE: Use <code class="docutils literal notranslate"><span class="pre">glob</span></code> not <code class="docutils literal notranslate"><span class="pre">rglob</span></code> - chunks are in flat directory structure</p></li>
</ul>
</li>
<li><p>[ ] 1.8 Implement <code class="docutils literal notranslate"><span class="pre">jsonl_load(path:</span> <span class="pre">Path)</span> <span class="pre">-&gt;</span> <span class="pre">List[dict]</span></code> function</p>
<ul>
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">jsonl_load(path:</span> <span class="pre">Path,</span> <span class="pre">skip_invalid:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False,</span> <span class="pre">max_errors:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">10)</span> <span class="pre">-&gt;</span> <span class="pre">List[dict]</span></code></p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="n">line_num</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">skip_invalid</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_errors</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too many JSON errors in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">, stopping&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> at line </span><span class="si">{</span><span class="n">line_num</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2"> invalid JSON lines in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">return</span> <span class="n">rows</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 1.9 Implement <code class="docutils literal notranslate"><span class="pre">jsonl_save(path:</span> <span class="pre">Path,</span> <span class="pre">rows:</span> <span class="pre">List[dict])</span></code> with atomic writes</p>
<ul>
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">jsonl_save(path:</span> <span class="pre">Path,</span> <span class="pre">rows:</span> <span class="pre">List[dict],</span> <span class="pre">validate:</span> <span class="pre">Optional[Callable[[dict],</span> <span class="pre">None]]</span> <span class="pre">=</span> <span class="pre">None)</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code></p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tmp</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">tmp</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">validate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">validate</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation failed for row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
    <span class="n">tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">tmp</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">raise</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 1.10 Implement <code class="docutils literal notranslate"><span class="pre">get_logger(name:</span> <span class="pre">str)</span> <span class="pre">-&gt;</span> <span class="pre">logging.Logger</span></code> with JSON formatting</p>
<ul>
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">get_logger(name:</span> <span class="pre">str,</span> <span class="pre">level:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">&quot;INFO&quot;)</span> <span class="pre">-&gt;</span> <span class="pre">logging.Logger</span></code></p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="c1"># Custom formatter for structured JSON logs</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">JSONFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
            <span class="n">log_obj</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatTime</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">),</span>
                <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span>
                <span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">getMessage</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;extra_fields&quot;</span><span class="p">):</span>
                <span class="n">log_obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">extra_fields</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">log_obj</span><span class="p">)</span>

    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">JSONFormatter</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">level</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">return</span> <span class="n">logger</span>
</pre></div>
</div>
</li>
<li><p><strong>Usage</strong>: <code class="docutils literal notranslate"><span class="pre">logger.info(&quot;Processing&quot;,</span> <span class="pre">extra={&quot;extra_fields&quot;:</span> <span class="pre">{&quot;doc_id&quot;:</span> <span class="pre">&quot;abc&quot;,</span> <span class="pre">&quot;stage&quot;:</span> <span class="pre">&quot;chunking&quot;}})</span></code></p></li>
</ul>
</li>
<li><p>[ ] 1.11 Implement <code class="docutils literal notranslate"><span class="pre">Batcher</span></code> class for streaming batch processing</p>
<ul>
<li><p><strong>Full Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Batcher</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield fixed-size batches from an iterable.</span>

<span class="sd">    Args:</span>
<span class="sd">        iterable: Source sequence to batch</span>
<span class="sd">        batch_size: Maximum items per batch</span>

<span class="sd">    Yields:</span>
<span class="sd">        Lists of up to batch_size items</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; list(Batcher([1,2,3,4,5], 2))</span>
<span class="sd">        [[1,2], [3,4], [5]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;batch_size must be &gt;= 1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterable</span> <span class="o">=</span> <span class="n">iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">T</span><span class="p">]]:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterable</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">batch</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">batch</span><span class="p">:</span>  <span class="c1"># Yield remaining partial batch</span>
            <span class="k">yield</span> <span class="n">batch</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 1.12 Implement <code class="docutils literal notranslate"><span class="pre">manifest_append(stage,</span> <span class="pre">doc_id,</span> <span class="pre">status,</span> <span class="pre">**metadata)</span></code> function</p>
<ul>
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">manifest_append(stage:</span> <span class="pre">str,</span> <span class="pre">doc_id:</span> <span class="pre">str,</span> <span class="pre">status:</span> <span class="pre">str,</span> <span class="pre">duration_s:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">0.0,</span> <span class="pre">warnings:</span> <span class="pre">Optional[List[str]]</span> <span class="pre">=</span> <span class="pre">None,</span> <span class="pre">error:</span> <span class="pre">Optional[str]</span> <span class="pre">=</span> <span class="pre">None,</span> <span class="pre">schema_version:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">&quot;&quot;,</span> <span class="pre">**metadata)</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code></p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>

<span class="n">manifest_path</span> <span class="o">=</span> <span class="n">data_manifests</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;docparse.manifest.jsonl&quot;</span>
<span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="p">,</span>
    <span class="s2">&quot;doc_id&quot;</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>  <span class="c1"># Must be one of: &quot;success&quot;, &quot;failure&quot;, &quot;skip&quot;</span>
    <span class="s2">&quot;duration_s&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration_s</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="n">warnings</span> <span class="ow">or</span> <span class="p">[],</span>
    <span class="s2">&quot;schema_version&quot;</span><span class="p">:</span> <span class="n">schema_version</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">if</span> <span class="n">error</span><span class="p">:</span>
    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="n">entry</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

<span class="c1"># Atomic append (POSIX guarantees atomicity for appends &lt; PIPE_BUF)</span>
<span class="k">with</span> <span class="n">manifest_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Validation</strong>: <code class="docutils literal notranslate"><span class="pre">status</span></code> must be in <code class="docutils literal notranslate"><span class="pre">[&quot;success&quot;,</span> <span class="pre">&quot;failure&quot;,</span> <span class="pre">&quot;skip&quot;]</span></code> - raise ValueError otherwise</p></li>
</ul>
</li>
<li><p>[ ] 1.13 Add <code class="docutils literal notranslate"><span class="pre">compute_content_hash(path:</span> <span class="pre">Path)</span> <span class="pre">-&gt;</span> <span class="pre">str</span></code> function</p>
<ul>
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">compute_content_hash(path:</span> <span class="pre">Path,</span> <span class="pre">algorithm:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">&quot;sha1&quot;)</span> <span class="pre">-&gt;</span> <span class="pre">str</span></code></p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">while</span> <span class="n">chunk</span> <span class="o">:=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">65536</span><span class="p">):</span>  <span class="c1"># 64KB chunks</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
<span class="k">return</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 1.14 Add <code class="docutils literal notranslate"><span class="pre">acquire_lock(path:</span> <span class="pre">Path,</span> <span class="pre">timeout:</span> <span class="pre">float)</span> <span class="pre">-&gt;</span> <span class="pre">ContextManager[bool]</span></code> function</p>
<ul>
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">&#64;contextlib.contextmanager</span> <span class="pre">def</span> <span class="pre">acquire_lock(path:</span> <span class="pre">Path,</span> <span class="pre">timeout:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">60.0)</span> <span class="pre">-&gt;</span> <span class="pre">Iterator[bool]</span></code></p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="n">lock_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">while</span> <span class="n">lock_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not acquire lock on </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Write PID to lock file for debugging</span>
    <span class="n">lock_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
    <span class="k">yield</span> <span class="kc">True</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">lock_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 1.15 Add comprehensive docstrings following Google style</p>
<ul>
<li><p>Each function requires: Summary line, blank line, Args section, Returns section, Raises section (if applicable), Examples section</p></li>
<li><p>Example template:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">detect_data_root</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Locate the DocsToKG Data directory via env var or ancestor scan.</span>

<span class="sd">    Checks DOCSTOKG_DATA_ROOT environment variable first. If not set,</span>
<span class="sd">    scans ancestor directories for a &#39;Data&#39; folder containing expected</span>
<span class="sd">    subdirectories (PDFs, HTML, DocTagsFiles, etc.).</span>

<span class="sd">    Args:</span>
<span class="sd">        start: Starting directory for ancestor scan. Defaults to current</span>
<span class="sd">            working directory if None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Absolute path to the Data directory.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If DOCSTOKG_DATA_ROOT points to non-existent path.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; os.environ[&quot;DOCSTOKG_DATA_ROOT&quot;] = &quot;/custom/path&quot;</span>
<span class="sd">        &gt;&gt;&gt; detect_data_root()</span>
<span class="sd">        PosixPath(&#39;/custom/path&#39;)</span>

<span class="sd">        &gt;&gt;&gt; del os.environ[&quot;DOCSTOKG_DATA_ROOT&quot;]</span>
<span class="sd">        &gt;&gt;&gt; detect_data_root(Path(&quot;/home/user/DocsToKG/src&quot;))</span>
<span class="sd">        PosixPath(&#39;/home/user/DocsToKG/Data&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">pydocstyle</span> <span class="pre">_common.py</span> <span class="pre">--convention=google</span></code> to validate</p></li>
</ul>
</li>
<li><p>[ ] 1.16 Add unit tests for all utilities in <code class="docutils literal notranslate"><span class="pre">tests/test_docparsing_common.py</span></code></p>
<ul class="simple">
<li><p>Test <code class="docutils literal notranslate"><span class="pre">detect_data_root</span></code>: with env var, without env var, from different starting points</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">find_free_port</span></code>: basic case, all ports busy scenario</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">atomic_write</span></code>: successful write, write with exception (ensure cleanup)</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">jsonl_load</span></code>: valid file, file with invalid lines (skip_invalid=True/False), empty file</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">jsonl_save</span></code>: basic save, save with validation function that raises</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">Batcher</span></code>: even division, remainder batch, empty iterable, single item</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">compute_content_hash</span></code>: verify sha1 matches known hash for test file</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">acquire_lock</span></code>: successful acquire/release, timeout scenario</p></li>
<li><p>Minimum coverage target: 90% for _common.py</p></li>
</ul>
</li>
</ul>
</section>
<section id="schema-validation-layer">
<h2>2. Schema Validation Layer<a class="headerlink" href="#schema-validation-layer" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 2.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/DocParsing/schemas.py</span></code> module</p>
<ul class="simple">
<li><p>Import: <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">pydantic</span> <span class="pre">import</span> <span class="pre">BaseModel,</span> <span class="pre">Field,</span> <span class="pre">validator,</span> <span class="pre">root_validator</span></code></p></li>
<li><p>Import: <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">typing</span> <span class="pre">import</span> <span class="pre">List,</span> <span class="pre">Optional,</span> <span class="pre">Dict,</span> <span class="pre">Any</span></code></p></li>
<li><p>Add module docstring: “Pydantic schemas for DocParsing JSONL outputs with validation”</p></li>
</ul>
</li>
<li><p>[ ] 2.2 Define <code class="docutils literal notranslate"><span class="pre">ChunkRow</span></code> Pydantic model</p>
<ul>
<li><p><strong>Full Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ChunkRow</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for chunk JSONL rows.&quot;&quot;&quot;</span>
    <span class="n">doc_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Document identifier&quot;</span><span class="p">)</span>
    <span class="n">source_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Path to source DocTags file&quot;</span><span class="p">)</span>
    <span class="n">chunk_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sequential chunk index within document&quot;</span><span class="p">)</span>
    <span class="n">source_chunk_idxs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Original chunk indices before coalescence&quot;</span><span class="p">)</span>
    <span class="n">num_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Token count (must be positive)&quot;</span><span class="p">)</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Chunk text content&quot;</span><span class="p">)</span>
    <span class="n">doc_items_refs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Document item references&quot;</span><span class="p">)</span>
    <span class="n">page_nos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Page numbers&quot;</span><span class="p">)</span>
    <span class="n">schema_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;docparse/1.1.0&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Schema version identifier&quot;</span><span class="p">)</span>
    <span class="n">provenance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;ProvenanceMetadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional provenance metadata&quot;</span><span class="p">)</span>
    <span class="n">uuid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional UUID for chunk&quot;</span><span class="p">)</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;num_tokens&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_num_tokens</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_tokens must be positive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>  <span class="c1"># Sanity check</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_tokens exceeds reasonable limit (100k)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;page_nos&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_page_nos</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All page numbers must be positive&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>  <span class="c1"># Deduplicate and sort</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;forbid&quot;</span>  <span class="c1"># Reject unknown fields</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.3 Define <code class="docutils literal notranslate"><span class="pre">VectorRow</span></code> Pydantic model</p>
<ul>
<li><p><strong>Full Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">VectorRow</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for vector JSONL rows.&quot;&quot;&quot;</span>
    <span class="n">UUID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Chunk UUID (must match chunk file)&quot;</span><span class="p">)</span>
    <span class="n">BM25</span><span class="p">:</span> <span class="s1">&#39;BM25Vector&#39;</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;BM25 sparse vector&quot;</span><span class="p">)</span>
    <span class="n">SPLADEv3</span><span class="p">:</span> <span class="s1">&#39;SPLADEVector&#39;</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SPLADE-v3 sparse vector&quot;</span><span class="p">)</span>
    <span class="c1"># Use dict key that matches output (with hyphen):</span>
    <span class="n">Qwen3_4B</span><span class="p">:</span> <span class="s1">&#39;DenseVector&#39;</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;Qwen3-4B&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Qwen3-4B dense vector&quot;</span><span class="p">)</span>
    <span class="n">model_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">schema_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;embeddings/1.0.0&quot;</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
        <span class="n">allow_population_by_field_name</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Allow both &quot;Qwen3_4B&quot; and &quot;Qwen3-4B&quot;</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;forbid&quot;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.4 Define <code class="docutils literal notranslate"><span class="pre">BM25Vector</span></code> nested model</p>
<ul>
<li><p><strong>Full Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BM25Vector</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;BM25 sparse vector representation.&quot;&quot;&quot;</span>
    <span class="n">terms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Token terms&quot;</span><span class="p">)</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;BM25 weights for each term&quot;</span><span class="p">)</span>
    <span class="n">k1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;BM25 k1 parameter&quot;</span><span class="p">)</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;BM25 b parameter&quot;</span><span class="p">)</span>
    <span class="n">avgdl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Average document length in corpus&quot;</span><span class="p">)</span>
    <span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Total documents in corpus&quot;</span><span class="p">)</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_parallel_lists</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">terms</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;terms&#39;</span><span class="p">),</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weights&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">terms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;terms and weights must have same length&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.5 Define <code class="docutils literal notranslate"><span class="pre">SPLADEVector</span></code> nested model</p>
<ul>
<li><p><strong>Full Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SPLADEVector</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SPLADE-v3 sparse vector representation.&quot;&quot;&quot;</span>
    <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;naver/splade-v3&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SPLADE model identifier&quot;</span><span class="p">)</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SPLADE token vocabulary&quot;</span><span class="p">)</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SPLADE activation weights&quot;</span><span class="p">)</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_parallel_lists</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tokens&#39;</span><span class="p">),</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weights&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tokens and weights must have same length&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SPLADE weights must be non-negative&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.6 Define <code class="docutils literal notranslate"><span class="pre">DenseVector</span></code> nested model</p>
<ul>
<li><p><strong>Full Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DenseVector</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dense embedding vector representation.&quot;&quot;&quot;</span>
    <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Embedding model identifier&quot;</span><span class="p">)</span>
    <span class="n">vector</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Dense embedding vector&quot;</span><span class="p">)</span>
    <span class="n">dimension</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Expected vector dimension&quot;</span><span class="p">)</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;vector&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_vector</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;vector cannot be empty&quot;</span><span class="p">)</span>
        <span class="n">expected_dim</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expected_dim</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_dim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vector dimension </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2"> != expected </span><span class="si">{</span><span class="n">expected_dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.7 Define <code class="docutils literal notranslate"><span class="pre">ProvenanceMetadata</span></code> model</p>
<ul>
<li><p><strong>Full Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProvenanceMetadata</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provenance metadata for chunks.&quot;&quot;&quot;</span>
    <span class="n">parse_engine</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parser used: &#39;docling-html&#39; or &#39;docling-vlm&#39;&quot;</span><span class="p">)</span>
    <span class="n">docling_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Docling package version&quot;</span><span class="p">)</span>
    <span class="n">has_image_captions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether chunk includes image captions&quot;</span><span class="p">)</span>
    <span class="n">has_image_classification</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether chunk includes image classifications&quot;</span><span class="p">)</span>
    <span class="n">num_images</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of images in chunk&quot;</span><span class="p">)</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;parse_engine&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_parse_engine</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;docling-html&quot;</span><span class="p">,</span> <span class="s2">&quot;docling-vlm&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid parse_engine: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.8 Add schema version constants</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Schema version constants</span>
<span class="n">CHUNK_SCHEMA_VERSION</span> <span class="o">=</span> <span class="s2">&quot;docparse/1.1.0&quot;</span>
<span class="n">VECTOR_SCHEMA_VERSION</span> <span class="o">=</span> <span class="s2">&quot;embeddings/1.0.0&quot;</span>

<span class="c1"># Version compatibility matrix (for future migrations)</span>
<span class="n">COMPATIBLE_CHUNK_VERSIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;docparse/1.0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;docparse/1.1.0&quot;</span><span class="p">]</span>
<span class="n">COMPATIBLE_VECTOR_VERSIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;embeddings/1.0.0&quot;</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.9 Implement validation helper: <code class="docutils literal notranslate"><span class="pre">validate_chunk_row(row:</span> <span class="pre">dict)</span> <span class="pre">-&gt;</span> <span class="pre">ChunkRow</span></code></p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">validate_chunk_row</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChunkRow</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate and parse a chunk JSONL row.</span>

<span class="sd">    Args:</span>
<span class="sd">        row: Raw dictionary from JSONL</span>

<span class="sd">    Returns:</span>
<span class="sd">        Validated ChunkRow instance</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValidationError: If row doesn&#39;t match schema</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; row = {&quot;doc_id&quot;: &quot;test&quot;, &quot;chunk_id&quot;: 0, ...}</span>
<span class="sd">        &gt;&gt;&gt; validated = validate_chunk_row(row)</span>
<span class="sd">        &gt;&gt;&gt; assert validated.doc_id == &quot;test&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ChunkRow</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Enhance error message with row context</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chunk row validation failed for doc_id=</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.10 Implement validation helper: <code class="docutils literal notranslate"><span class="pre">validate_vector_row(row:</span> <span class="pre">dict)</span> <span class="pre">-&gt;</span> <span class="pre">VectorRow</span></code></p>
<ul class="simple">
<li><p><strong>Implementation</strong>: Similar to validate_chunk_row but for VectorRow</p></li>
<li><p>Add special handling for UUID-based error messages</p></li>
</ul>
</li>
<li><p>[ ] 2.11 Add <code class="docutils literal notranslate"><span class="pre">get_docling_version()</span> <span class="pre">-&gt;</span> <span class="pre">str</span></code> utility function</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_docling_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect installed docling package version.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">docling</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">docling</span><span class="p">,</span> <span class="s2">&quot;__version__&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.12 Add backward compatibility validator</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">validate_schema_version</span><span class="p">(</span><span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">compatible_versions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if schema version is compatible.</span>

<span class="sd">    Args:</span>
<span class="sd">        version: Schema version string from JSONL row</span>
<span class="sd">        compatible_versions: List of versions this code can handle</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if compatible, False otherwise</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; validate_schema_version(&quot;docparse/1.1.0&quot;, COMPATIBLE_CHUNK_VERSIONS)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">compatible_versions</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 2.13 Add unit tests in <code class="docutils literal notranslate"><span class="pre">tests/test_docparsing_schemas.py</span></code></p>
<ul class="simple">
<li><p>Test ChunkRow: valid row, missing required field, invalid num_tokens (negative, zero, excessive)</p></li>
<li><p>Test VectorRow: valid row, mismatched term/weight lengths</p></li>
<li><p>Test ProvenanceMetadata: valid engines, invalid engine string</p></li>
<li><p>Test BM25Vector: parallel list length mismatch</p></li>
<li><p>Test SPLADEVector: negative weights rejection</p></li>
<li><p>Test DenseVector: dimension validation</p></li>
<li><p>Test validation helpers with malformed input</p></li>
<li><p>Minimum coverage: 95% for schemas.py</p></li>
</ul>
</li>
</ul>
</section>
<section id="serializers-extraction">
<h2>3. Serializers Extraction<a class="headerlink" href="#serializers-extraction" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 3.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/DocParsing/serializers.py</span></code> module</p>
<ul class="simple">
<li><p>Import required classes from docling-core</p></li>
<li><p>Add module docstring describing purpose</p></li>
</ul>
</li>
<li><p>[ ] 3.2 Move <code class="docutils literal notranslate"><span class="pre">CaptionPlusAnnotationPictureSerializer</span></code> to serializers module</p>
<ul class="simple">
<li><p><strong>Implementation</strong>: Copy exactly from <code class="docutils literal notranslate"><span class="pre">DoclingHybridChunkerPipelineWithMin.py</span></code> lines 53-99</p></li>
<li><p>Preserve all imports needed: <code class="docutils literal notranslate"><span class="pre">PictureItem</span></code>, <code class="docutils literal notranslate"><span class="pre">PictureDescriptionData</span></code>, etc.</p></li>
<li><p>Add comprehensive docstring with example usage</p></li>
</ul>
</li>
<li><p>[ ] 3.3 Move <code class="docutils literal notranslate"><span class="pre">RichSerializerProvider</span></code> to serializers module</p>
<ul class="simple">
<li><p><strong>Implementation</strong>: Copy from chunker script lines 102-128</p></li>
<li><p>Add docstring explaining when to use this provider vs default</p></li>
</ul>
</li>
<li><p>[ ] 3.4 Add example usage in module docstring</p>
<ul>
<li><p><strong>Documentation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Picture and table serializers for DocParsing pipeline.</span>

<span class="sd">These serializers extract rich metadata from Docling documents including</span>
<span class="sd">image captions, classifications, and SMILES molecular structures.</span>

<span class="sd">Example Usage:</span>
<span class="sd">    from DocsToKG.DocParsing.serializers import RichSerializerProvider</span>

<span class="sd">    chunker = HybridChunker(</span>
<span class="sd">        tokenizer=tokenizer,</span>
<span class="sd">        serializer_provider=RichSerializerProvider()</span>
<span class="sd">    )</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 3.5 Update imports in <code class="docutils literal notranslate"><span class="pre">DoclingHybridChunkerPipelineWithMin.py</span></code></p>
<ul class="simple">
<li><p>Replace local class definitions with: <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">DocsToKG.DocParsing.serializers</span> <span class="pre">import</span> <span class="pre">CaptionPlusAnnotationPictureSerializer,</span> <span class="pre">RichSerializerProvider</span></code></p></li>
<li><p>Remove original class definitions (lines 53-128)</p></li>
<li><p>Verify script still runs with <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">DoclingHybridChunkerPipelineWithMin.py</span> <span class="pre">--help</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="path-handling-refactoring">
<h2>4. Path Handling Refactoring<a class="headerlink" href="#path-handling-refactoring" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 4.1 Update <code class="docutils literal notranslate"><span class="pre">DoclingHybridChunkerPipelineWithMin.py</span></code> imports</p>
<ul class="simple">
<li><p>Add: <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">DocsToKG.DocParsing._common</span> <span class="pre">import</span> <span class="pre">detect_data_root,</span> <span class="pre">data_doctags,</span> <span class="pre">data_chunks</span></code></p></li>
<li><p>Remove local path discovery code</p></li>
</ul>
</li>
<li><p>[ ] 4.2 Replace DEFAULT_IN_DIR and DEFAULT_OUT_DIR</p>
<ul>
<li><p><strong>Before</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DEFAULT_IN_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/paul/DocsToKG/Data/DocTagsFiles&quot;</span><span class="p">)</span>
<span class="n">DEFAULT_OUT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/paul/DocsToKG/Data/ChunkedDocTagFiles&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>After</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dynamic defaults using shared utilities</span>
<span class="n">DEFAULT_IN_DIR</span> <span class="o">=</span> <span class="n">data_doctags</span><span class="p">()</span>
<span class="n">DEFAULT_OUT_DIR</span> <span class="o">=</span> <span class="n">data_chunks</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 4.3 Update <code class="docutils literal notranslate"><span class="pre">run_docling_html_to_doctags_parallel.py</span></code></p>
<ul class="simple">
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">detect_data_root</span></code> function (lines 52-65) with import: <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">DocsToKG.DocParsing._common</span> <span class="pre">import</span> <span class="pre">detect_data_root</span></code></p></li>
<li><p>Update all references to use imported version</p></li>
</ul>
</li>
<li><p>[ ] 4.4 Update <code class="docutils literal notranslate"><span class="pre">run_docling_parallel_with_vllm_debug.py</span></code></p>
<ul class="simple">
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">find_data_root</span></code> function (lines 28-45) with import</p></li>
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">find_free_port</span></code> function (lines 163-178) with import from <code class="docutils literal notranslate"><span class="pre">_common</span></code></p></li>
<li><p>Update DEFAULT_INPUT and DEFAULT_OUTPUT to use <code class="docutils literal notranslate"><span class="pre">data_pdfs()</span></code> and <code class="docutils literal notranslate"><span class="pre">data_doctags()</span></code></p></li>
</ul>
</li>
<li><p>[ ] 4.5 Update <code class="docutils literal notranslate"><span class="pre">EmbeddingV2.py</span></code> to remove hardcoded paths</p>
<ul>
<li><p><strong>Before</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CHUNKS_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/paul/DocsToKG/Data/ChunkedDocTagFiles&quot;</span><span class="p">)</span>
<span class="n">VECTORS_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/paul/DocsToKG/Data/Vectors&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>After</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.DocParsing._common</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_chunks</span><span class="p">,</span> <span class="n">data_vectors</span>
<span class="n">DEFAULT_CHUNKS_DIR</span> <span class="o">=</span> <span class="n">data_chunks</span><span class="p">()</span>
<span class="n">DEFAULT_VECTORS_DIR</span> <span class="o">=</span> <span class="n">data_vectors</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Update argparse defaults to use these</p></li>
</ul>
</li>
<li><p>[ ] 4.6 Add –data-root CLI flag to all scripts</p>
<ul>
<li><p><strong>Implementation for each script</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s2">&quot;--data-root&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Override Data directory location (default: auto-detect or $DOCSTOKG_DATA_ROOT)&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Pass this value to path resolution functions: <code class="docutils literal notranslate"><span class="pre">data_chunks(args.data_root)</span></code></p></li>
</ul>
</li>
<li><p>[ ] 4.7 Validate path refactoring with integration test</p>
<ul class="simple">
<li><p>Create test script that:</p>
<ol class="arabic simple">
<li><p>Sets DOCSTOKG_DATA_ROOT to temp directory</p></li>
<li><p>Runs each script with –help to verify imports work</p></li>
<li><p>Verifies expected directories are created</p></li>
</ol>
</li>
<li><p>Test must pass before marking section complete</p></li>
</ul>
</li>
</ul>
</section>
<section id="cuda-safety-for-multiprocessing">
<h2>5. CUDA Safety for Multiprocessing<a class="headerlink" href="#cuda-safety-for-multiprocessing" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 5.1 Add spawn mode enforcement to <code class="docutils literal notranslate"><span class="pre">run_docling_parallel_with_vllm_debug.py</span></code></p>
<ul>
<li><p><strong>Location</strong>: At the very beginning of <code class="docutils literal notranslate"><span class="pre">main()</span></code> function (before line 449)</p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entrypoint that coordinates vLLM setup and parallel DocTags conversion.&quot;&quot;&quot;</span>
    <span class="c1"># CRITICAL: Set spawn mode BEFORE any CUDA operations to prevent</span>
    <span class="c1"># &quot;Cannot re-initialize CUDA in forked subprocess&quot; errors</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Multiprocessing start method set to &#39;spawn&#39; for CUDA safety&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Already set (e.g., by parent process)</span>
        <span class="n">current_method</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_start_method</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_method</span> <span class="o">!=</span> <span class="s1">&#39;spawn&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not force spawn mode; current method is &#39;</span><span class="si">{</span><span class="n">current_method</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;CUDA operations in workers may fail.&quot;</span><span class="p">)</span>

    <span class="c1"># ... rest of main() ...</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 5.2 Verify HTML script already has spawn mode</p>
<ul class="simple">
<li><p>Check <code class="docutils literal notranslate"><span class="pre">run_docling_html_to_doctags_parallel.py</span></code> line 133-136</p></li>
<li><p>Ensure try-except wrapper is present</p></li>
<li><p>Confirm it sets spawn mode</p></li>
</ul>
</li>
<li><p>[ ] 5.3 Add diagnostic logging</p>
<ul class="simple">
<li><p>After spawn mode is set, log: <code class="docutils literal notranslate"><span class="pre">logger.info(f&quot;Multiprocessing</span> <span class="pre">method:</span> <span class="pre">{mp.get_start_method()},</span> <span class="pre">CPU</span> <span class="pre">count:</span> <span class="pre">{os.cpu_count()}&quot;)</span></code></p></li>
</ul>
</li>
<li><p>[ ] 5.4 Add unit test for spawn verification</p>
<ul class="simple">
<li><p>Create <code class="docutils literal notranslate"><span class="pre">tests/test_cuda_safety.py</span></code></p></li>
<li><p>Test: Import PDF script module, verify get_start_method() returns ‘spawn’ after initialization</p></li>
<li><p>Test: Mock CUDA operations in worker and verify no “re-initialize” error</p></li>
</ul>
</li>
</ul>
</section>
<section id="streaming-embeddings-architecture">
<h2>6. Streaming Embeddings Architecture<a class="headerlink" href="#streaming-embeddings-architecture" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 6.1 Refactor <code class="docutils literal notranslate"><span class="pre">EmbeddingV2.py</span></code> main() into two-pass architecture</p>
<ul>
<li><p><strong>High-level structure</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iter_chunk_files</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">chunks_dir</span><span class="p">))</span>

    <span class="c1"># PASS A: UUID assignment + BM25 statistics</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[Pass A] Assigning UUIDs and collecting BM25 statistics...&quot;</span><span class="p">)</span>
    <span class="n">all_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Pass A&quot;</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">jsonl_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">ensure_uuid</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">jsonl_save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>  <span class="c1"># Save updated UUIDs</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">all_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chunk</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]))</span>

    <span class="n">stats</span> <span class="o">=</span> <span class="n">build_bm25_stats</span><span class="p">(</span><span class="n">all_chunks</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BM25 statistics: N=</span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">N</span><span class="si">}</span><span class="s2">, avgdl=</span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">avgdl</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_bm25_summary</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>  <span class="c1"># New function to print top tokens</span>

    <span class="c1"># PASS B: Encode and write vectors file-by-file</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[Pass B] Encoding vectors in batches...&quot;</span><span class="p">)</span>
    <span class="n">uuid_to_chunk</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_chunks</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">chunk_file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Pass B&quot;</span><span class="p">):</span>
        <span class="n">process_chunk_file_vectors</span><span class="p">(</span>
            <span class="n">chunk_file</span><span class="o">=</span><span class="n">chunk_file</span><span class="p">,</span>
            <span class="n">uuid_to_chunk</span><span class="o">=</span><span class="n">uuid_to_chunk</span><span class="p">,</span>
            <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Embedding complete&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 6.2 Implement Pass A: UUID assignment + statistics</p>
<ul class="simple">
<li><p><strong>Function</strong>: <code class="docutils literal notranslate"><span class="pre">process_pass_a(files:</span> <span class="pre">List[Path])</span> <span class="pre">-&gt;</span> <span class="pre">Tuple[List[Chunk],</span> <span class="pre">BM25Stats]</span></code></p></li>
<li><p>Must NOT retain full text in memory after processing each file</p></li>
<li><p>Only accumulate document frequency Counter and total tokens</p></li>
<li><p>Return list of Chunk objects (uuid, text) for Pass B</p></li>
</ul>
</li>
<li><p>[ ] 6.3 Implement streaming document frequency accumulator</p>
<ul>
<li><p><strong>Refactor <code class="docutils literal notranslate"><span class="pre">build_bm25_stats</span></code> to be streaming</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BM25StatsAccumulator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Streaming accumulator for BM25 corpus statistics.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_tokens</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add document to statistics without retaining text.&quot;&quot;&quot;</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">toks</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BM25Stats</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute final statistics.&quot;&quot;&quot;</span>
        <span class="n">avgdl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_tokens</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BM25Stats</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">avgdl</span><span class="o">=</span><span class="n">avgdl</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">))</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 6.4 Implement Pass B: batch encoding with sharding</p>
<ul>
<li><p><strong>Function signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">process_chunk_file_vectors(chunk_file:</span> <span class="pre">Path,</span> <span class="pre">uuid_to_chunk:</span> <span class="pre">Dict[str,</span> <span class="pre">Chunk],</span> <span class="pre">stats:</span> <span class="pre">BM25Stats,</span> <span class="pre">args:</span> <span class="pre">Namespace)</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code></p></li>
<li><p><strong>Logic</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">jsonl_load</span><span class="p">(</span><span class="n">chunk_file</span><span class="p">)</span>
<span class="n">uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
<span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">uuid_to_chunk</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">uuids</span><span class="p">]</span>

<span class="c1"># Encode in batches</span>
<span class="n">splade_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">Batcher</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size_splade</span><span class="p">):</span>
    <span class="n">splade_tokens</span><span class="p">,</span> <span class="n">splade_weights</span> <span class="o">=</span> <span class="n">splade_encode</span><span class="p">(</span><span class="n">spl_cfg</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
    <span class="n">splade_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">splade_tokens</span><span class="p">,</span> <span class="n">splade_weights</span><span class="p">))</span>

<span class="n">qwen_results</span> <span class="o">=</span> <span class="n">qwen_embed</span><span class="p">(</span><span class="n">qwen_cfg</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size_qwen</span><span class="p">)</span>

<span class="c1"># Write vectors for this chunk file</span>
<span class="n">out_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chunk_file</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.chunks&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.vectors.jsonl&quot;</span>
<span class="n">write_vectors</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">uuids</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">splade_results</span><span class="p">,</span> <span class="n">qwen_results</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 6.5 Add CLI arguments for batch sizes</p>
<ul class="simple">
<li><p>Add to argparse: <code class="docutils literal notranslate"><span class="pre">--batch-size-splade</span></code> (default: 32)</p></li>
<li><p>Add to argparse: <code class="docutils literal notranslate"><span class="pre">--batch-size-qwen</span></code> (default: 64)</p></li>
<li><p>Add validation: batch size must be &gt;= 1</p></li>
</ul>
</li>
<li><p>[ ] 6.6 Implement <code class="docutils literal notranslate"><span class="pre">write_vectors</span></code> function with validation</p>
<ul class="simple">
<li><p><strong>Signature</strong>: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">write_vectors(path:</span> <span class="pre">Path,</span> <span class="pre">uuids:</span> <span class="pre">List[str],</span> <span class="pre">texts:</span> <span class="pre">List[str],</span> <span class="pre">splade_results,</span> <span class="pre">qwen_results,</span> <span class="pre">stats:</span> <span class="pre">BM25Stats,</span> <span class="pre">args)</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code></p></li>
<li><p>For each (uuid, text, splade, qwen):</p>
<ol class="arabic simple">
<li><p>Compute BM25 vector</p></li>
<li><p>Validate Qwen dimension (assert len == 2560)</p></li>
<li><p>Validate Qwen L2 norm &gt; 0</p></li>
<li><p>Validate SPLADE nnz &gt; 0 (collect warnings if not)</p></li>
<li><p>Construct VectorRow dict</p></li>
<li><p>Validate with schema</p></li>
<li><p>Write JSONL line</p></li>
</ol>
</li>
<li><p>Use atomic write with .tmp suffix</p></li>
</ul>
</li>
<li><p>[ ] 6.7 Add BM25 corpus summary function</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">print_bm25_summary</span><span class="p">(</span><span class="n">stats</span><span class="p">:</span> <span class="n">BM25Stats</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print corpus-level BM25 statistics.&quot;&quot;&quot;</span>
    <span class="n">top_tokens</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BM25 Corpus Summary:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Documents (N): </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">N</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Avg doc length: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">avgdl</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> tokens&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unique terms: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Top 10 terms: </span><span class="si">{</span><span class="n">top_tokens</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 6.8 Add progress tracking with tqdm</p>
<ul class="simple">
<li><p>Pass A: <code class="docutils literal notranslate"><span class="pre">tqdm(files,</span> <span class="pre">desc=&quot;Pass</span> <span class="pre">A:</span> <span class="pre">UUID</span> <span class="pre">+</span> <span class="pre">BM25</span> <span class="pre">stats&quot;,</span> <span class="pre">unit=&quot;file&quot;)</span></code></p></li>
<li><p>Pass B: <code class="docutils literal notranslate"><span class="pre">tqdm(files,</span> <span class="pre">desc=&quot;Pass</span> <span class="pre">B:</span> <span class="pre">Encoding</span> <span class="pre">vectors&quot;,</span> <span class="pre">unit=&quot;file&quot;)</span></code></p></li>
</ul>
</li>
<li><p>[ ] 6.9 Refactor SPLADE and Qwen functions to accept batch_size</p>
<ul class="simple">
<li><p>Update <code class="docutils literal notranslate"><span class="pre">splade_encode</span></code> signature: <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">splade_encode(cfg:</span> <span class="pre">SpladeCfg,</span> <span class="pre">texts:</span> <span class="pre">List[str],</span> <span class="pre">batch_size:</span> <span class="pre">Optional[int]</span> <span class="pre">=</span> <span class="pre">None)</span> <span class="pre">-&gt;</span> <span class="pre">...</span></code></p></li>
<li><p>If batch_size provided, override cfg.batch_size</p></li>
<li><p>Similar for qwen_embed</p></li>
</ul>
</li>
<li><p>[ ] 6.10 Add memory profiling instrumentation</p>
<ul class="simple">
<li><p>Import <code class="docutils literal notranslate"><span class="pre">tracemalloc</span></code> at start of Pass B</p></li>
<li><p>Log peak memory at end: <code class="docutils literal notranslate"><span class="pre">logger.info(f&quot;Peak</span> <span class="pre">memory:</span> <span class="pre">{tracemalloc.get_traced_memory()[1]</span> <span class="pre">/</span> <span class="pre">1024**3:.2f}</span> <span class="pre">GB&quot;)</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="embedding-validation-invariants">
<h2>7. Embedding Validation &amp; Invariants<a class="headerlink" href="#embedding-validation-invariants" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 7.1 Add Qwen dimension assertion</p>
<ul>
<li><p><strong>Location</strong>: In <code class="docutils literal notranslate"><span class="pre">write_vectors</span></code> function after qwen_embed returns</p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qwen_results</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2560</span><span class="p">:</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">uuids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Qwen dimension mismatch for UUID=</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;expected 2560, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 7.2 Add Qwen L2 norm validation</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qwen_results</span><span class="p">):</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">norm</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">uuids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Qwen L2 norm is zero for UUID=</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid Qwen vector (zero norm) for UUID=</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Normalized vectors should have norm ≈ 1.0</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">norm</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Qwen norm for UUID=</span><span class="si">{</span><span class="n">uuids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">norm</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (expected ~1.0)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 7.3 Add SPLADE nnz validation</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SPLADEValidator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_chunks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_nnz_chunks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_chunks</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">nnz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">nnz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_nnz_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_nnz_chunks</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_chunks</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pct</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SPLADE sparsity warning: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_nnz_chunks</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_chunks</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%) chunks have zero non-zero elements.&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Affected UUIDs (first 10): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_nnz_chunks</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Call validator.report() at end of Pass B</p></li>
</ul>
</li>
<li><p>[ ] 7.4 Add validation error logging to manifest</p>
<ul class="simple">
<li><p>Wrap validation in try-except</p></li>
<li><p>On ValidationError, call: <code class="docutils literal notranslate"><span class="pre">manifest_append(stage=&quot;embeddings&quot;,</span> <span class="pre">doc_id=doc_id,</span> <span class="pre">status=&quot;failure&quot;,</span> <span class="pre">error=str(e))</span></code></p></li>
</ul>
</li>
<li><p>[ ] 7.5 Add corpus-level embedding statistics</p>
<ul class="simple">
<li><p>At end of Pass B, compute and log:</p>
<ul>
<li><p>Total vectors generated</p></li>
<li><p>SPLADE: avg nnz, median nnz, % zero-vectors</p></li>
<li><p>Qwen: avg norm, std norm</p></li>
</ul>
</li>
<li><p>Save statistics to manifest as metadata</p></li>
</ul>
</li>
</ul>
</section>
<section id="tokenizer-alignment">
<h2>8. Tokenizer Alignment<a class="headerlink" href="#tokenizer-alignment" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 8.1 Add –tokenizer-model flag to chunking script</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s2">&quot;--tokenizer-model&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Qwen/Qwen3-Embedding-4B&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;HuggingFace tokenizer model (default: matches dense embedder)&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 8.2 Update tokenizer initialization</p>
<ul>
<li><p><strong>Before</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;bert-base-uncased&quot;</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>After</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tokenizer_model</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tokenizer_model</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading tokenizer: </span><span class="si">{</span><span class="n">tokenizer_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">hf</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">tokenizer_model</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 8.3 Add deprecation warning for BERT tokenizer</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;bert&quot;</span> <span class="ow">in</span> <span class="n">tokenizer_model</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s2">&quot;BERT tokenizer may not align with Qwen embedder. &quot;</span>
        <span class="s2">&quot;Consider using --tokenizer-model Qwen/Qwen3-Embedding-4B &quot;</span>
        <span class="s2">&quot;or run calibration: scripts/calibrate_tokenizers.py&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 8.4 Implement calibration script: <code class="docutils literal notranslate"><span class="pre">scripts/calibrate_tokenizers.py</span></code></p>
<ul>
<li><p><strong>Full Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;Calibrate tokenizer discrepancies between BERT and Qwen.</span>

<span class="sd">Computes token count statistics to recommend adjusted --min-tokens values.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statistics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoTokenizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.DocParsing._common</span><span class="w"> </span><span class="kn">import</span> <span class="n">iter_doctags</span><span class="p">,</span> <span class="n">get_logger</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--doctags-dir&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sample-size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="c1"># Load both tokenizers</span>
    <span class="n">bert_tok</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;bert-base-uncased&quot;</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">qwen_tok</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;Qwen/Qwen3-Embedding-4B&quot;</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Sample texts from DocTags</span>
    <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iter_doctags</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">doctags_dir</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">args</span><span class="o">.</span><span class="n">sample_size</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># Extract text from DocTags (simplified)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">[:</span><span class="mi">5000</span><span class="p">])</span>  <span class="c1"># First 5000 chars</span>

    <span class="c1"># Compute token counts</span>
    <span class="n">bert_counts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bert_tok</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
    <span class="n">qwen_counts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">qwen_tok</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>

    <span class="c1"># Calculate statistics</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bert_counts</span><span class="p">,</span> <span class="n">qwen_counts</span><span class="p">)]</span>
    <span class="n">mean_ratio</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span>
    <span class="n">std_ratio</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibration Results (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean token ratio (Qwen/BERT): </span><span class="si">{</span><span class="n">mean_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">std_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  BERT mean tokens: </span><span class="si">{</span><span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bert_counts</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Qwen mean tokens: </span><span class="si">{</span><span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">qwen_counts</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Recommendations</span>
    <span class="k">if</span> <span class="n">mean_ratio</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recommendation: Qwen tokenizer produces </span><span class="si">{</span><span class="p">(</span><span class="n">mean_ratio</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% more tokens.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Consider increasing --min-tokens by this factor.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mean_ratio</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recommendation: Qwen tokenizer produces </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mean_ratio</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% fewer tokens.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Consider decreasing --min-tokens by this factor.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tokenizers are well-aligned; no adjustment needed.&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 8.5 Document calibration usage in chunking script docstring</p>
<ul>
<li><p>Add section:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Tokenizer</span> <span class="n">Alignment</span><span class="p">:</span>
    <span class="n">The</span> <span class="n">default</span> <span class="n">tokenizer</span> <span class="p">(</span><span class="n">Qwen</span><span class="o">/</span><span class="n">Qwen3</span><span class="o">-</span><span class="n">Embedding</span><span class="o">-</span><span class="mi">4</span><span class="n">B</span><span class="p">)</span> <span class="n">matches</span> <span class="n">the</span> <span class="n">dense</span> <span class="n">embedder</span><span class="o">.</span>
    <span class="n">If</span> <span class="n">using</span> <span class="n">a</span> <span class="n">different</span> <span class="n">tokenizer</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">,</span> <span class="n">BERT</span><span class="p">),</span> <span class="n">run</span> <span class="n">calibration</span> <span class="n">first</span><span class="p">:</span>

        <span class="n">python</span> <span class="n">scripts</span><span class="o">/</span><span class="n">calibrate_tokenizers</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">doctags</span><span class="o">-</span><span class="nb">dir</span> <span class="n">Data</span><span class="o">/</span><span class="n">DocTagsFiles</span>

    <span class="n">This</span> <span class="n">will</span> <span class="n">report</span> <span class="n">the</span> <span class="n">token</span> <span class="n">count</span> <span class="n">ratio</span> <span class="ow">and</span> <span class="n">recommend</span> <span class="n">adjustments</span> <span class="n">to</span> <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">tokens</span><span class="o">.</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="topic-aware-coalescence">
<h2>9. Topic-Aware Coalescence<a class="headerlink" href="#topic-aware-coalescence" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 9.1 Add <code class="docutils literal notranslate"><span class="pre">is_structural_boundary(rec:</span> <span class="pre">Rec)</span> <span class="pre">-&gt;</span> <span class="pre">bool</span></code> helper</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">is_structural_boundary</span><span class="p">(</span><span class="n">rec</span><span class="p">:</span> <span class="n">Rec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect if chunk starts with a structural element (heading, caption).</span>

<span class="sd">    Args:</span>
<span class="sd">        rec: Chunk record to inspect</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if chunk starts with heading or caption marker</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; is_structural_boundary(Rec(text=&quot;# Introduction\n...&quot;, ...))</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; is_structural_boundary(Rec(text=&quot;Regular paragraph&quot;, ...))</span>
<span class="sd">        False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

    <span class="c1"># Markdown headings</span>
    <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Figure/table captions</span>
    <span class="n">caption_markers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Figure caption:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Table:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Picture description:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;!-- image --&gt;&quot;</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">caption_markers</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Place this function before <code class="docutils literal notranslate"><span class="pre">coalesce_small_runs()</span></code> in chunker script</p></li>
</ul>
</li>
<li><p>[ ] 9.2 Update <code class="docutils literal notranslate"><span class="pre">coalesce_small_runs()</span></code> to apply soft barrier rule</p>
<ul>
<li><p><strong>Location</strong>: In the inner loop where merging decision is made (around line 300)</p></li>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">e</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">n_tok</span> <span class="o">&lt;</span> <span class="n">min_tokens</span><span class="p">:</span>
    <span class="n">next_rec</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">combined_size</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">n_tok</span> <span class="o">+</span> <span class="n">next_rec</span><span class="o">.</span><span class="n">n_tok</span>

    <span class="c1"># Soft barrier: don&#39;t merge across boundaries if it would exceed (max_tokens - 64)</span>
    <span class="k">if</span> <span class="n">is_structural_boundary</span><span class="p">(</span><span class="n">next_rec</span><span class="p">)</span> <span class="ow">and</span> <span class="n">combined_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_tokens</span> <span class="o">-</span> <span class="mi">64</span><span class="p">):</span>
        <span class="k">break</span>  <span class="c1"># Stop merging at this boundary</span>

    <span class="k">if</span> <span class="n">combined_size</span> <span class="o">&lt;=</span> <span class="n">max_tokens</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">merge_rec</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">next_rec</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>  <span class="c1"># Would exceed max_tokens</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 9.3 Add unit test for boundary detection</p>
<ul class="simple">
<li><p><strong>Test cases</strong>:</p>
<ul>
<li><p>Markdown heading levels (# through ####)</p></li>
<li><p>Figure captions with various formats</p></li>
<li><p>Regular text (should return False)</p></li>
<li><p>Edge cases: empty text, whitespace-only, mixed markers</p></li>
</ul>
</li>
</ul>
</li>
<li><p>[ ] 9.4 Add integration test with sample documents</p>
<ul class="simple">
<li><p>Create <code class="docutils literal notranslate"><span class="pre">tests/data/docparsing/topic_aware_sample.doctags</span></code> with clear section boundaries</p></li>
<li><p>Run chunker with topic-aware coalescence</p></li>
<li><p>Assert: no chunks span across “# Section” boundaries unless under soft barrier threshold</p></li>
</ul>
</li>
<li><p>[ ] 9.5 Add logging for boundary-aware merge decisions</p>
<ul class="simple">
<li><p>When soft barrier prevents merge: <code class="docutils literal notranslate"><span class="pre">logger.debug(f&quot;Soft</span> <span class="pre">barrier</span> <span class="pre">at</span> <span class="pre">chunk</span> <span class="pre">{k}:</span> <span class="pre">boundary</span> <span class="pre">detected,</span> <span class="pre">combined</span> <span class="pre">size</span> <span class="pre">{combined_size}</span> <span class="pre">&gt;</span> <span class="pre">{max_tokens-64}&quot;)</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="unified-cli-entry-point">
<h2>10. Unified CLI Entry Point<a class="headerlink" href="#unified-cli-entry-point" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 10.1 Create CLI directory: <code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span> <span class="pre">src/DocsToKG/DocParsing/cli</span></code></p></li>
<li><p>[ ] 10.2 Implement <code class="docutils literal notranslate"><span class="pre">cli/doctags_convert.py</span></code> with mode dispatch</p>
<ul>
<li><p><strong>Full Template</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;Unified CLI for HTML/PDF to DocTags conversion.</span>

<span class="sd">Usage:</span>
<span class="sd">    # PDF mode with vLLM</span>
<span class="sd">    python cli/doctags_convert.py --mode pdf --input Data/PDFs --output Data/DocTagsFiles</span>

<span class="sd">    # HTML mode (CPU-only)</span>
<span class="sd">    python cli/doctags_convert.py --mode html --input Data/HTML --output Data/DocTagsFiles</span>

<span class="sd">    # Auto-detect mode</span>
<span class="sd">    python cli/doctags_convert.py --mode auto --input Data/Mixed --output Data/DocTagsFiles</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.DocParsing._common</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">data_doctags</span>

<span class="c1"># Import backend implementations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.DocParsing</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_docling_html_to_doctags_parallel</span> <span class="k">as</span> <span class="n">html_backend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.DocParsing</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_docling_parallel_with_vllm_debug</span> <span class="k">as</span> <span class="n">pdf_backend</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unified DocTags converter&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mode&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">],</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--input&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--workers&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data-root&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--logging-level&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>

    <span class="c1"># PDF-specific options</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;vLLM model path (PDF mode only)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--served-model-name&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--gpu-memory-utilization&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.30</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">detect_mode</span><span class="p">(</span><span class="n">input_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Auto-detect conversion mode based on file extensions.&quot;&quot;&quot;</span>
    <span class="n">pdf_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">input_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.pdf&quot;</span><span class="p">)))</span>
    <span class="n">html_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">input_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.html&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.htm&quot;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">pdf_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">html_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;pdf&quot;</span>
    <span class="k">elif</span> <span class="n">html_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pdf_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;html&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot auto-detect mode: found </span><span class="si">{</span><span class="n">pdf_count</span><span class="si">}</span><span class="s2"> PDFs and </span><span class="si">{</span><span class="n">html_count</span><span class="si">}</span><span class="s2"> HTMLs&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">logging_level</span><span class="p">)</span>

    <span class="c1"># Resolve mode</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">detect_mode</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-detected mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set default output</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">data_doctags</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_root</span><span class="p">)</span>

    <span class="c1"># Dispatch to backend</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;pdf&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running PDF → DocTags conversion with vLLM&quot;</span><span class="p">)</span>
        <span class="n">pdf_backend</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># Pass args to backend</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running HTML → DocTags conversion (CPU-only)&quot;</span><span class="p">)</span>
        <span class="n">html_backend</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>[ ] 10.3 Refactor backend scripts to accept args object</p>
<ul class="simple">
<li><p>Update <code class="docutils literal notranslate"><span class="pre">run_docling_html_to_doctags_parallel.py</span></code> main() to accept optional args parameter</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">run_docling_parallel_with_vllm_debug.py</span></code> main() similarly</p></li>
<li><p>If args is None, parse from sys.argv as usual</p></li>
</ul>
</li>
<li><p>[ ] 10.4 Add comprehensive help text</p>
<ul class="simple">
<li><p>Add examples section to argparse epilog showing common usage patterns</p></li>
<li><p>Document PDF-specific vs HTML-specific flags</p></li>
</ul>
</li>
<li><p>[ ] 10.5 Add deprecation notice to old scripts</p>
<ul>
<li><p>At top of <code class="docutils literal notranslate"><span class="pre">run_docling_html_to_doctags_parallel.py</span></code> and <code class="docutils literal notranslate"><span class="pre">run_docling_parallel_with_vllm_debug.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
    <span class="s2">&quot;Direct invocation of this script is deprecated. &quot;</span>
    <span class="s2">&quot;Use unified CLI: python cli/doctags_convert.py --mode [pdf|html]&quot;</span><span class="p">,</span>
    <span class="ne">DeprecationWarning</span><span class="p">,</span>
    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="refactored-module-clis">
<h2>11. Refactored Module CLIs<a class="headerlink" href="#refactored-module-clis" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>[ ] 11.1 Create <code class="docutils literal notranslate"><span class="pre">cli/chunk_and_coalesce.py</span></code></p>
<ul>
<li><p>Wrap chunking logic from <code class="docutils literal notranslate"><span class="pre">DoclingHybridChunkerPipelineWithMin.py</span></code></p></li>
<li><p>Import main processing function as callable</p></li>
<li><p>Add all CLI flags: –min-tokens, –max-tokens, –tokenizer-model, –in-dir, –out-dir</p></li>
<li><p>Preserve existing functionality while providing clean CLI interface</p></li>
</ul>
</li>
<li><p>[ ] 11.2 Create <code class="docutils literal notranslate"><span class="pre">cli/embed_vectors.py</span></code></p>
<ul>
<li><p>Wrap embedding logic from <code class="docutils literal notranslate"><span class="pre">EmbeddingV2.py</span></code></p></li>
<li><p>Add all CLI flags for batch sizes, model paths</p></li>
<li><p>Import core embedding functions as library code</p></li>
</ul>
</li>
<li><p>[ ] 11.3 Update documentation to reference new CLIs</p>
<ul>
<li><p>Update README with new command examples</p></li>
<li><p>Mark old script paths as “legacy” but still functional</p></li>
</ul>
</li>
</ul>
</section>
<section id="logging-infrastructure">
<h2>12. Logging Infrastructure<a class="headerlink" href="#logging-infrastructure" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>[ ] 12.1 Update all print statements to use logging</p>
<ul>
<li><p>Search for <code class="docutils literal notranslate"><span class="pre">print(</span></code> in all DocParsing scripts</p></li>
<li><p>Replace with appropriate log level:</p>
<ul>
<li><p>Errors: <code class="docutils literal notranslate"><span class="pre">logger.error()</span></code></p></li>
<li><p>Warnings: <code class="docutils literal notranslate"><span class="pre">logger.warning()</span></code></p></li>
<li><p>Info: <code class="docutils literal notranslate"><span class="pre">logger.info()</span></code></p></li>
<li><p>Debug: <code class="docutils literal notranslate"><span class="pre">logger.debug()</span></code></p></li>
</ul>
</li>
<li><p>Keep tqdm progress bars (they write to stderr)</p></li>
</ul>
</li>
<li><p>[ ] 12.2 Add structured context to log messages</p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">extra={&quot;extra_fields&quot;:</span> <span class="pre">{...}}</span></code> for structured data</p></li>
<li><p>Example: <code class="docutils literal notranslate"><span class="pre">logger.info(&quot;Processing</span> <span class="pre">complete&quot;,</span> <span class="pre">extra={&quot;extra_fields&quot;:</span> <span class="pre">{&quot;doc_id&quot;:</span> <span class="pre">doc_id,</span> <span class="pre">&quot;duration_s&quot;:</span> <span class="pre">elapsed}})</span></code></p></li>
</ul>
</li>
<li><p>[ ] 12.3 Create Data/Manifests/ directory in each script’s initialization</p>
<ul>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">data_manifests()</span></code> early to ensure directory exists</p></li>
</ul>
</li>
<li><p>[ ] 12.4 Add manifest entries at key milestones</p>
<ul>
<li><p>DocTags conversion: success/failure/skip per document</p></li>
<li><p>Chunking: success/failure per document with chunk count</p></li>
<li><p>Embeddings: success/failure per document with vector count</p></li>
</ul>
</li>
</ul>
</section>
<section id="provenance-enrichment">
<h2>13. Provenance Enrichment<a class="headerlink" href="#provenance-enrichment" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>[ ] 13.1 Detect parse engine in conversion scripts</p>
<ul>
<li><p>In HTML converter: set <code class="docutils literal notranslate"><span class="pre">parse_engine</span> <span class="pre">=</span> <span class="pre">&quot;docling-html&quot;</span></code></p></li>
<li><p>In PDF converter: set <code class="docutils literal notranslate"><span class="pre">parse_engine</span> <span class="pre">=</span> <span class="pre">&quot;docling-vlm&quot;</span></code></p></li>
<li><p>Pass to chunk writing function</p></li>
</ul>
</li>
<li><p>[ ] 13.2 Detect docling version</p>
<ul>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">get_docling_version()</span></code> from schemas module</p></li>
<li><p>Include in every chunk row</p></li>
</ul>
</li>
<li><p>[ ] 13.3 Track image annotations during serialization</p>
<ul>
<li><p>In <code class="docutils literal notranslate"><span class="pre">CaptionPlusAnnotationPictureSerializer.serialize()</span></code>, count:</p>
<ul>
<li><p>has_image_captions: len(parts) &gt; 1 (more than just “<!-- image -->”)</p></li>
<li><p>has_image_classification: any classification annotations present</p></li>
</ul>
</li>
<li><p>Accumulate these flags in provenance metadata</p></li>
</ul>
</li>
<li><p>[ ] 13.4 Add provenance to ChunkRow during writing</p>
<ul>
<li><p>Construct ProvenanceMetadata object</p></li>
<li><p>Validate with schema</p></li>
<li><p>Include in JSONL output</p></li>
</ul>
</li>
</ul>
</section>
<section id="vllm-server-enhancements">
<h2>14. vLLM Server Enhancements<a class="headerlink" href="#vllm-server-enhancements" title="Link to this heading"></a></h2>
<ul>
<li><p>[ ] 14.1 Add –model CLI flag</p>
<ul>
<li><p><strong>Implementation</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s2">&quot;--model&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;/home/paul/hf-cache/granite-docling-258M&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to vLLM model&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Update MODEL_PATH to use args.model</p></li>
</ul>
</li>
<li><p>[ ] 14.2 Add –served-model-name flag with multiple names support</p>
<ul class="simple">
<li><p>Update vLLM command to pass served names from CLI</p></li>
</ul>
</li>
<li><p>[ ] 14.3 Implement model validation in ensure_vllm()</p>
<ul class="simple">
<li><p>After <code class="docutils literal notranslate"><span class="pre">wait_for_vllm</span></code> succeeds, call <code class="docutils literal notranslate"><span class="pre">probe_models(port)</span></code></p></li>
<li><p>Extract model names from response</p></li>
<li><p>Verify expected model name is in list</p></li>
<li><p>If not found, raise <code class="docutils literal notranslate"><span class="pre">RuntimeError(f&quot;Expected</span> <span class="pre">model</span> <span class="pre">'{expected}'</span> <span class="pre">not</span> <span class="pre">found</span> <span class="pre">in</span> <span class="pre">server.</span> <span class="pre">Available:</span> <span class="pre">{names}&quot;)</span></code></p></li>
</ul>
</li>
<li><p>[ ] 14.4 Add vLLM version detection</p>
<ul class="simple">
<li><p>Try: <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">vllm;</span> <span class="pre">version</span> <span class="pre">=</span> <span class="pre">vllm.__version__</span></code></p></li>
<li><p>Log version at startup</p></li>
<li><p>Add compatibility check if needed (e.g., require vllm &gt;= 0.3.0)</p></li>
</ul>
</li>
<li><p>[ ] 14.5 Enhance error diagnostics for vLLM startup failures</p>
<ul class="simple">
<li><p>Capture last 50 lines of stdout when process exits early</p></li>
<li><p>Include in error message with context about common issues (CUDA version, model not found, etc.)</p></li>
</ul>
</li>
</ul>
</section>
<section id="idempotency-resume">
<h2>15. Idempotency &amp; Resume<a class="headerlink" href="#idempotency-resume" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>[ ] 15.1 Implement lock file creation</p>
<ul>
<li><p>Before writing output file, create <code class="docutils literal notranslate"><span class="pre">output_path.lock</span></code> with PID</p></li>
<li><p>Check if lock exists and is stale (PID not running)</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">acquire_lock()</span></code> context manager from _common</p></li>
</ul>
</li>
<li><p>[ ] 15.2 Add content hash tracking</p>
<ul>
<li><p>Compute hash of input file before processing</p></li>
<li><p>Store in manifest with output file path</p></li>
<li><p>On resume, compare hash to detect changes</p></li>
</ul>
</li>
<li><p>[ ] 15.3 Implement –resume flag</p>
<ul>
<li><p>Add to all processing scripts</p></li>
<li><p>Logic: Skip if output exists AND input hash matches manifest entry</p></li>
<li><p>Log skip reason: “Skipping {doc_id}: output exists and input unchanged”</p></li>
</ul>
</li>
<li><p>[ ] 15.4 Add –force flag to override resume</p>
<ul>
<li><p>When set, ignore existing outputs and reprocess everything</p></li>
<li><p>Log: “Force mode: reprocessing all documents”</p></li>
</ul>
</li>
</ul>
</section>
<section id="testing-infrastructure">
<h2>16. Testing Infrastructure<a class="headerlink" href="#testing-infrastructure" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>[ ] 16.1 Create golden-path fixture directory</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">tests/data/docparsing/golden/</span></code> with:</p>
<ul>
<li><p>sample.doctags (small known document)</p></li>
<li><p>sample.chunks.jsonl (expected chunks)</p></li>
<li><p>sample.vectors.jsonl (expected vectors)</p></li>
</ul>
</li>
<li><p>Commit to git for deterministic testing</p></li>
</ul>
</li>
<li><p>[ ] 16.2 Implement deterministic chunk count test</p>
<ul>
<li><p>Read golden fixture</p></li>
<li><p>Run chunker with fixed parameters</p></li>
<li><p>Assert chunk count matches expected</p></li>
<li><p>Assert chunk text hashes match (for ordering stability)</p></li>
</ul>
</li>
<li><p>[ ] 16.3 Implement trip-wire test: coalescer invariants</p>
<ul>
<li><p>Test: All chunks have &gt;= min_tokens (except last chunk)</p></li>
<li><p>Test: No chunks exceed max_tokens</p></li>
<li><p>Test: Chunks are in document order</p></li>
<li><p>Use property-based testing (hypothesis) for randomized inputs</p></li>
</ul>
</li>
<li><p>[ ] 16.4 Implement trip-wire test: embedding shapes</p>
<ul>
<li><p>Test: All Qwen vectors have dimension 2560</p></li>
<li><p>Test: All SPLADE vectors have non-negative weights</p></li>
<li><p>Test: BM25 term and weight lists have equal length</p></li>
</ul>
</li>
<li><p>[ ] 16.5 Add CI configuration</p>
<ul>
<li><p>Create <code class="docutils literal notranslate"><span class="pre">.github/workflows/docparsing-tests.yml</span></code></p></li>
<li><p>Run tests on: Python 3.9, 3.10, 3.11</p></li>
<li><p>Install dependencies: pytest, hypothesis, pydantic</p></li>
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">tests/test_docparsing_*.py</span> <span class="pre">-v</span> <span class="pre">--cov=src/DocsToKG/DocParsing</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="documentation">
<h2>17. Documentation<a class="headerlink" href="#documentation" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>[ ] 17.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/DocParsing/README.md</span></code> with architecture overview</p>
<ul>
<li><p>Sections: Overview, Architecture, Stage Descriptions, Configuration, CLI Reference, Troubleshooting</p></li>
</ul>
</li>
<li><p>[ ] 17.2 Document environment variables</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">DOCSTOKG_DATA_ROOT</span></code>: Override data directory location</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DOCLING_CUDA_USE_FLASH_ATTENTION2</span></code>: Enable flash attention</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DOCLING_ARTIFACTS_PATH</span></code>: Cache directory for Docling artifacts</p></li>
</ul>
</li>
<li><p>[ ] 17.3 Document schema versioning strategy</p>
<ul>
<li><p>Explain version string format</p></li>
<li><p>Describe backward compatibility approach</p></li>
<li><p>Provide migration examples for version updates</p></li>
</ul>
</li>
<li><p>[ ] 17.4 Add CLI usage examples</p>
<ul>
<li><p>Show complete workflows from PDFs → DocTags → Chunks → Vectors</p></li>
<li><p>Include –resume flag usage for large datasets</p></li>
<li><p>Show troubleshooting commands</p></li>
</ul>
</li>
<li><p>[ ] 17.5 Create troubleshooting guide</p>
<ul>
<li><p>CUDA errors: spawn mode, memory limits</p></li>
<li><p>OOM errors: reduce batch sizes</p></li>
<li><p>vLLM startup failures: model path, port conflicts</p></li>
<li><p>Validation errors: schema mismatch, missing fields</p></li>
</ul>
</li>
<li><p>[ ] 17.6 Document manifest query examples</p>
<ul>
<li><p>Show jq queries for common questions:</p>
<ul>
<li><p>Failed documents: <code class="docutils literal notranslate"><span class="pre">jq</span> <span class="pre">'select(.status==&quot;failure&quot;)'</span> <span class="pre">docparse.manifest.jsonl</span></code></p></li>
<li><p>Average duration by stage: <code class="docutils literal notranslate"><span class="pre">jq</span> <span class="pre">-s</span> <span class="pre">'group_by(.stage)</span> <span class="pre">|</span> <span class="pre">map({stage:</span> <span class="pre">.[0].stage,</span> <span class="pre">avg_duration:</span> <span class="pre">(map(.duration_s)</span> <span class="pre">|</span> <span class="pre">add</span> <span class="pre">/</span> <span class="pre">length)})'</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="integration-validation">
<h2>18. Integration &amp; Validation<a class="headerlink" href="#integration-validation" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>[ ] 18.1 Run end-to-end integration test</p>
<ul>
<li><p>Use small test dataset (5-10 documents)</p></li>
<li><p>Run full pipeline: PDFs → DocTags → Chunks → Vectors</p></li>
<li><p>Validate outputs at each stage</p></li>
<li><p>Check manifest completeness</p></li>
</ul>
</li>
<li><p>[ ] 18.2 Validate all JSONL outputs against schemas</p>
<ul>
<li><p>Load each output file</p></li>
<li><p>Validate every row with Pydantic models</p></li>
<li><p>Assert zero validation errors</p></li>
</ul>
</li>
<li><p>[ ] 18.3 Run OpenSpec validation</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">openspec</span> <span class="pre">validate</span> <span class="pre">refactor-docparsing-pipeline</span> <span class="pre">--strict</span></code></p></li>
<li><p>Fix any issues reported</p></li>
</ul>
</li>
<li><p>[ ] 18.4 Update pyproject.toml</p>
<ul>
<li><p>Add pydantic dependency with version constraint: <code class="docutils literal notranslate"><span class="pre">pydantic&gt;=2.0,&lt;3.0</span></code></p></li>
<li><p>Update other dependencies if needed</p></li>
</ul>
</li>
<li><p>[ ] 18.5 Benchmark memory usage</p>
<ul>
<li><p>Before: Run old EmbeddingV2.py with 1000 documents, record peak memory</p></li>
<li><p>After: Run new streaming version, record peak memory</p></li>
<li><p>Document improvement percentage</p></li>
</ul>
</li>
<li><p>[ ] 18.6 Performance regression testing</p>
<ul>
<li><p>Run old vs new pipelines on same 100-document dataset</p></li>
<li><p>Measure total wall-clock time</p></li>
<li><p>Assert new version is within 10% of old version (allow for I/O overhead)</p></li>
</ul>
</li>
<li><p>[ ] 18.7 Create CHANGELOG entry</p>
<ul>
<li><p>Document all changes made</p></li>
<li><p>Note breaking changes (none expected)</p></li>
<li><p>Include performance benchmarks</p></li>
<li><p>Provide migration guide</p></li>
</ul>
</li>
<li><p>[ ] 18.8 Final code review checklist</p>
<ul>
<li><p>[ ] All TODOs removed</p></li>
<li><p>[ ] No debug print statements</p></li>
<li><p>[ ] All functions have docstrings</p></li>
<li><p>[ ] No hardcoded paths remain</p></li>
<li><p>[ ] Error messages are actionable</p></li>
<li><p>[ ] Logging is appropriate (not too verbose, not too quiet)</p></li>
<li><p>[ ] Tests pass on CI</p></li>
</ul>
</li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, DocsToKG Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>