

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MODIFIED Requirements &mdash; DocsToKG 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/custom.css" />


      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



          <a href="../../../../../../index.html" class="icon icon-home">
            DocsToKG
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../01-overview/index.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../02-setup/index.html">1. Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../03-architecture/index.html">1. Architecture Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../04-api/index.html">1. API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../05-development/index.html">1. Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../06-operations/index.html">1. Operations Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../07-reference/index.html">1. Technical Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">DocsToKG</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">MODIFIED Requirements</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/openspec/changes/archive/2025-10-14-optimize-hybrid-faiss-pipeline/specs/hybrid-search/spec.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <section id="modified-requirements">
<h1>MODIFIED Requirements<a class="headerlink" href="#modified-requirements" title="Link to this heading"></a></h1>
<section id="requirement-faiss-index-provisioning">
<h2>Requirement: FAISS Index Provisioning<a class="headerlink" href="#requirement-faiss-index-provisioning" title="Link to this heading"></a></h2>
<p>The system SHALL provision GPU FAISS indexes for 2560-d embeddings using cosine similarity via L2 normalization and Inner Product metrics, supporting GpuIndexFlatIP for exact search and GpuIndexIVFFlat or GpuIndexIVFPQ for ANN with train-before-add semantics. Index construction SHALL leverage FAISS factory strings or GPU-native constructors to minimize boilerplate, enforce <code class="docutils literal notranslate"><span class="pre">IndexIDMap2</span></code> wrapping for explicit IDs, and immediately apply IVF parameters (<code class="docutils literal notranslate"><span class="pre">nprobe</span></code>, PQ knobs) through FAISS’ parameter space helpers so configuration changes take effect without per-query overrides.</p>
<section id="scenario-initialize-faiss-index-with-factory-helpers">
<h3>Scenario: Initialize FAISS index with factory helpers<a class="headerlink" href="#scenario-initialize-faiss-index-with-factory-helpers" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>GIVEN</strong> StandardGpuResources and configuration indicating Flat or IVF mode</p></li>
<li><p><strong>WHEN</strong> the retrieval service starts</p></li>
<li><p><strong>THEN</strong> the FAISS index is built via the factory/GPU helper APIs in one pass, wrapped in <code class="docutils literal notranslate"><span class="pre">IndexIDMap2</span></code>, and IVF-specific parameters (e.g., <code class="docutils literal notranslate"><span class="pre">nprobe</span></code>) are set through FAISS’ parameter space utilities before serving queries</p></li>
<li><p><strong>AND</strong> construction logs report the effective index type and tuning parameters for observability</p></li>
</ul>
</section>
</section>
<section id="requirement-batch-upsert-and-delete-semantics">
<h2>Requirement: Batch Upsert and Delete Semantics<a class="headerlink" href="#requirement-batch-upsert-and-delete-semantics" title="Link to this heading"></a></h2>
<p>Upsert workflows SHALL batch vectors (e.g., 50k–100k) to control GPU memory pressure, normalize embeddings with <code class="docutils literal notranslate"><span class="pre">faiss.normalize_L2</span></code>, remove existing IDs before re-adding, and ensure deletions call both OpenSearch delete and <code class="docutils literal notranslate"><span class="pre">remove_ids</span></code> in FAISS. Delete operations SHALL rely on FAISS’ batch ID selector APIs with CPU fallback when GPU indexes raise <code class="docutils literal notranslate"><span class="pre">remove_ids</span> <span class="pre">not</span> <span class="pre">implemented</span></code>, and internal ID bookkeeping SHALL be delegated to the chunk registry so serialized index payloads do not duplicate state.</p>
<section id="scenario-remove-vectors-with-streamlined-selector">
<h3>Scenario: Remove vectors with streamlined selector<a class="headerlink" href="#scenario-remove-vectors-with-streamlined-selector" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>GIVEN</strong> a FAISS index running on GPU that raises <code class="docutils literal notranslate"><span class="pre">remove_ids</span> <span class="pre">not</span> <span class="pre">implemented</span></code></p></li>
<li><p><strong>WHEN</strong> the ingestion pipeline re-ingests a batch that requires deleting existing vector IDs</p></li>
<li><p><strong>THEN</strong> the manager issues a batch ID selector, transparently downgrades to CPU on unsupported GPU paths, and re-promotes the index</p></li>
<li><p><strong>AND</strong> the chunk registry remains the single source of mapping truth for vector IDs</p></li>
</ul>
</section>
</section>
<section id="requirement-result-shaping-and-diversification">
<h2>Requirement: Result Shaping and Diversification<a class="headerlink" href="#requirement-result-shaping-and-diversification" title="Link to this heading"></a></h2>
<p>Result shaping SHALL collapse duplicate doc_ids, enforce chunk-per-doc budgets, provide per-result diagnostics, and dedupe candidates using cosine thresholds. When diversification (MMR) is enabled, cosine similarity computations SHALL use FAISS’ GPU pairwise distance helpers when available (with CPU fallbacks) to efficiently score redundancy across the candidate set.</p>
<section id="scenario-diversify-candidates-with-gpu-cosine-batching">
<h3>Scenario: Diversify candidates with GPU cosine batching<a class="headerlink" href="#scenario-diversify-candidates-with-gpu-cosine-batching" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>GIVEN</strong> a diversified hybrid search request with sufficient GPU resources</p></li>
<li><p><strong>WHEN</strong> MMR executes over the fused candidate list</p></li>
<li><p><strong>THEN</strong> cosine similarities are computed in bulk via FAISS pairwise distance helpers, producing the same ranking quality faster than per-result NumPy loops</p></li>
<li><p><strong>AND</strong> the pipeline falls back to NumPy when GPU helpers are unavailable</p></li>
</ul>
</section>
</section>
<section id="requirement-hybrid-retrieval-storage">
<h2>Requirement: Hybrid Retrieval Storage<a class="headerlink" href="#requirement-hybrid-retrieval-storage" title="Link to this heading"></a></h2>
<p>The system SHALL persist chunk-level content in OpenSearch for sparse retrieval and in GPU FAISS indexes for dense retrieval, using a shared <code class="docutils literal notranslate"><span class="pre">vector_id</span></code> (UUID) across both systems via IndexIDMap2. Implementation SHALL avoid redundant identity maps by sourcing FAISS int→vector mappings from the chunk registry and shall expose sparse search helpers that reuse filter/sort/paginate logic for BM25 and SPLADE to reduce duplication.</p>
<section id="scenario-execute-sparse-search-through-shared-helper">
<h3>Scenario: Execute sparse search through shared helper<a class="headerlink" href="#scenario-execute-sparse-search-through-shared-helper" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>GIVEN</strong> a BM25 or SPLADE query with namespace filters</p></li>
<li><p><strong>WHEN</strong> the simulator executes the sparse search</p></li>
<li><p><strong>THEN</strong> it passes a scoring lambda into a shared sparse search helper that handles filtering, score aggregation, and pagination identically for both BM25 and SPLADE</p></li>
<li><p><strong>AND</strong> pagination semantics remain unchanged from the previous implementation</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, DocsToKG Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
