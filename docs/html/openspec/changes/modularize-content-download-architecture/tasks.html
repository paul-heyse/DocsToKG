

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. HTTP Retry Infrastructure &mdash; DocsToKG 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            DocsToKG
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../01-overview/index.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../02-setup/index.html">1. Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../03-architecture/index.html">1. Architecture Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../04-api/index.html">1. API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../05-development/index.html">1. Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../06-operations/index.html">1. Operations Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../07-reference/index.html">1. Technical Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DocsToKG</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">1. HTTP Retry Infrastructure</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/openspec/changes/modularize-content-download-architecture/tasks.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="http-retry-infrastructure">
<h1>1. HTTP Retry Infrastructure<a class="headerlink" href="#http-retry-infrastructure" title="Link to this heading"></a></h1>
<ul>
<li><p>[x] 1.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/http.py</span></code> module skeleton</p>
<ul class="simple">
<li><p>Import <code class="docutils literal notranslate"><span class="pre">requests</span></code>, <code class="docutils literal notranslate"><span class="pre">time</span></code>, <code class="docutils literal notranslate"><span class="pre">random</span></code>, <code class="docutils literal notranslate"><span class="pre">Optional</span></code>, <code class="docutils literal notranslate"><span class="pre">Set</span></code>, <code class="docutils literal notranslate"><span class="pre">Any</span></code> from typing</p></li>
<li><p>Add module docstring: “Unified HTTP request utilities with retry and backoff support.”</p></li>
</ul>
</li>
<li><p>[x] 1.2 Implement <code class="docutils literal notranslate"><span class="pre">parse_retry_after_header(response:</span> <span class="pre">requests.Response)</span> <span class="pre">-&gt;</span> <span class="pre">Optional[float]</span></code> function</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">email.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">parsedate_to_datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_retry_after_header</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse Retry-After header and return wait time in seconds.</span>

<span class="sd">    Args:</span>
<span class="sd">        response: HTTP response potentially containing Retry-After header</span>

<span class="sd">    Returns:</span>
<span class="sd">        Float seconds to wait, or None if header missing/invalid</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Integer format</span>
<span class="sd">        &gt;&gt;&gt; parse_retry_after_header(response_with_header(&quot;5&quot;))</span>
<span class="sd">        5.0</span>

<span class="sd">        &gt;&gt;&gt; # HTTP-date format</span>
<span class="sd">        &gt;&gt;&gt; parse_retry_after_header(response_with_header(&quot;Wed, 21 Oct 2025 07:28:00 GMT&quot;))</span>
<span class="sd">        3600.5  # seconds until that time</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retry_after</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">retry_after</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Try parsing as integer (delta-seconds)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Try parsing as HTTP-date</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">target_time</span> <span class="o">=</span> <span class="n">parsedate_to_datetime</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_time</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>  <span class="c1"># Never return negative</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</li>
<li><p>[x] 1.3 Implement <code class="docutils literal notranslate"><span class="pre">request_with_retries()</span></code> function with signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">request_with_retries</span><span class="p">(</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">retry_statuses</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">backoff_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">,</span>
    <span class="n">respect_retry_after</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
</pre></div>
</div>
</li>
<li><p>[x] 1.4 Implement retry loop logic in <code class="docutils literal notranslate"><span class="pre">request_with_retries()</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">request_with_retries</span><span class="p">(</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">retry_statuses</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">backoff_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">,</span>
    <span class="n">respect_retry_after</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute HTTP request with exponential backoff and Retry-After support.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: requests.Session instance for executing requests</span>
<span class="sd">        method: HTTP method (GET, HEAD, POST, etc.)</span>
<span class="sd">        url: Target URL</span>
<span class="sd">        max_retries: Maximum number of retry attempts (default: 3)</span>
<span class="sd">        retry_statuses: Set of status codes triggering retry (default: {429,500,502,503,504})</span>
<span class="sd">        backoff_factor: Exponential backoff multiplier (default: 0.75)</span>
<span class="sd">        respect_retry_after: Parse and obey Retry-After headers (default: True)</span>
<span class="sd">        **kwargs: Additional arguments passed to session.request()</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response object on success</span>

<span class="sd">    Raises:</span>
<span class="sd">        requests.RequestException: On final retry exhaustion or non-retryable error</span>

<span class="sd">    Thread Safety:</span>
<span class="sd">        This function is thread-safe if the provided session is thread-safe.</span>
<span class="sd">        requests.Session is thread-safe for reads but not writes; for concurrent</span>
<span class="sd">        use, pass a session with connection pooling enabled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">retry_statuses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">retry_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="mi">429</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">}</span>

    <span class="n">last_exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Success or non-retryable status</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">retry_statuses</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="c1"># Final attempt exhausted</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;=</span> <span class="n">max_retries</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="c1"># Calculate backoff delay</span>
            <span class="n">base_delay</span> <span class="o">=</span> <span class="n">backoff_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
            <span class="n">jitter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="o">+</span> <span class="n">jitter</span>

            <span class="c1"># Override with Retry-After if present and longer</span>
            <span class="k">if</span> <span class="n">respect_retry_after</span><span class="p">:</span>
                <span class="n">retry_after_delay</span> <span class="o">=</span> <span class="n">parse_retry_after_header</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">retry_after_delay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">retry_after_delay</span> <span class="o">&gt;</span> <span class="n">delay</span><span class="p">:</span>
                    <span class="n">delay</span> <span class="o">=</span> <span class="n">retry_after_delay</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">last_exception</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;=</span> <span class="n">max_retries</span><span class="p">:</span>
                <span class="k">raise</span>

            <span class="c1"># Exponential backoff on request exceptions too</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">backoff_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

    <span class="c1"># Should never reach here, but defensive</span>
    <span class="k">if</span> <span class="n">last_exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">last_exception</span>
    <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exhausted </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> retries for </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[x] 1.5 Add comprehensive docstring to <code class="docutils literal notranslate"><span class="pre">request_with_retries()</span></code></p>
<ul class="simple">
<li><p>Document all parameters with types and defaults</p></li>
<li><p>Document return type and exceptions raised</p></li>
<li><p>Add usage example for HEAD and GET requests</p></li>
<li><p>Note thread-safety guarantees (session must be thread-safe)</p></li>
</ul>
</li>
<li><p>[x] 1.6 Update <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/download_pyalex_pdfs.py</span></code> imports</p>
<ul class="simple">
<li><p>Add: <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">DocsToKG.ContentDownload.http</span> <span class="pre">import</span> <span class="pre">request_with_retries</span></code></p></li>
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">session.head(url,</span> <span class="pre">...)</span></code> call at line ~970 with <code class="docutils literal notranslate"><span class="pre">request_with_retries(session,</span> <span class="pre">&quot;HEAD&quot;,</span> <span class="pre">url,</span> <span class="pre">max_retries=1,</span> <span class="pre">...)</span></code></p></li>
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">session.get(url,</span> <span class="pre">stream=True,</span> <span class="pre">...)</span></code> call at line ~980 with <code class="docutils literal notranslate"><span class="pre">request_with_retries(session,</span> <span class="pre">&quot;GET&quot;,</span> <span class="pre">url,</span> <span class="pre">...)</span></code></p></li>
<li><p>Remove HEAD error suppression <code class="docutils literal notranslate"><span class="pre">contextlib.suppress</span></code> since retries handle transients</p></li>
</ul>
</li>
<li><p>[x] 1.7 Update <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/__init__.py</span></code> to use new utility</p>
<ul class="simple">
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">_request_with_retries()</span></code> calls (lines ~1199, 1344, 1404, 1482, etc.) with <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">DocsToKG.ContentDownload.http</span> <span class="pre">import</span> <span class="pre">request_with_retries</span></code></p></li>
<li><p>Remove local <code class="docutils literal notranslate"><span class="pre">_request_with_retries()</span></code> definition (lines ~158-196)</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">_sleep_backoff()</span></code> references to use backoff logic from <code class="docutils literal notranslate"><span class="pre">http.request_with_retries()</span></code></p></li>
</ul>
</li>
<li><p>[x] 1.8 Add unit tests in <code class="docutils literal notranslate"><span class="pre">tests/test_http_retry.py</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.ContentDownload.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">request_with_retries</span><span class="p">,</span> <span class="n">parse_retry_after_header</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_request_no_retries</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify successful request completes immediately without retries.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">response</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_transient_503_with_exponential_backoff</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify exponential backoff timing for transient 503 errors.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">response_503</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">response_200</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">response_503</span><span class="p">,</span> <span class="n">response_503</span><span class="p">,</span> <span class="n">response_200</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
        <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="c1"># First backoff: ~0.5 * (2^0) = 0.5s, second: ~0.5 * (2^1) = 1.0s</span>
    <span class="c1"># Total minimum: ~1.5s (allowing for jitter and overhead)</span>
    <span class="k">assert</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mf">1.4</span> <span class="ow">and</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="mf">2.5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_retry_after_integer_format</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify Retry-After header with integer seconds is respected.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">response_429</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">429</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">})</span>
    <span class="n">response_200</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">response_429</span><span class="p">,</span> <span class="n">response_200</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
        <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mf">2.9</span>  <span class="c1"># Should wait ~3 seconds</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_retry_after_http_date_format</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify Retry-After header with HTTP-date format is respected.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>
    <span class="n">future_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">http_date</span> <span class="o">=</span> <span class="n">future_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">)</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">response_429</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">429</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">:</span> <span class="n">http_date</span><span class="p">})</span>
    <span class="n">response_200</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">response_429</span><span class="p">,</span> <span class="n">response_200</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
        <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mf">1.9</span> <span class="ow">and</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="mf">3.0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_exhausted_retries_returns_final_response</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify exhausted retries returns the final failed response.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">response_503</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">response_503</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
        <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">503</span>
    <span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># Initial + 2 retries</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_custom_retry_statuses</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify custom retry_statuses parameter controls retry behavior.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">response_404</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">response_200</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">response_404</span><span class="p">,</span> <span class="n">response_200</span><span class="p">]</span>

    <span class="c1"># 404 normally not retried, but we configure it</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
        <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">,</span>
        <span class="n">retry_statuses</span><span class="o">=</span><span class="p">{</span><span class="mi">404</span><span class="p">,</span> <span class="mi">503</span><span class="p">},</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_respect_retry_after_false</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify respect_retry_after=False ignores Retry-After header.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">response_429</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">429</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">})</span>
    <span class="n">response_200</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">response_429</span><span class="p">,</span> <span class="n">response_200</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
        <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">,</span>
        <span class="n">respect_retry_after</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="c1"># Should use exponential backoff (~0.1s), not Retry-After (10s)</span>
    <span class="k">assert</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="mf">1.0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_request_exception_retry</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify requests.RequestException triggers retry with backoff.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">response_200</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="s2">&quot;Connection timeout&quot;</span><span class="p">),</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Connection refused&quot;</span><span class="p">),</span>
        <span class="n">response_200</span>
    <span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
        <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_request_exception_exhausted</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify exhausted retries on exception raises the exception.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="s2">&quot;Persistent timeout&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span><span class="p">):</span>
        <span class="n">request_with_retries</span><span class="p">(</span>
            <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="p">)</span>

    <span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="conditional-request-helper">
<h1>2. Conditional Request Helper<a class="headerlink" href="#conditional-request-helper" title="Link to this heading"></a></h1>
<ul>
<li><p>[x] 2.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/conditional.py</span></code> module skeleton</p>
<ul class="simple">
<li><p>Import <code class="docutils literal notranslate"><span class="pre">dataclass</span></code>, <code class="docutils literal notranslate"><span class="pre">Optional</span></code>, <code class="docutils literal notranslate"><span class="pre">Dict</span></code>, <code class="docutils literal notranslate"><span class="pre">requests</span></code></p></li>
<li><p>Add module docstring: “Conditional HTTP request helpers for ETag and Last-Modified caching.”</p></li>
</ul>
</li>
<li><p>[x] 2.2 Define <code class="docutils literal notranslate"><span class="pre">CachedResult</span></code> dataclass</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CachedResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents HTTP 304 Not Modified response with prior metadata.&quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sha256</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content_length</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">etag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">last_modified</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>[x] 2.3 Define <code class="docutils literal notranslate"><span class="pre">ModifiedResult</span></code> dataclass</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModifiedResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents HTTP 200 response requiring fresh download.&quot;&quot;&quot;</span>
    <span class="n">etag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">last_modified</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>[x] 2.4 Implement <code class="docutils literal notranslate"><span class="pre">ConditionalRequestHelper</span></code> class initialization</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConditionalRequestHelper</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prior_etag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prior_last_modified</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prior_sha256</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prior_content_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prior_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_etag</span> <span class="o">=</span> <span class="n">prior_etag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_last_modified</span> <span class="o">=</span> <span class="n">prior_last_modified</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_sha256</span> <span class="o">=</span> <span class="n">prior_sha256</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_content_length</span> <span class="o">=</span> <span class="n">prior_content_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_path</span> <span class="o">=</span> <span class="n">prior_path</span>
</pre></div>
</div>
</li>
<li><p>[x] 2.5 Implement <code class="docutils literal notranslate"><span class="pre">build_headers()</span></code> method</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">build_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate conditional request headers from prior metadata.&quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_etag</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;If-None-Match&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_etag</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_last_modified</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;If-Modified-Since&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_last_modified</span>
    <span class="k">return</span> <span class="n">headers</span>
</pre></div>
</div>
</li>
<li><p>[x] 2.6 Implement <code class="docutils literal notranslate"><span class="pre">interpret_response()</span></code> method</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">interpret_response</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">CachedResult</span><span class="p">,</span> <span class="n">ModifiedResult</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interpret response status and headers as cached or modified result.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">304</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_sha256</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_content_length</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;304 response requires complete prior metadata&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CachedResult</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_path</span><span class="p">,</span>
            <span class="n">sha256</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_sha256</span><span class="p">,</span>
            <span class="n">content_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_content_length</span><span class="p">,</span>
            <span class="n">etag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_etag</span><span class="p">,</span>
            <span class="n">last_modified</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_last_modified</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">ModifiedResult</span><span class="p">(</span>
        <span class="n">etag</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ETag&quot;</span><span class="p">),</span>
        <span class="n">last_modified</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[x] 2.7 Update <code class="docutils literal notranslate"><span class="pre">download_candidate()</span></code> in <code class="docutils literal notranslate"><span class="pre">download_pyalex_pdfs.py</span></code> to use helper</p>
<ul class="simple">
<li><p>Import <code class="docutils literal notranslate"><span class="pre">ConditionalRequestHelper</span></code>, <code class="docutils literal notranslate"><span class="pre">CachedResult</span></code>, <code class="docutils literal notranslate"><span class="pre">ModifiedResult</span></code></p></li>
<li><p>At line ~950, create helper instance: <code class="docutils literal notranslate"><span class="pre">cond_helper</span> <span class="pre">=</span> <span class="pre">ConditionalRequestHelper(prior_etag=previous_etag,</span> <span class="pre">...)</span></code></p></li>
<li><p>Replace manual header building (lines ~958-961) with <code class="docutils literal notranslate"><span class="pre">headers.update(cond_helper.build_headers())</span></code></p></li>
<li><p>Replace 304 handling block (lines ~988-999) with: <code class="docutils literal notranslate"><span class="pre">result</span> <span class="pre">=</span> <span class="pre">cond_helper.interpret_response(response);</span> <span class="pre">if</span> <span class="pre">isinstance(result,</span> <span class="pre">CachedResult):</span> <span class="pre">return</span> <span class="pre">DownloadOutcome(...)</span></code></p></li>
</ul>
</li>
<li><p>[x] 2.8 Add unit tests in <code class="docutils literal notranslate"><span class="pre">tests/test_conditional_requests.py</span></code></p>
<ul class="simple">
<li><p>Test <code class="docutils literal notranslate"><span class="pre">build_headers()</span></code> with no prior data (empty dict)</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">build_headers()</span></code> with ETag only</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">build_headers()</span></code> with Last-Modified only</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">build_headers()</span></code> with both headers</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">interpret_response()</span></code> with 304 status returning <code class="docutils literal notranslate"><span class="pre">CachedResult</span></code></p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">interpret_response()</span></code> with 200 status returning <code class="docutils literal notranslate"><span class="pre">ModifiedResult</span></code></p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">interpret_response()</span></code> with 304 but missing prior metadata raising ValueError</p></li>
<li><p>Test header extraction from 200 response (ETag and Last-Modified present)</p></li>
</ul>
</li>
</ul>
</section>
<section id="resolver-module-restructuring-foundation">
<h1>3. Resolver Module Restructuring - Foundation<a class="headerlink" href="#resolver-module-restructuring-foundation" title="Link to this heading"></a></h1>
<ul>
<li><p>[x] 3.1 Create directory structure</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span> <span class="pre">src/DocsToKG/ContentDownload/resolvers/providers</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">touch</span> <span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/__init__.py</span></code></p></li>
</ul>
</li>
<li><p>[x] 3.2 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/types.py</span></code></p>
<ul class="simple">
<li><p>Copy dataclass definitions from <code class="docutils literal notranslate"><span class="pre">resolvers/__init__.py</span></code>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ResolverResult</span></code> (lines ~198-232)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ResolverConfig</span></code> (lines ~234-302)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AttemptRecord</span></code> (lines ~304-348)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DownloadOutcome</span></code> (lines ~378-422)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PipelineResult</span></code> (lines ~424-444)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ResolverMetrics</span></code> (lines ~501-571)</p></li>
</ul>
</li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">Resolver</span></code> protocol (lines ~447-498)</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">AttemptLogger</span></code> protocol (lines ~350-376)</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">DownloadFunc</span></code> type alias (line ~574)</p></li>
<li><p>Add imports: <code class="docutils literal notranslate"><span class="pre">dataclass</span></code>, <code class="docutils literal notranslate"><span class="pre">field</span></code>, <code class="docutils literal notranslate"><span class="pre">Protocol</span></code>, <code class="docutils literal notranslate"><span class="pre">Dict</span></code>, <code class="docutils literal notranslate"><span class="pre">List</span></code>, <code class="docutils literal notranslate"><span class="pre">Optional</span></code>, <code class="docutils literal notranslate"><span class="pre">Any</span></code>, <code class="docutils literal notranslate"><span class="pre">Counter</span></code>, <code class="docutils literal notranslate"><span class="pre">defaultdict</span></code></p></li>
<li><p>Add module docstring: “Type definitions and protocols for the resolver pipeline.”</p></li>
</ul>
</li>
<li><p>[x] 3.3 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/pipeline.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">ResolverPipeline</span></code> class (lines ~594-840)</p></li>
<li><p>Copy helper functions: <code class="docutils literal notranslate"><span class="pre">_callable_accepts_argument</span></code> (lines ~577-591)</p></li>
<li><p>Import types from <code class="docutils literal notranslate"><span class="pre">.types</span></code>: <code class="docutils literal notranslate"><span class="pre">ResolverConfig</span></code>, <code class="docutils literal notranslate"><span class="pre">AttemptRecord</span></code>, <code class="docutils literal notranslate"><span class="pre">DownloadOutcome</span></code>, <code class="docutils literal notranslate"><span class="pre">PipelineResult</span></code>, <code class="docutils literal notranslate"><span class="pre">ResolverResult</span></code>, <code class="docutils literal notranslate"><span class="pre">Resolver</span></code>, <code class="docutils literal notranslate"><span class="pre">AttemptLogger</span></code>, <code class="docutils literal notranslate"><span class="pre">DownloadFunc</span></code>, <code class="docutils literal notranslate"><span class="pre">ResolverMetrics</span></code></p></li>
<li><p>Import standard library: <code class="docutils literal notranslate"><span class="pre">threading</span></code>, <code class="docutils literal notranslate"><span class="pre">time</span></code>, <code class="docutils literal notranslate"><span class="pre">random</span></code>, <code class="docutils literal notranslate"><span class="pre">defaultdict</span></code>, <code class="docutils literal notranslate"><span class="pre">Dict</span></code>, <code class="docutils literal notranslate"><span class="pre">List</span></code>, <code class="docutils literal notranslate"><span class="pre">Optional</span></code>, <code class="docutils literal notranslate"><span class="pre">Any</span></code>, <code class="docutils literal notranslate"><span class="pre">Set</span></code>, <code class="docutils literal notranslate"><span class="pre">Sequence</span></code></p></li>
<li><p>Import <code class="docutils literal notranslate"><span class="pre">requests</span></code></p></li>
<li><p>Add module docstring: “Resolver pipeline orchestration and execution logic.”</p></li>
</ul>
</li>
<li><p>[x] 3.4 Update <code class="docutils literal notranslate"><span class="pre">resolvers/pipeline.py</span></code> imports for new structure</p>
<ul class="simple">
<li><p>Change <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">DocsToKG.ContentDownload.utils</span> <span class="pre">import</span> <span class="pre">...</span></code> to relative import if needed</p></li>
<li><p>Ensure all type references point to <code class="docutils literal notranslate"><span class="pre">types</span></code> module</p></li>
</ul>
</li>
<li><p>[x] 3.5 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/__init__.py</span></code> with registry</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Resolver provider implementations and registry.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resolver</span>

<span class="k">def</span><span class="w"> </span><span class="nf">default_resolvers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Resolver</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return default resolver instances in priority order.&quot;&quot;&quot;</span>
    <span class="c1"># Will be populated in subsequent tasks</span>
    <span class="k">return</span> <span class="p">[]</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;default_resolvers&quot;</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="resolver-module-restructuring-individual-providers">
<h1>4. Resolver Module Restructuring - Individual Providers<a class="headerlink" href="#resolver-module-restructuring-individual-providers" title="Link to this heading"></a></h1>
<ul>
<li><p>[x] 4.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/unpaywall.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">UnpaywallResolver</span></code> class (lines ~851-988 from <code class="docutils literal notranslate"><span class="pre">resolvers/__init__.py</span></code>)</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">_fetch_unpaywall_data</span></code> helper and LRU cache (lines ~85-101)</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">_headers_cache_key</span></code> helper (lines ~81-82)</p></li>
<li><p>Import necessary types from <code class="docutils literal notranslate"><span class="pre">..types</span></code>: <code class="docutils literal notranslate"><span class="pre">Resolver</span></code>, <code class="docutils literal notranslate"><span class="pre">ResolverConfig</span></code>, <code class="docutils literal notranslate"><span class="pre">ResolverResult</span></code></p></li>
<li><p>Import utilities: <code class="docutils literal notranslate"><span class="pre">normalize_doi</span></code>, <code class="docutils literal notranslate"><span class="pre">dedupe</span></code> from <code class="docutils literal notranslate"><span class="pre">DocsToKG.ContentDownload.utils</span></code></p></li>
<li><p>Import <code class="docutils literal notranslate"><span class="pre">requests</span></code>, <code class="docutils literal notranslate"><span class="pre">lru_cache</span></code>, <code class="docutils literal notranslate"><span class="pre">quote</span></code>, <code class="docutils literal notranslate"><span class="pre">Iterable</span></code>, <code class="docutils literal notranslate"><span class="pre">Dict</span></code>, <code class="docutils literal notranslate"><span class="pre">List</span></code>, <code class="docutils literal notranslate"><span class="pre">Tuple</span></code>, <code class="docutils literal notranslate"><span class="pre">Any</span></code></p></li>
<li><p>Add module docstring: “Unpaywall API resolver for open access PDFs.”</p></li>
</ul>
</li>
<li><p>[x] 4.2 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/crossref.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">CrossrefResolver</span></code> class (lines ~990-1145)</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">_fetch_crossref_data</span></code> helper and LRU cache (lines ~104-121)</p></li>
<li><p>Import necessary types and utilities</p></li>
<li><p>Add module docstring: “Crossref API resolver for publisher-hosted PDFs.”</p></li>
</ul>
</li>
<li><p>[x] 4.3 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/landing_page.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">LandingPageResolver</span></code> class (lines ~1148-1256)</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">_absolute_url</span></code> helper (lines ~844-848)</p></li>
<li><p>Import optional <code class="docutils literal notranslate"><span class="pre">BeautifulSoup</span></code> dependency with try/except</p></li>
<li><p>Import necessary types and utilities</p></li>
<li><p>Add module docstring: “Landing page scraper resolver using BeautifulSoup.”</p></li>
</ul>
</li>
<li><p>[x] 4.4 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/arxiv.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">ArxivResolver</span></code> class (lines ~1258-1309)</p></li>
<li><p>Import <code class="docutils literal notranslate"><span class="pre">strip_prefix</span></code> from utils</p></li>
<li><p>Add module docstring: “arXiv preprint resolver.”</p></li>
</ul>
</li>
<li><p>[x] 4.5 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/pmc.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">PmcResolver</span></code> class (lines ~1312-1433)</p></li>
<li><p>Import necessary utilities including <code class="docutils literal notranslate"><span class="pre">normalize_pmcid</span></code>, <code class="docutils literal notranslate"><span class="pre">normalize_doi</span></code>, <code class="docutils literal notranslate"><span class="pre">dedupe</span></code></p></li>
<li><p>Add module docstring: “PubMed Central resolver using NCBI utilities.”</p></li>
</ul>
</li>
<li><p>[x] 4.6 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/europe_pmc.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">EuropePmcResolver</span></code> class (lines ~1436-1504)</p></li>
<li><p>Add module docstring: “Europe PMC resolver for European open access articles.”</p></li>
</ul>
</li>
<li><p>[x] 4.7 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/core.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">CoreResolver</span></code> class (lines ~1507-1581)</p></li>
<li><p>Add module docstring: “CORE API resolver for aggregated open access content.”</p></li>
</ul>
</li>
<li><p>[x] 4.8 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/doaj.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">DoajResolver</span></code> class (lines ~1584-1658)</p></li>
<li><p>Add module docstring: “DOAJ (Directory of Open Access Journals) resolver.”</p></li>
</ul>
</li>
<li><p>[x] 4.9 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/semantic_scholar.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">SemanticScholarResolver</span></code> class (lines ~1661-1721)</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">_fetch_semantic_scholar_data</span></code> helper and LRU cache (lines ~124-143)</p></li>
<li><p>Add module docstring: “Semantic Scholar Graph API resolver.”</p></li>
</ul>
</li>
<li><p>[x] 4.10 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/openaire.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">OpenAireResolver</span></code> class (lines ~1724-1793)</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">_collect_candidate_urls</span></code> helper (lines ~146-155)</p></li>
<li><p>Add module docstring: “OpenAIRE research infrastructure resolver.”</p></li>
</ul>
</li>
<li><p>[x] 4.11 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/hal.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">HalResolver</span></code> class (lines ~1796-1873)</p></li>
<li><p>Add module docstring: “HAL (Hyper Articles en Ligne) open archive resolver.”</p></li>
</ul>
</li>
<li><p>[x] 4.12 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/osf.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">OsfResolver</span></code> class (lines ~1876-1954)</p></li>
<li><p>Add module docstring: “Open Science Framework preprints resolver.”</p></li>
</ul>
</li>
<li><p>[x] 4.13 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/wayback.py</span></code></p>
<ul class="simple">
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">WaybackResolver</span></code> class (lines ~1957-2022)</p></li>
<li><p>Add module docstring: “Internet Archive Wayback Machine fallback resolver.”</p></li>
</ul>
</li>
<li><p>[x] 4.14 Update <code class="docutils literal notranslate"><span class="pre">resolvers/providers/__init__.py</span></code> with complete registry</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">.unpaywall</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnpaywallResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.crossref</span><span class="w"> </span><span class="kn">import</span> <span class="n">CrossrefResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.landing_page</span><span class="w"> </span><span class="kn">import</span> <span class="n">LandingPageResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.arxiv</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArxivResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.pmc</span><span class="w"> </span><span class="kn">import</span> <span class="n">PmcResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.europe_pmc</span><span class="w"> </span><span class="kn">import</span> <span class="n">EuropePmcResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoreResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.doaj</span><span class="w"> </span><span class="kn">import</span> <span class="n">DoajResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.semantic_scholar</span><span class="w"> </span><span class="kn">import</span> <span class="n">SemanticScholarResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.openaire</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAireResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hal</span><span class="w"> </span><span class="kn">import</span> <span class="n">HalResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.osf</span><span class="w"> </span><span class="kn">import</span> <span class="n">OsfResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.wayback</span><span class="w"> </span><span class="kn">import</span> <span class="n">WaybackResolver</span>

<span class="k">def</span><span class="w"> </span><span class="nf">default_resolvers</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">UnpaywallResolver</span><span class="p">(),</span>
        <span class="n">CrossrefResolver</span><span class="p">(),</span>
        <span class="n">LandingPageResolver</span><span class="p">(),</span>
        <span class="n">ArxivResolver</span><span class="p">(),</span>
        <span class="n">PmcResolver</span><span class="p">(),</span>
        <span class="n">EuropePmcResolver</span><span class="p">(),</span>
        <span class="n">CoreResolver</span><span class="p">(),</span>
        <span class="n">DoajResolver</span><span class="p">(),</span>
        <span class="n">SemanticScholarResolver</span><span class="p">(),</span>
        <span class="n">OpenAireResolver</span><span class="p">(),</span>
        <span class="n">HalResolver</span><span class="p">(),</span>
        <span class="n">OsfResolver</span><span class="p">(),</span>
        <span class="n">WaybackResolver</span><span class="p">(),</span>
    <span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>[x] 4.15 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/__init__.py</span></code> with backward-compatible exports</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Resolver pipeline and provider implementations.</span>

<span class="sd">This module maintains backward compatibility by re-exporting all public APIs.</span>
<span class="sd">New code should import from submodules (pipeline, types, providers) directly.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.types</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AttemptLogger</span><span class="p">,</span>
    <span class="n">AttemptRecord</span><span class="p">,</span>
    <span class="n">DownloadOutcome</span><span class="p">,</span>
    <span class="n">PipelineResult</span><span class="p">,</span>
    <span class="n">Resolver</span><span class="p">,</span>
    <span class="n">ResolverConfig</span><span class="p">,</span>
    <span class="n">ResolverMetrics</span><span class="p">,</span>
    <span class="n">ResolverResult</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResolverPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.providers</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_resolvers</span>

<span class="c1"># Preserve legacy exports</span>
<span class="n">DEFAULT_RESOLVER_ORDER</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;unpaywall&quot;</span><span class="p">,</span> <span class="s2">&quot;crossref&quot;</span><span class="p">,</span> <span class="s2">&quot;landing_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arxiv&quot;</span><span class="p">,</span> <span class="s2">&quot;pmc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;europe_pmc&quot;</span><span class="p">,</span> <span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="s2">&quot;doaj&quot;</span><span class="p">,</span> <span class="s2">&quot;semantic_scholar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;openaire&quot;</span><span class="p">,</span> <span class="s2">&quot;hal&quot;</span><span class="p">,</span> <span class="s2">&quot;osf&quot;</span><span class="p">,</span> <span class="s2">&quot;wayback&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">clear_resolver_caches</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear resolver-level LRU caches.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.providers.unpaywall</span><span class="w"> </span><span class="kn">import</span> <span class="n">_fetch_unpaywall_data</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.providers.crossref</span><span class="w"> </span><span class="kn">import</span> <span class="n">_fetch_crossref_data</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.providers.semantic_scholar</span><span class="w"> </span><span class="kn">import</span> <span class="n">_fetch_semantic_scholar_data</span>
    <span class="n">_fetch_unpaywall_data</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
    <span class="n">_fetch_crossref_data</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
    <span class="n">_fetch_semantic_scholar_data</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;AttemptRecord&quot;</span><span class="p">,</span> <span class="s2">&quot;AttemptLogger&quot;</span><span class="p">,</span> <span class="s2">&quot;DownloadOutcome&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PipelineResult&quot;</span><span class="p">,</span> <span class="s2">&quot;Resolver&quot;</span><span class="p">,</span> <span class="s2">&quot;ResolverConfig&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ResolverPipeline&quot;</span><span class="p">,</span> <span class="s2">&quot;ResolverResult&quot;</span><span class="p">,</span> <span class="s2">&quot;ResolverMetrics&quot;</span><span class="p">,</span>
    <span class="s2">&quot;default_resolvers&quot;</span><span class="p">,</span> <span class="s2">&quot;DEFAULT_RESOLVER_ORDER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;clear_resolver_caches&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>[ ] 4.16 Verify all existing imports still work</p>
<ul class="simple">
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-c</span> <span class="pre">&quot;from</span> <span class="pre">DocsToKG.ContentDownload.resolvers</span> <span class="pre">import</span> <span class="pre">ResolverPipeline,</span> <span class="pre">default_resolvers,</span> <span class="pre">ResolverConfig&quot;</span></code></p></li>
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-c</span> <span class="pre">&quot;from</span> <span class="pre">DocsToKG.ContentDownload.resolvers</span> <span class="pre">import</span> <span class="pre">AttemptRecord,</span> <span class="pre">DownloadOutcome&quot;</span></code></p></li>
<li><p>Verify no ImportError exceptions</p></li>
</ul>
</li>
</ul>
</section>
<section id="openalex-virtual-resolver">
<h1>5. OpenAlex Virtual Resolver<a class="headerlink" href="#openalex-virtual-resolver" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 5.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/openalex.py</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;OpenAlex direct URL resolver (position 0 in pipeline).&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resolver</span><span class="p">,</span> <span class="n">ResolverConfig</span><span class="p">,</span> <span class="n">ResolverResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.ContentDownload.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedupe</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OpenAlexResolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resolver for PDF URLs directly provided by OpenAlex metadata.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;openalex&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ResolverConfig</span><span class="p">,</span> <span class="n">artifact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable when artifact has pdf_urls or open_access_url.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">artifact</span><span class="o">.</span><span class="n">pdf_urls</span> <span class="ow">or</span> <span class="n">artifact</span><span class="o">.</span><span class="n">open_access_url</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ResolverConfig</span><span class="p">,</span> <span class="n">artifact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ResolverResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield all PDF URLs from OpenAlex work metadata.&quot;&quot;&quot;</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">artifact</span><span class="o">.</span><span class="n">pdf_urls</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">artifact</span><span class="o">.</span><span class="n">open_access_url</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artifact</span><span class="o">.</span><span class="n">open_access_url</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">dedupe</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;openalex_metadata&quot;</span><span class="p">}</span>
                <span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 5.2 Register <code class="docutils literal notranslate"><span class="pre">OpenAlexResolver</span></code> in providers registry</p>
<ul class="simple">
<li><p>Update <code class="docutils literal notranslate"><span class="pre">resolvers/providers/__init__.py</span></code> to import <code class="docutils literal notranslate"><span class="pre">OpenAlexResolver</span></code></p></li>
<li><p>Insert at <strong>position 0</strong> in <code class="docutils literal notranslate"><span class="pre">default_resolvers()</span></code> return list (before Unpaywall)</p></li>
</ul>
</li>
<li><p>[ ] 5.3 Update <code class="docutils literal notranslate"><span class="pre">DEFAULT_RESOLVER_ORDER</span></code> in <code class="docutils literal notranslate"><span class="pre">resolvers/__init__.py</span></code></p>
<ul class="simple">
<li><p>Prepend <code class="docutils literal notranslate"><span class="pre">&quot;openalex&quot;</span></code> to list: <code class="docutils literal notranslate"><span class="pre">[&quot;openalex&quot;,</span> <span class="pre">&quot;unpaywall&quot;,</span> <span class="pre">&quot;crossref&quot;,</span> <span class="pre">...]</span></code></p></li>
</ul>
</li>
<li><p>[ ] 5.4 Remove <code class="docutils literal notranslate"><span class="pre">attempt_openalex_candidates()</span></code> function from <code class="docutils literal notranslate"><span class="pre">download_pyalex_pdfs.py</span></code></p>
<ul class="simple">
<li><p>Delete function definition (lines ~1332-1402)</p></li>
<li><p>Remove all calls to <code class="docutils literal notranslate"><span class="pre">attempt_openalex_candidates()</span></code> in <code class="docutils literal notranslate"><span class="pre">process_one_work()</span></code> (lines ~1509-1530)</p></li>
</ul>
</li>
<li><p>[ ] 5.5 Simplify <code class="docutils literal notranslate"><span class="pre">process_one_work()</span></code> to single pipeline execution</p>
<ul class="simple">
<li><p>Remove <code class="docutils literal notranslate"><span class="pre">openalex_result</span></code> variable and conditional return (lines ~1509-1530)</p></li>
<li><p>Keep only <code class="docutils literal notranslate"><span class="pre">pipeline_result</span> <span class="pre">=</span> <span class="pre">pipeline.run(...)</span></code> logic</p></li>
<li><p>Remove <code class="docutils literal notranslate"><span class="pre">openalex_html_paths</span></code> aggregation logic (now handled by pipeline)</p></li>
<li><p>Remove <code class="docutils literal notranslate"><span class="pre">html_paths_total</span> <span class="pre">=</span> <span class="pre">list(artifact.metadata.get(&quot;openalex_html_paths&quot;,</span> <span class="pre">[]))</span></code> (line ~1532)</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">html_paths</span></code> to come solely from <code class="docutils literal notranslate"><span class="pre">pipeline_result.html_paths</span></code></p></li>
</ul>
</li>
<li><p>[ ] 5.6 Update tests to reflect OpenAlexResolver integration</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">tests/test_pipeline_behaviour.py</span></code>, add test verifying OpenAlex resolver executes first</p></li>
<li><p>Verify rate limiting applies to OpenAlex URLs</p></li>
<li><p>Verify metrics track OpenAlex attempts correctly</p></li>
</ul>
</li>
</ul>
</section>
<section id="head-based-content-filtering">
<h1>6. HEAD-Based Content Filtering<a class="headerlink" href="#head-based-content-filtering" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 6.1 Add <code class="docutils literal notranslate"><span class="pre">enable_head_precheck</span></code> field to <code class="docutils literal notranslate"><span class="pre">ResolverConfig</span></code> dataclass</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In resolvers/types.py, ResolverConfig class</span>
<span class="n">enable_head_precheck</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">resolver_head_precheck</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 6.2 Implement HEAD pre-check helper in <code class="docutils literal notranslate"><span class="pre">resolvers/pipeline.py</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_should_attempt_head_check</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">resolver_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine if HEAD pre-check should be performed for this resolver.&quot;&quot;&quot;</span>
    <span class="c1"># Resolver-specific override takes precedence</span>
    <span class="k">if</span> <span class="n">resolver_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resolver_head_precheck</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resolver_head_precheck</span><span class="p">[</span><span class="n">resolver_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_head_precheck</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_head_precheck_url</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if URL passes HEAD pre-check, False to skip.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.ContentDownload.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">request_with_retries</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
            <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">200</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">304</span><span class="p">}:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Skip obvious HTML or empty responses</span>
        <span class="k">if</span> <span class="s2">&quot;text/html&quot;</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">content_length</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># On HEAD failure, allow GET attempt anyway</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</li>
<li><p>[ ] 6.3 Integrate HEAD pre-check into pipeline URL iteration (in <code class="docutils literal notranslate"><span class="pre">ResolverPipeline.run()</span></code>)</p>
<ul class="simple">
<li><p>After <code class="docutils literal notranslate"><span class="pre">result.url</span></code> extraction (line ~756), add:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_attempt_head_check</span><span class="p">(</span><span class="n">resolver_name</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_head_precheck_url</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_timeout</span><span class="p">(</span><span class="n">resolver_name</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">AttemptRecord</span><span class="p">(</span>
                <span class="o">...</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;skipped&quot;</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;head-precheck-failed&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">record_skip</span><span class="p">(</span><span class="n">resolver_name</span><span class="p">,</span> <span class="s2">&quot;head-precheck-failed&quot;</span><span class="p">)</span>
        <span class="k">continue</span>
</pre></div>
</div>
</li>
<li><p>[ ] 6.4 Add HEAD pre-check tests in <code class="docutils literal notranslate"><span class="pre">tests/test_resolver_pipeline.py</span></code></p>
<ul class="simple">
<li><p>Test HEAD returning HTML content-type skips GET</p></li>
<li><p>Test HEAD returning zero content-length skips GET</p></li>
<li><p>Test HEAD returning 404 skips GET</p></li>
<li><p>Test HEAD returning 200 with PDF content-type allows GET</p></li>
<li><p>Test HEAD failure (timeout/error) still allows GET attempt</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">enable_head_precheck=False</span></code> disables all checks</p></li>
<li><p>Test resolver-specific override: <code class="docutils literal notranslate"><span class="pre">resolver_head_precheck:</span> <span class="pre">{wayback:</span> <span class="pre">false}</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="bounded-intra-work-concurrency">
<h1>7. Bounded Intra-Work Concurrency<a class="headerlink" href="#bounded-intra-work-concurrency" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 7.1 Add concurrency fields to <code class="docutils literal notranslate"><span class="pre">ResolverConfig</span></code> dataclass</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In resolvers/types.py</span>
<span class="n">max_concurrent_resolvers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Sequential by default</span>
</pre></div>
</div>
</li>
<li><p>[ ] 7.2 Add thread-safe rate limit tracking in <code class="docutils literal notranslate"><span class="pre">ResolverPipeline.__init__()</span></code></p>
<ul class="simple">
<li><p>Ensure <code class="docutils literal notranslate"><span class="pre">_last_invocation</span></code> dict and <code class="docutils literal notranslate"><span class="pre">_lock</span></code> are used for thread safety</p></li>
<li><p>Already present in current implementation; verify thread-safety annotations</p></li>
</ul>
</li>
<li><p>[ ] 7.3 Implement concurrent resolver execution in <code class="docutils literal notranslate"><span class="pre">ResolverPipeline.run()</span></code></p>
<ul class="simple">
<li><p>At start of method, check <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">self.config.max_concurrent_resolvers</span> <span class="pre">==</span> <span class="pre">1:</span></code> to use existing sequential path</p></li>
<li><p>For concurrent mode (<code class="docutils literal notranslate"><span class="pre">&gt;</span> <span class="pre">1</span></code>), implement:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>

<span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_concurrent_resolvers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="n">futures_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">order_index</span><span class="p">,</span> <span class="n">resolver_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resolver_order</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># ... existing is_enabled checks ...</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_resolver_task</span><span class="p">(</span><span class="n">res_name</span><span class="p">,</span> <span class="n">res_instance</span><span class="p">,</span> <span class="n">order_idx</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_respect_rate_limit</span><span class="p">(</span><span class="n">res_name</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">res_instance</span><span class="o">.</span><span class="n">iter_urls</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">artifact</span><span class="p">):</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">res_name</span><span class="p">,</span> <span class="n">order_idx</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_resolver_task</span><span class="p">,</span> <span class="n">resolver_name</span><span class="p">,</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">order_index</span><span class="p">)</span>
        <span class="n">futures_map</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resolver_name</span><span class="p">,</span> <span class="n">order_index</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures_map</span><span class="p">):</span>
        <span class="n">resolver_name</span><span class="p">,</span> <span class="n">order_index</span> <span class="o">=</span> <span class="n">futures_map</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">():</span>
            <span class="c1"># ... existing URL attempt logic ...</span>
            <span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">is_pdf</span><span class="p">:</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PipelineResult</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 7.4 Ensure thread-safe metrics recording</p>
<ul class="simple">
<li><p>Verify <code class="docutils literal notranslate"><span class="pre">ResolverMetrics</span></code> uses <code class="docutils literal notranslate"><span class="pre">Counter</span></code> which is thread-safe</p></li>
<li><p>Verify <code class="docutils literal notranslate"><span class="pre">self.logger.log()</span></code> calls are thread-safe (they are, since file writes use OS-level locks)</p></li>
</ul>
</li>
<li><p>[ ] 7.5 Add configuration validation</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In resolvers/types.py, add to ResolverConfig class</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate configuration fields and apply defaults.&quot;&quot;&quot;</span>

    <span class="c1"># Validate concurrency settings</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_resolvers</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;max_concurrent_resolvers must be &gt;= 1, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_resolvers</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_resolvers</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;max_concurrent_resolvers=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_resolvers</span><span class="si">}</span><span class="s2"> &gt; 10 may &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;violate rate limits. Ensure resolver_min_interval_s is configured &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;appropriately for all resolvers.&quot;</span><span class="p">,</span>
            <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

    <span class="c1"># Validate timeout values</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;timeout must be positive, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">resolver_name</span><span class="p">,</span> <span class="n">timeout_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolver_timeouts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">timeout_val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;resolver_timeouts[&#39;</span><span class="si">{</span><span class="n">resolver_name</span><span class="si">}</span><span class="s2">&#39;] must be positive, got </span><span class="si">{</span><span class="n">timeout_val</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Validate rate limit values</span>
    <span class="k">for</span> <span class="n">resolver_name</span><span class="p">,</span> <span class="n">interval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolver_min_interval_s</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">interval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;resolver_min_interval_s[&#39;</span><span class="si">{</span><span class="n">resolver_name</span><span class="si">}</span><span class="s2">&#39;] must be non-negative, got </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Apply legacy rate_limits if present</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolver_rate_limits</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolver_rate_limits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolver_min_interval_s</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># Validate max_attempts_per_work</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_attempts_per_work</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;max_attempts_per_work must be &gt;= 1, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_attempts_per_work</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 7.6 Add concurrent execution tests in <code class="docutils literal notranslate"><span class="pre">tests/test_bounded_concurrency.py</span></code></p>
<ul class="simple">
<li><p>Test <code class="docutils literal notranslate"><span class="pre">max_concurrent_resolvers=1</span></code> uses sequential path</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">max_concurrent_resolvers=3</span></code> executes up to 3 resolvers concurrently</p></li>
<li><p>Test rate limits are enforced despite concurrency</p></li>
<li><p>Test early-stop on first PDF cancels remaining futures</p></li>
<li><p>Test resolver failure doesn’t crash concurrent execution</p></li>
<li><p>Mock slow resolvers to verify wall-time improvement</p></li>
</ul>
</li>
</ul>
</section>
<section id="zenodo-resolver">
<h1>8. Zenodo Resolver<a class="headerlink" href="#zenodo-resolver" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 8.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/zenodo.py</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Zenodo repository resolver for DOI-indexed research outputs.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resolver</span><span class="p">,</span> <span class="n">ResolverConfig</span><span class="p">,</span> <span class="n">ResolverResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.ContentDownload.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">normalize_doi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.ContentDownload.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">request_with_retries</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ZenodoResolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resolver for Zenodo open access repository.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;zenodo&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ResolverConfig</span><span class="p">,</span> <span class="n">artifact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable when artifact has a DOI.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">artifact</span><span class="o">.</span><span class="n">doi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_urls</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ResolverConfig</span><span class="p">,</span> <span class="n">artifact</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ResolverResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query Zenodo API by DOI and yield PDF file URLs.&quot;&quot;&quot;</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="n">normalize_doi</span><span class="p">(</span><span class="n">artifact</span><span class="o">.</span><span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">doi</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s2">&quot;skipped&quot;</span><span class="p">,</span> <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;no-doi&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
                <span class="n">session</span><span class="p">,</span>
                <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://zenodo.org/api/records/&quot;</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;doi:&quot;</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="s2">&quot;mostrecent&quot;</span><span class="p">},</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get_timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">polite_headers</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;request-error&quot;</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)},</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;http-error&quot;</span><span class="p">,</span>
                <span class="n">http_status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;json-error&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hits&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hits&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">for</span> <span class="n">file_entry</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">file_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">file_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">file_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">file_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;pdf&quot;</span> <span class="ow">or</span> <span class="n">file_key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">):</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">file_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;zenodo&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;record_id&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
                                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">file_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">),</span>
                            <span class="p">},</span>
                        <span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 8.2 Add Zenodo to resolver registry</p>
<ul class="simple">
<li><p>Import <code class="docutils literal notranslate"><span class="pre">ZenodoResolver</span></code> in <code class="docutils literal notranslate"><span class="pre">resolvers/providers/__init__.py</span></code></p></li>
<li><p>Insert in <code class="docutils literal notranslate"><span class="pre">default_resolvers()</span></code> after <code class="docutils literal notranslate"><span class="pre">CoreResolver</span></code>, before <code class="docutils literal notranslate"><span class="pre">DoajResolver</span></code></p></li>
</ul>
</li>
<li><p>[ ] 8.3 Update <code class="docutils literal notranslate"><span class="pre">DEFAULT_RESOLVER_ORDER</span></code> constant</p>
<ul class="simple">
<li><p>Insert <code class="docutils literal notranslate"><span class="pre">&quot;zenodo&quot;</span></code> after <code class="docutils literal notranslate"><span class="pre">&quot;core&quot;</span></code> in list</p></li>
</ul>
</li>
<li><p>[ ] 8.4 Add Zenodo resolver tests in <code class="docutils literal notranslate"><span class="pre">tests/test_zenodo_resolver.py</span></code></p>
<ul class="simple">
<li><p>Test DOI query with successful response containing PDF file</p></li>
<li><p>Test DOI query with multiple files, filter to PDF only</p></li>
<li><p>Test DOI query with no matches (empty hits)</p></li>
<li><p>Test DOI query with HTTP 404</p></li>
<li><p>Test DOI query with malformed JSON</p></li>
<li><p>Test DOI query with network error</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">responses</span></code> library for mock HTTP fixtures</p></li>
</ul>
</li>
<li><p>[ ] 8.5 Add test fixture for Zenodo API response</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create tests/data/zenodo_response_sample.json</span>
<span class="p">{</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;1234567&quot;</span><span class="p">,</span>
        <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="s2">&quot;10.5281/zenodo.1234567&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Sample Research Data&quot;</span><span class="p">,</span>
          <span class="s2">&quot;publication_date&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-15&quot;</span><span class="p">,</span>
          <span class="s2">&quot;creators&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Researcher, Jane&quot;</span><span class="p">}]</span>
        <span class="p">},</span>
        <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;dataset.csv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">1048576</span><span class="p">,</span>
            <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="s2">&quot;https://zenodo.org/api/files/abc123/dataset.csv&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;paper.pdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">524288</span><span class="p">,</span>
            <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="s2">&quot;https://zenodo.org/api/files/abc123/paper.pdf&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;figures.zip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;zip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">2097152</span><span class="p">,</span>
            <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="s2">&quot;https://zenodo.org/api/files/abc123/figures.zip&quot;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Also create tests/data/zenodo_response_no_pdf.json for edge case</span>
<span class="p">{</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;7654321&quot;</span><span class="p">,</span>
        <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="s2">&quot;10.5281/zenodo.7654321&quot;</span><span class="p">,</span>
        <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;data.csv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="s2">&quot;https://zenodo.org/api/files/xyz/data.csv&quot;</span><span class="p">}</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Also create tests/data/zenodo_response_empty.json</span>
<span class="p">{</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="figshare-resolver">
<h1>9. Figshare Resolver<a class="headerlink" href="#figshare-resolver" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 9.1 Create <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/ContentDownload/resolvers/providers/figshare.py</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Figshare repository resolver for DOI-indexed research outputs.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resolver</span><span class="p">,</span> <span class="n">ResolverConfig</span><span class="p">,</span> <span class="n">ResolverResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.ContentDownload.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">normalize_doi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DocsToKG.ContentDownload.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">request_with_retries</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FigshareResolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resolver for Figshare repository.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;figshare&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ResolverConfig</span><span class="p">,</span> <span class="n">artifact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable when artifact has a DOI.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">artifact</span><span class="o">.</span><span class="n">doi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_urls</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ResolverConfig</span><span class="p">,</span> <span class="n">artifact</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ResolverResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search Figshare API by DOI and yield PDF file URLs.&quot;&quot;&quot;</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="n">normalize_doi</span><span class="p">(</span><span class="n">artifact</span><span class="o">.</span><span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">doi</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s2">&quot;skipped&quot;</span><span class="p">,</span> <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;no-doi&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
                <span class="n">session</span><span class="p">,</span>
                <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://api.figshare.com/v2/articles/search&quot;</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;search_for&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;:doi: &quot;</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;page_size&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get_timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">polite_headers</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;request-error&quot;</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)},</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;http-error&quot;</span><span class="p">,</span>
                <span class="n">http_status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">articles</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;json-error&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file_entry</span> <span class="ow">in</span> <span class="n">article</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="n">file_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">download_url</span> <span class="o">=</span> <span class="n">file_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_url&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">download_url</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">download_url</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;figshare&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;article_id&quot;</span><span class="p">:</span> <span class="n">article</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">file_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 9.2 Add Figshare to resolver registry</p>
<ul class="simple">
<li><p>Import <code class="docutils literal notranslate"><span class="pre">FigshareResolver</span></code> in <code class="docutils literal notranslate"><span class="pre">resolvers/providers/__init__.py</span></code></p></li>
<li><p>Insert in <code class="docutils literal notranslate"><span class="pre">default_resolvers()</span></code> after <code class="docutils literal notranslate"><span class="pre">ZenodoResolver</span></code>, before <code class="docutils literal notranslate"><span class="pre">DoajResolver</span></code></p></li>
</ul>
</li>
<li><p>[ ] 9.3 Update <code class="docutils literal notranslate"><span class="pre">DEFAULT_RESOLVER_ORDER</span></code> constant</p>
<ul class="simple">
<li><p>Insert <code class="docutils literal notranslate"><span class="pre">&quot;figshare&quot;</span></code> after <code class="docutils literal notranslate"><span class="pre">&quot;zenodo&quot;</span></code> in list</p></li>
</ul>
</li>
<li><p>[ ] 9.4 Add Figshare resolver tests in <code class="docutils literal notranslate"><span class="pre">tests/test_figshare_resolver.py</span></code></p>
<ul class="simple">
<li><p>Test DOI search with successful response containing PDF file</p></li>
<li><p>Test DOI search with multiple files, filter to PDF only</p></li>
<li><p>Test DOI search with no matches (empty array)</p></li>
<li><p>Test DOI search with HTTP 404</p></li>
<li><p>Test DOI search with malformed JSON</p></li>
<li><p>Test DOI search with network error</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">responses</span></code> library for mock HTTP fixtures</p></li>
</ul>
</li>
<li><p>[ ] 9.5 Add test fixture for Figshare API response</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create tests/data/figshare_response_sample.json</span>
<span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">123456</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Research Article Dataset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="s2">&quot;10.6084/m9.figshare.123456&quot;</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://figshare.com/articles/dataset/123456&quot;</span><span class="p">,</span>
    <span class="s2">&quot;published_date&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-20T10:30:00Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">45678</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;manuscript.pdf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">1048576</span><span class="p">,</span>
        <span class="s2">&quot;is_link_only&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;download_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://figshare.com/ndownloader/files/45678&quot;</span><span class="p">,</span>
        <span class="s2">&quot;computed_md5&quot;</span><span class="p">:</span> <span class="s2">&quot;abc123def456&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">45679</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;supplementary_data.xlsx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">524288</span><span class="p">,</span>
        <span class="s2">&quot;download_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://figshare.com/ndownloader/files/45679&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">45680</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;figures.pptx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">2097152</span><span class="p">,</span>
        <span class="s2">&quot;download_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://figshare.com/ndownloader/files/45680&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># Also create tests/data/figshare_response_no_pdf.json</span>
<span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">654321</span><span class="p">,</span>
    <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="s2">&quot;10.6084/m9.figshare.654321&quot;</span><span class="p">,</span>
    <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">99999</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;dataset.csv&quot;</span><span class="p">,</span>
        <span class="s2">&quot;download_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://figshare.com/ndownloader/files/99999&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># Also create tests/data/figshare_response_empty.json</span>
<span class="p">[]</span>

<span class="c1"># Also create tests/data/figshare_response_multiple_pdf.json</span>
<span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">111111</span><span class="p">,</span>
    <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;main_article.pdf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;download_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://figshare.com/ndownloader/files/1&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;supplementary.pdf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;download_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://figshare.com/ndownloader/files/2&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="downloadoutcome-completeness">
<h1>10. DownloadOutcome Completeness<a class="headerlink" href="#downloadoutcome-completeness" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>[ ] 10.1 Audit <code class="docutils literal notranslate"><span class="pre">download_candidate()</span></code> for outcome completeness</p>
<ul>
<li><p>Verify 304 cached path (line ~989) populates all fields: <code class="docutils literal notranslate"><span class="pre">sha256</span></code>, <code class="docutils literal notranslate"><span class="pre">content_length</span></code>, <code class="docutils literal notranslate"><span class="pre">etag</span></code>, <code class="docutils literal notranslate"><span class="pre">last_modified</span></code></p></li>
<li><p>Verify HTTP error path (line ~1002) sets fields to <code class="docutils literal notranslate"><span class="pre">None</span></code> explicitly</p></li>
<li><p>Verify PDF/HTML success path (line ~1114) populates all fields</p></li>
<li><p>Verify dry-run path (line ~1060) populates available fields or <code class="docutils literal notranslate"><span class="pre">None</span></code></p></li>
</ul>
</li>
<li><p>[ ] 10.2 Standardize <code class="docutils literal notranslate"><span class="pre">None</span></code> vs missing field handling</p>
<ul>
<li><p>In <code class="docutils literal notranslate"><span class="pre">_build_download_outcome()</span></code> (line ~694), ensure all optional fields default to <code class="docutils literal notranslate"><span class="pre">None</span></code> rather than being omitted</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">DownloadOutcome</span></code> dataclass initialization defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code> explicitly</p></li>
</ul>
</li>
<li><p>[ ] 10.3 Audit <code class="docutils literal notranslate"><span class="pre">build_manifest_entry()</span></code> for completeness</p>
<ul>
<li><p>Verify function at line ~526 extracts all <code class="docutils literal notranslate"><span class="pre">DownloadOutcome</span></code> fields</p></li>
<li><p>Ensure <code class="docutils literal notranslate"><span class="pre">ManifestEntry</span></code> includes all fields: <code class="docutils literal notranslate"><span class="pre">sha256</span></code>, <code class="docutils literal notranslate"><span class="pre">content_length</span></code>, <code class="docutils literal notranslate"><span class="pre">etag</span></code>, <code class="docutils literal notranslate"><span class="pre">last_modified</span></code>, <code class="docutils literal notranslate"><span class="pre">extracted_text_path</span></code></p></li>
</ul>
</li>
<li><p>[ ] 10.4 Add validation tests in <code class="docutils literal notranslate"><span class="pre">tests/test_download_outcomes.py</span></code></p>
<ul>
<li><p>Test successful download has all metadata fields populated</p></li>
<li><p>Test 304 cached response has all prior metadata fields</p></li>
<li><p>Test HTTP error response has explicit <code class="docutils literal notranslate"><span class="pre">None</span></code> for unavailable fields</p></li>
<li><p>Test HTML download with text extraction has <code class="docutils literal notranslate"><span class="pre">extracted_text_path</span></code> populated</p></li>
<li><p>Test dry-run mode has correct field availability</p></li>
</ul>
</li>
</ul>
</section>
<section id="extended-logging-and-observability">
<h1>11. Extended Logging and Observability<a class="headerlink" href="#extended-logging-and-observability" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 11.1 Add <code class="docutils literal notranslate"><span class="pre">resolver_wall_time_ms</span></code> field to <code class="docutils literal notranslate"><span class="pre">AttemptRecord</span></code> dataclass</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In resolvers/types.py, AttemptRecord</span>
<span class="n">resolver_wall_time_ms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</li>
<li><p>[ ] 11.2 Track resolver wall time in <code class="docutils literal notranslate"><span class="pre">ResolverPipeline.run()</span></code></p>
<ul class="simple">
<li><p>Before <code class="docutils literal notranslate"><span class="pre">_respect_rate_limit()</span></code> call, capture start time: <code class="docutils literal notranslate"><span class="pre">resolver_start</span> <span class="pre">=</span> <span class="pre">time.monotonic()</span></code></p></li>
<li><p>After all URLs from resolver attempted, compute: <code class="docutils literal notranslate"><span class="pre">resolver_wall</span> <span class="pre">=</span> <span class="pre">(time.monotonic()</span> <span class="pre">-</span> <span class="pre">resolver_start)</span> <span class="pre">*</span> <span class="pre">1000.0</span></code></p></li>
<li><p>Pass <code class="docutils literal notranslate"><span class="pre">resolver_wall_time_ms=resolver_wall</span></code> to relevant <code class="docutils literal notranslate"><span class="pre">AttemptRecord</span></code> instances</p></li>
</ul>
</li>
<li><p>[ ] 11.3 Update JSONL logger to include new field</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">JsonlSink.log_attempt()</span></code> method (line ~262 of <code class="docutils literal notranslate"><span class="pre">download_pyalex_pdfs.py</span></code>), add <code class="docutils literal notranslate"><span class="pre">&quot;resolver_wall_time_ms&quot;</span></code> to output dict</p></li>
</ul>
</li>
<li><p>[ ] 11.4 Update CSV logger adapter to include new field</p>
<ul class="simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">&quot;resolver_wall_time_ms&quot;</span></code> to <code class="docutils literal notranslate"><span class="pre">CsvAttemptLoggerAdapter.HEADER</span></code> list (line ~380)</p></li>
<li><p>Add field to <code class="docutils literal notranslate"><span class="pre">_writer.writerow()</span></code> dict (line ~417)</p></li>
</ul>
</li>
<li><p>[ ] 11.5 Add logging tests in <code class="docutils literal notranslate"><span class="pre">tests/test_structured_logging.py</span></code></p>
<ul class="simple">
<li><p>Test attempt record includes <code class="docutils literal notranslate"><span class="pre">resolver_wall_time_ms</span></code> when resolver completes</p></li>
<li><p>Test CSV export includes new column</p></li>
<li><p>Test JSONL export includes new field</p></li>
</ul>
</li>
</ul>
</section>
<section id="configuration-enhancements">
<h1>12. Configuration Enhancements<a class="headerlink" href="#configuration-enhancements" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 12.1 Document new configuration options in <code class="docutils literal notranslate"><span class="pre">ResolverConfig</span></code> docstring</p>
<ul class="simple">
<li><p>Add description for <code class="docutils literal notranslate"><span class="pre">enable_head_precheck</span></code></p></li>
<li><p>Add description for <code class="docutils literal notranslate"><span class="pre">resolver_head_precheck</span></code> per-resolver override</p></li>
<li><p>Add description for <code class="docutils literal notranslate"><span class="pre">max_concurrent_resolvers</span></code></p></li>
</ul>
</li>
<li><p>[ ] 12.2 Add configuration examples to documentation</p>
<ul class="simple">
<li><p>Create <code class="docutils literal notranslate"><span class="pre">docs/resolver-configuration.md</span></code> with YAML examples</p></li>
<li><p>Include example enabling bounded concurrency:</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">max_concurrent_resolvers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="nt">resolver_min_interval_s</span><span class="p">:</span>
<span class="w">  </span><span class="nt">unpaywall</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="w">  </span><span class="nt">crossref</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Include example disabling HEAD pre-check for specific resolvers:</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">enable_head_precheck</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">resolver_head_precheck</span><span class="p">:</span>
<span class="w">  </span><span class="nt">wayback</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
</li>
<li><p>[ ] 12.3 Add CLI help for new options (if exposed)</p>
<ul class="simple">
<li><p>Currently config is file-based; document in README</p></li>
</ul>
</li>
</ul>
</section>
<section id="integration-testing">
<h1>13. Integration Testing<a class="headerlink" href="#integration-testing" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>[ ] 13.1 Create comprehensive pipeline integration test in <code class="docutils literal notranslate"><span class="pre">tests/test_full_pipeline_integration.py</span></code></p>
<ul>
<li><p>Mock OpenAlex work metadata with DOI, PMCID, arXiv ID</p></li>
<li><p>Mock responses for all resolver types (Unpaywall, Crossref, PMC, Zenodo, Figshare, etc.)</p></li>
<li><p>Verify resolver order: OpenAlex → Unpaywall → … → Zenodo → Figshare → … → Wayback</p></li>
<li><p>Verify early-stop on first PDF success</p></li>
<li><p>Verify rate limiting enforced</p></li>
<li><p>Verify metrics aggregation correct</p></li>
</ul>
</li>
<li><p>[ ] 13.2 Add end-to-end test with real network calls (marked as integration)</p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">pytest.mark.integration</span></code> decorator</p></li>
<li><p>Test downloading a known open-access DOI (e.g., “10.1371/journal.pone.0000001”)</p></li>
<li><p>Verify PDF downloaded successfully</p></li>
<li><p>Verify manifest entry contains all metadata fields</p></li>
</ul>
</li>
<li><p>[ ] 13.3 Add performance benchmark test</p>
<ul>
<li><p>Create <code class="docutils literal notranslate"><span class="pre">tests/benchmarks/test_resolver_performance.py</span></code></p></li>
<li><p>Benchmark sequential vs concurrent resolver execution (mock resolvers with sleep)</p></li>
<li><p>Verify concurrent mode reduces wall time by expected factor</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">pytest-benchmark</span></code> plugin for structured results</p></li>
</ul>
</li>
</ul>
</section>
<section id="migration-and-compatibility">
<h1>14. Migration and Compatibility<a class="headerlink" href="#migration-and-compatibility" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>[ ] 14.1 Create migration guide in <code class="docutils literal notranslate"><span class="pre">docs/migration-modularize-resolvers.md</span></code></p>
<ul>
<li><p>Document old import paths: <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">DocsToKG.ContentDownload.resolvers</span> <span class="pre">import</span> <span class="pre">ResolverPipeline</span></code></p></li>
<li><p>Document new import paths (recommended): <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">DocsToKG.ContentDownload.resolvers.pipeline</span> <span class="pre">import</span> <span class="pre">ResolverPipeline</span></code></p></li>
<li><p>Note that old paths continue working via re-exports</p></li>
<li><p>List new configuration options and defaults</p></li>
</ul>
</li>
<li><p>[ ] 14.2 Add deprecation warnings for internal APIs (if any are exposed)</p>
<ul>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">warnings.warn()</span></code> for any deprecated internal functions</p></li>
<li><p>Document in CHANGELOG.md</p></li>
</ul>
</li>
<li><p>[ ] 14.3 Verify backward compatibility with existing tests</p>
<ul>
<li><p>Run full test suite: <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">tests/</span></code></p></li>
<li><p>Ensure all existing tests pass without modification</p></li>
<li><p>Ensure no new import errors</p></li>
</ul>
</li>
</ul>
</section>
<section id="documentation">
<h1>15. Documentation<a class="headerlink" href="#documentation" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 15.1 Update main README.md</p>
<ul class="simple">
<li><p>Add section on new Zenodo and Figshare resolver support</p></li>
<li><p>Document bounded concurrency option</p></li>
<li><p>Document HEAD pre-check optimization</p></li>
</ul>
</li>
<li><p>[ ] 15.2 Create developer guide for adding custom resolvers</p>
<ul class="simple">
<li><p>Create <code class="docutils literal notranslate"><span class="pre">docs/adding-custom-resolvers.md</span></code></p></li>
<li><p>Provide resolver template:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyResolver</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;my_resolver&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">artifact</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># or conditional logic</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">artifact</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://example.org/file.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Document registration process in <code class="docutils literal notranslate"><span class="pre">providers/__init__.py</span></code></p></li>
<li><p>Document configuration options (timeouts, rate limits, toggles)</p></li>
</ul>
</li>
<li><p>[ ] 15.3 Update API documentation</p>
<ul class="simple">
<li><p>Regenerate Sphinx/MkDocs API docs if applicable</p></li>
<li><p>Ensure new modules appear in documentation</p></li>
</ul>
</li>
<li><p>[ ] 15.4 Create architecture diagram</p>
<ul class="simple">
<li><p>Visualize resolver pipeline flow: Work → Pipeline → Resolvers → Download → Outcome</p></li>
<li><p>Show modular structure: <code class="docutils literal notranslate"><span class="pre">pipeline.py</span></code>, <code class="docutils literal notranslate"><span class="pre">types.py</span></code>, <code class="docutils literal notranslate"><span class="pre">providers/*</span></code></p></li>
<li><p>Include in <code class="docutils literal notranslate"><span class="pre">docs/architecture.md</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="testing-coverage">
<h1>16. Testing Coverage<a class="headerlink" href="#testing-coverage" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>[ ] 16.1 Achieve 95%+ branch coverage for new modules</p>
<ul>
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">--cov=src/DocsToKG/ContentDownload/http</span> <span class="pre">--cov-report=html</span></code></p></li>
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">--cov=src/DocsToKG/ContentDownload/conditional</span> <span class="pre">--cov-report=html</span></code></p></li>
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">--cov=src/DocsToKG/ContentDownload/resolvers</span> <span class="pre">--cov-report=html</span></code></p></li>
<li><p>Review HTML report and add tests for uncovered branches</p></li>
</ul>
</li>
<li><p>[ ] 16.2 Add missing edge case tests</p>
<ul>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">Retry-After</span></code> with date format (currently only integer tested)</p></li>
<li><p>Test HEAD pre-check with redirects (302 → 200)</p></li>
<li><p>Test concurrent execution with resolver exception handling</p></li>
<li><p>Test Zenodo/Figshare pagination (if implemented)</p></li>
</ul>
</li>
<li><p>[ ] 16.3 Add property-based tests with <code class="docutils literal notranslate"><span class="pre">hypothesis</span></code></p>
<ul>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">ConditionalRequestHelper</span></code> with arbitrary ETag/Last-Modified values</p></li>
<li><p>Test <code class="docutils literal notranslate"><span class="pre">request_with_retries</span></code> backoff timing properties</p></li>
<li><p>Test dedupe utility with various input sequences</p></li>
</ul>
</li>
</ul>
</section>
<section id="cleanup-and-finalization">
<h1>17. Cleanup and Finalization<a class="headerlink" href="#cleanup-and-finalization" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>[ ] 17.1 Remove unused code from <code class="docutils literal notranslate"><span class="pre">download_pyalex_pdfs.py</span></code></p>
<ul>
<li><p>Remove <code class="docutils literal notranslate"><span class="pre">attempt_openalex_candidates()</span></code> function (replaced by OpenAlexResolver)</p></li>
<li><p>Remove any dead code paths from refactoring</p></li>
</ul>
</li>
<li><p>[ ] 17.2 Run linters and formatters</p>
<ul>
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">black</span> <span class="pre">src/DocsToKG/ContentDownload/</span></code></p></li>
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">isort</span> <span class="pre">src/DocsToKG/ContentDownload/</span></code></p></li>
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">mypy</span> <span class="pre">src/DocsToKG/ContentDownload/</span></code> (if type checking enabled)</p></li>
<li><p>Fix any linter errors or warnings</p></li>
</ul>
</li>
<li><p>[ ] 17.3 Update CHANGELOG.md</p>
<ul>
<li><p>Add entry for modularization changes</p></li>
<li><p>List new features: Zenodo, Figshare, bounded concurrency, HEAD pre-check</p></li>
<li><p>Note backward compatibility maintained</p></li>
</ul>
</li>
<li><p>[ ] 17.4 Verify all tasks complete and tests pass</p>
<ul>
<li><p>Run full test suite: <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">tests/</span></code></p></li>
<li><p>Verify no regressions</p></li>
<li><p>Verify new features work as expected</p></li>
</ul>
</li>
<li><p>[ ] 17.5 Create summary of changes for pull request</p>
<ul>
<li><p>List files created (13 new provider modules, 3 new utility modules)</p></li>
<li><p>List files modified (download_pyalex_pdfs.py, tests)</p></li>
<li><p>Document test coverage metrics</p></li>
<li><p>Include performance benchmarks (wall-time improvements)</p></li>
</ul>
</li>
</ul>
</section>
<section id="error-handling-patterns-critical-for-robustness">
<h1>18. Error Handling Patterns (CRITICAL FOR ROBUSTNESS)<a class="headerlink" href="#error-handling-patterns-critical-for-robustness" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 18.1 Add explicit error handling to HTTP retry module</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In http.py, add logging for retry attempts</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;DocsToKG.ContentDownload.http&quot;</span><span class="p">)</span>

<span class="c1"># Inside request_with_retries():</span>
<span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Request </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> failed (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">last_exception</span> <span class="o">=</span> <span class="n">exc</span>
    <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;=</span> <span class="n">max_retries</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Exhausted </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> retries for </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span>
</pre></div>
</div>
</li>
<li><p>[ ] 18.2 Add error handling to ConditionalRequestHelper</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In conditional.py, add validation</span>
<span class="k">def</span><span class="w"> </span><span class="nf">interpret_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">304</span><span class="p">:</span>
        <span class="c1"># Validate we have complete prior metadata</span>
        <span class="n">missing_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_path</span><span class="p">:</span>
            <span class="n">missing_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_sha256</span><span class="p">:</span>
            <span class="n">missing_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sha256&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_content_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">missing_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;content_length&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;HTTP 304 requires complete prior metadata. Missing: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_fields</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;This indicates a bug in manifest loading or caching logic.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">CachedResult</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ModifiedResult</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 18.3 Add error handling to all resolver providers</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pattern to apply in each resolver&#39;s iter_urls() method</span>
<span class="k">def</span><span class="w"> </span><span class="nf">iter_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">artifact</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># API call logic</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;http-error&quot;</span><span class="p">,</span>
                <span class="n">http_status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error_detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;API returned </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">json_err</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;json-error&quot;</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error_detail&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_err</span><span class="p">),</span> <span class="s2">&quot;content_preview&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]}</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Process data...</span>

    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">timeout_err</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get_timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeout_err</span><span class="p">)}</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">conn_err</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;connection-error&quot;</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">conn_err</span><span class="p">)}</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">unexpected_err</span><span class="p">:</span>
        <span class="c1"># Log unexpected errors but don&#39;t crash pipeline</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> resolver&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="n">event_reason</span><span class="o">=</span><span class="s2">&quot;unexpected-error&quot;</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">unexpected_err</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">unexpected_err</span><span class="p">)}</span>
        <span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 18.4 Add error recovery for malformed API responses</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In each resolver, add defensive checks</span>
<span class="k">def</span><span class="w"> </span><span class="nf">iter_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">artifact</span><span class="p">):</span>
    <span class="c1"># ... after getting JSON data ...</span>

    <span class="c1"># Zenodo example:</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hits&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hits</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zenodo API returned malformed hits (expected dict, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">hits_list</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hits&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hits_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zenodo API returned malformed hits.hits (expected list, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hits_list</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">hits_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping malformed Zenodo record: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping record with malformed files field&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">file_entry</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_entry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">file_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 18.5 Add timeout specifications for all HTTP operations</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Document timeouts in each resolver</span>
<span class="c1"># Default: config.get_timeout(self.name) which defaults to 30s</span>
<span class="c1"># HEAD requests: min(timeout, 5.0) for fast pre-checks</span>
<span class="c1"># API requests: full timeout (30s)</span>
<span class="c1"># Download GET requests: full timeout (30s) but stream=True prevents timeout on large files</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="thread-safety-documentation-critical-for-concurrency">
<h1>19. Thread-Safety Documentation (CRITICAL FOR CONCURRENCY)<a class="headerlink" href="#thread-safety-documentation-critical-for-concurrency" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 19.1 Document all shared state in ResolverPipeline</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In resolvers/pipeline.py, add class-level docstring</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ResolverPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Orchestrates resolver execution with rate limiting and metrics.</span>

<span class="sd">    Thread Safety:</span>
<span class="sd">        This class is designed for concurrent execution when max_concurrent_resolvers &gt; 1.</span>
<span class="sd">        Thread-safe components:</span>
<span class="sd">        - _last_invocation: Protected by _lock</span>
<span class="sd">        - _lock: threading.Lock ensures atomic rate-limit tracking</span>
<span class="sd">        - metrics: ResolverMetrics uses thread-safe Counter internally</span>
<span class="sd">        - logger: File writes are atomic at OS level</span>

<span class="sd">        Thread-unsafe components (avoid concurrent modification):</span>
<span class="sd">        - config: Read-only after initialization, safe for concurrent reads</span>
<span class="sd">        - _resolver_map: Read-only after initialization, safe for concurrent reads</span>

<span class="sd">        Session sharing:</span>
<span class="sd">        - requests.Session is thread-safe for reads (concurrent GET/HEAD)</span>
<span class="sd">        - Session write methods (e.g., mount, headers update) must not be called concurrently</span>
<span class="sd">        - Worker threads receive pre-configured session, no writes performed</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
</li>
<li><p>[ ] 19.2 Add explicit lock patterns for rate limiting</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In ResolverPipeline._respect_rate_limit()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_respect_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enforce minimum interval between resolver calls (thread-safe).</span>

<span class="sd">    Thread Safety:</span>
<span class="sd">        Uses self._lock to ensure atomic read-modify-write of _last_invocation.</span>
<span class="sd">        Multiple threads may wait on the same resolver; lock ensures only one</span>
<span class="sd">        proceeds at minimum interval.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resolver_min_interval_s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resolver_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">limit</span><span class="p">:</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resolver_rate_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resolver_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">limit</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">wait</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>  <span class="c1"># CRITICAL: Atomic read-modify-write</span>
        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_invocation</span><span class="p">[</span><span class="n">resolver_name</span><span class="p">]</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">wait</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">-</span> <span class="n">delta</span>
        <span class="c1"># Reserve next slot immediately while holding lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_invocation</span><span class="p">[</span><span class="n">resolver_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">wait</span>

    <span class="k">if</span> <span class="n">wait</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>[ ] 19.3 Add thread-safety tests for concurrent resolver execution</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In tests/test_bounded_concurrency.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limit_enforced_concurrently</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify rate limits enforced with multiple concurrent threads.&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">ResolverConfig</span><span class="p">(</span>
        <span class="n">max_concurrent_resolvers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">resolver_min_interval_s</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;test_resolver&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Track invocation times</span>
    <span class="n">invocations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">TimingResolver</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;test_resolver&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">is_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">artifact</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">iter_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">artifact</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">invocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">())</span>
            <span class="k">yield</span> <span class="n">ResolverResult</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://example.org/test.pdf&quot;</span><span class="p">)</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ResolverPipeline</span><span class="p">([</span><span class="n">TimingResolver</span><span class="p">()],</span> <span class="n">config</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

    <span class="c1"># Run 10 works concurrently (should enforce 0.5s interval)</span>
    <span class="n">works</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_mock_work</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;W</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">work</span><span class="p">)</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">works</span><span class="p">]</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>

    <span class="c1"># Verify minimum intervals</span>
    <span class="n">sorted_times</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">invocations</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_times</span><span class="p">)):</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">sorted_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">sorted_times</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">interval</span> <span class="o">&gt;=</span> <span class="mf">0.49</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Interval </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2"> &lt; 0.5s between invocations </span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</li>
<li><p>[ ] 19.4 Document session thread-safety requirements</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In download_pyalex_pdfs.py, _make_session() docstring</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_make_session</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a retry-enabled requests.Session for polite crawling.</span>

<span class="sd">    Thread Safety:</span>
<span class="sd">        The returned session is thread-safe for concurrent requests (GET/HEAD)</span>
<span class="sd">        but NOT for configuration changes. Do not call session.mount(),</span>
<span class="sd">        session.headers.update(), or session.close() from multiple threads.</span>

<span class="sd">        Usage Pattern:</span>
<span class="sd">        - Sequential mode: One session shared across works</span>
<span class="sd">        - Concurrent mode: One session per worker thread (created in worker)</span>

<span class="sd">        The HTTPAdapter with connection pooling is thread-safe and manages</span>
<span class="sd">        connection reuse across concurrent requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="performance-benchmarking-verification-of-improvements">
<h1>20. Performance Benchmarking (VERIFICATION OF IMPROVEMENTS)<a class="headerlink" href="#performance-benchmarking-verification-of-improvements" title="Link to this heading"></a></h1>
<ul>
<li><p>[ ] 20.1 Create benchmark suite in <code class="docutils literal notranslate"><span class="pre">tests/benchmarks/test_resolver_performance.py</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">benchmark</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_sequential_vs_concurrent_execution</span><span class="p">(</span><span class="n">benchmark</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Benchmark wall-time improvement from concurrent execution.&quot;&quot;&quot;</span>
    <span class="c1"># Setup: 10 slow resolvers (0.5s each)</span>
    <span class="n">resolvers</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_slow_resolver</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resolver_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>

    <span class="c1"># Sequential config</span>
    <span class="n">config_seq</span> <span class="o">=</span> <span class="n">ResolverConfig</span><span class="p">(</span><span class="n">max_concurrent_resolvers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pipeline_seq</span> <span class="o">=</span> <span class="n">ResolverPipeline</span><span class="p">(</span><span class="n">resolvers</span><span class="p">,</span> <span class="n">config_seq</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

    <span class="c1"># Concurrent config</span>
    <span class="n">config_conc</span> <span class="o">=</span> <span class="n">ResolverConfig</span><span class="p">(</span><span class="n">max_concurrent_resolvers</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pipeline_conc</span> <span class="o">=</span> <span class="n">ResolverPipeline</span><span class="p">(</span><span class="n">resolvers</span><span class="p">,</span> <span class="n">config_conc</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

    <span class="n">work</span> <span class="o">=</span> <span class="n">create_mock_work</span><span class="p">(</span><span class="s2">&quot;W123&quot;</span><span class="p">)</span>

    <span class="c1"># Benchmark sequential</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_sequential</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">pipeline_seq</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">mock_session</span><span class="p">(),</span> <span class="n">work</span><span class="p">)</span>

    <span class="c1"># Benchmark concurrent</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_concurrent</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">pipeline_conc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">mock_session</span><span class="p">(),</span> <span class="n">work</span><span class="p">)</span>

    <span class="c1"># Run benchmarks</span>
    <span class="n">result_seq</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">(</span><span class="n">run_sequential</span><span class="p">)</span>
    <span class="n">result_conc</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">(</span><span class="n">run_concurrent</span><span class="p">)</span>

    <span class="c1"># Verify concurrency provides speedup</span>
    <span class="c1"># Sequential: 10 resolvers × 0.5s = ~5s</span>
    <span class="c1"># Concurrent (3 workers): ~2s (ceil(10/3) × 0.5s)</span>
    <span class="c1"># Allow 20% overhead for thread coordination</span>
    <span class="k">assert</span> <span class="n">result_seq</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">result_conc</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">*</span> <span class="mf">2.0</span>
</pre></div>
</div>
</li>
<li><p>[ ] 20.2 Add HEAD pre-check performance benchmark</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">benchmark</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_head_precheck_overhead_vs_savings</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Measure HEAD pre-check overhead vs savings from filtered GETs.&quot;&quot;&quot;</span>
    <span class="c1"># Scenario: 100 URLs, 15% are HTML (wasted without HEAD check)</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;https://example.org/paper</span><span class="si">{}</span><span class="s2">.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;application/pdf&quot;</span><span class="p">,</span> <span class="mi">1048576</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">85</span><span class="p">)</span>
    <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;https://example.org/landing</span><span class="si">{}</span><span class="s2">.html&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;text/html&quot;</span><span class="p">,</span> <span class="mi">8192</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Without HEAD pre-check: All 100 URLs download</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">mock_download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>  <span class="c1"># Simulates full GET</span>
    <span class="n">no_precheck_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="c1"># With HEAD pre-check: 100 HEADs + 85 GETs</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">head_result</span> <span class="o">=</span> <span class="n">mock_head</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span>  <span class="c1"># Fast HEAD</span>
        <span class="k">if</span> <span class="s2">&quot;html&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">head_result</span><span class="p">:</span>
            <span class="n">mock_download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>  <span class="c1"># Only download non-HTML</span>
    <span class="n">precheck_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="c1"># HEAD check should save time by avoiding 15 large HTML downloads</span>
    <span class="k">assert</span> <span class="n">precheck_time</span> <span class="o">&lt;</span> <span class="n">no_precheck_time</span> <span class="o">*</span> <span class="mf">0.9</span>
</pre></div>
</div>
</li>
<li><p>[ ] 20.3 Add retry backoff timing verification</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">test_retry_backoff_timing</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify exponential backoff timing matches specification.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{}),</span>
        <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{}),</span>
        <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{}),</span>
        <span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">request_with_retries</span><span class="p">(</span>
        <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.org/test&quot;</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="c1"># Expected delays:</span>
    <span class="c1"># Attempt 0: 1.0 * (2^0) = 1.0s</span>
    <span class="c1"># Attempt 1: 1.0 * (2^1) = 2.0s</span>
    <span class="c1"># Attempt 2: 1.0 * (2^2) = 4.0s</span>
    <span class="c1"># Total: ~7.0s (plus jitter ±0.3s)</span>
    <span class="k">assert</span> <span class="mf">6.5</span> <span class="o">&lt;</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="mf">7.5</span>
</pre></div>
</div>
</li>
<li><p>[ ] 20.4 Add memory usage benchmark for large batches</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">benchmark</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">memory</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_memory_usage_large_batch</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify memory stays bounded for large work batches.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">tracemalloc</span>

    <span class="n">tracemalloc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">baseline</span> <span class="o">=</span> <span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Process 1000 works</span>
    <span class="n">works</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_mock_work</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;W</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">works</span><span class="p">:</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">work</span><span class="p">)</span>

    <span class="n">peak</span> <span class="o">=</span> <span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">tracemalloc</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="n">memory_growth</span> <span class="o">=</span> <span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">baseline</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span>  <span class="c1"># MB</span>

    <span class="c1"># Memory should not grow linearly with work count</span>
    <span class="c1"># Expect &lt; 50MB for 1000 works (50KB/work)</span>
    <span class="k">assert</span> <span class="n">memory_growth</span> <span class="o">&lt;</span> <span class="mf">50.0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Memory grew </span><span class="si">{</span><span class="n">memory_growth</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB for 1000 works&quot;</span>
</pre></div>
</div>
</li>
</ul>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, DocsToKG Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>