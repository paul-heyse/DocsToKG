

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enhance Ontology Downloader: Robustness, Code Quality, and Extended Capabilities &mdash; DocsToKG 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />


      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



          <a href="../../../index.html" class="icon icon-home">
            DocsToKG
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../01-overview/index.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../02-setup/index.html">1. Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../03-architecture/index.html">1. Architecture Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../04-api/index.html">1. API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../05-development/index.html">1. Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../06-operations/index.html">1. Operations Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../07-reference/index.html">1. Technical Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DocsToKG</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Enhance Ontology Downloader: Robustness, Code Quality, and Extended Capabilities</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/openspec/changes/enhance-ontology-downloader-robustness/proposal.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <section id="enhance-ontology-downloader-robustness-code-quality-and-extended-capabilities">
<h1>Enhance Ontology Downloader: Robustness, Code Quality, and Extended Capabilities<a class="headerlink" href="#enhance-ontology-downloader-robustness-code-quality-and-extended-capabilities" title="Link to this heading"></a></h1>
<section id="why">
<h2>Why<a class="headerlink" href="#why" title="Link to this heading"></a></h2>
<p>The ontology downloader implementation in <code class="docutils literal notranslate"><span class="pre">src/DocsToKG/OntologyDownload</span></code> is functional and well-architected but carries technical debt and missing hardening that limits its production readiness and maintainability. A comprehensive code review identified 15 high-ROI improvements spanning three categories:</p>
<ol class="arabic simple">
<li><p><strong>Code Quality &amp; Maintenance Burden</strong>: ~150 lines of custom YAML fallback parser, duplicated optional dependency stubs across modules, and scattered CLI formatting utilities increase maintenance surface and testing complexity.</p></li>
<li><p><strong>Robustness &amp; Security Gaps</strong>: Missing media-type validation before downloads, coarse per-host rate limiting (vs. per-service), insufficient archive format coverage (tar.gz/tar.xz), non-deterministic normalization output, memory fragmentation from heavy validators, raw license string matching, and basic SSRF protection without IDN handling.</p></li>
<li><p><strong>Limited Capabilities</strong>: Single-resolver fallback requires manual config changes, missing polite API headers increase throttling, coverage gaps for LOV/Ontobee sources, local-only storage limits team workflows, and basic CLI lacks planning/diagnostics commands.</p></li>
</ol>
<p>These issues create operational friction, increase failure rates for edge cases, and require more manual intervention than necessary for a production pipeline component.</p>
</section>
<section id="what-changes">
<h2>What Changes<a class="headerlink" href="#what-changes" title="Link to this heading"></a></h2>
<section id="quick-wins-code-cleanup-delete-boilerplate-dry-it-up">
<h3>Quick Wins (Code Cleanup - delete boilerplate, DRY it up)<a class="headerlink" href="#quick-wins-code-cleanup-delete-boilerplate-dry-it-up" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>Replace custom YAML parser with Pydantic v2 models</strong> (<code class="docutils literal notranslate"><span class="pre">config.py</span></code>)</p>
<ul>
<li><p>Delete ~150 lines of fallback YAML parser implementation</p></li>
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">DefaultsConfig</span></code>, <code class="docutils literal notranslate"><span class="pre">DownloadConfiguration</span></code>, <code class="docutils literal notranslate"><span class="pre">ValidationConfig</span></code>, <code class="docutils literal notranslate"><span class="pre">LoggingConfiguration</span></code> dataclasses with Pydantic <code class="docutils literal notranslate"><span class="pre">BaseModel</span></code> subclasses</p></li>
<li><p>Use Pydantic’s <code class="docutils literal notranslate"><span class="pre">model_validate</span></code>, environment merging, and JSON Schema generation</p></li>
<li><p>Keep <code class="docutils literal notranslate"><span class="pre">yaml.safe_load</span></code> as the only YAML parser</p></li>
</ul>
</li>
<li><p><strong>Centralize optional dependency handling</strong> (new <code class="docutils literal notranslate"><span class="pre">optdeps.py</span></code>)</p>
<ul>
<li><p>Create single module with <code class="docutils literal notranslate"><span class="pre">get_pystow()</span></code>, <code class="docutils literal notranslate"><span class="pre">get_rdflib()</span></code>, <code class="docutils literal notranslate"><span class="pre">get_pronto()</span></code>, <code class="docutils literal notranslate"><span class="pre">get_owlready2()</span></code> functions</p></li>
<li><p>Move stub implementations from <code class="docutils literal notranslate"><span class="pre">core.py</span></code>, <code class="docutils literal notranslate"><span class="pre">resolvers.py</span></code>, <code class="docutils literal notranslate"><span class="pre">validators.py</span></code> to <code class="docutils literal notranslate"><span class="pre">optdeps.py</span></code></p></li>
<li><p>Reduce duplication from 3 separate stub implementations to 1 centralized module</p></li>
</ul>
</li>
<li><p><strong>Extract CLI formatting utilities</strong> (new <code class="docutils literal notranslate"><span class="pre">cli_utils.py</span></code>)</p>
<ul>
<li><p>Move <code class="docutils literal notranslate"><span class="pre">_format_table()</span></code> and <code class="docutils literal notranslate"><span class="pre">_format_row()</span></code> from <code class="docutils literal notranslate"><span class="pre">cli.py</span></code> to reusable module</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">_format_validation_summary()</span></code> to same module for consistency</p></li>
</ul>
</li>
</ul>
</section>
<section id="robustness-safety-minimal-code-maximum-impact">
<h3>Robustness &amp; Safety (minimal code, maximum impact)<a class="headerlink" href="#robustness-safety-minimal-code-maximum-impact" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>Add HEAD request with media-type validation</strong> (<code class="docutils literal notranslate"><span class="pre">download.py</span></code>)</p>
<ul>
<li><p>Modify <code class="docutils literal notranslate"><span class="pre">StreamingDownloader.__call__</span></code> to issue HEAD request before full GET</p></li>
<li><p>Check <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> header matches <code class="docutils literal notranslate"><span class="pre">FetchPlan.media_type</span></code> when specified</p></li>
<li><p>Retrieve <code class="docutils literal notranslate"><span class="pre">Content-Length</span></code> early to fail fast on oversized files</p></li>
<li><p>Log warnings for media-type mismatches, allow override via config flag</p></li>
</ul>
</li>
<li><p><strong>Implement per-service rate limits</strong> (<code class="docutils literal notranslate"><span class="pre">download.py</span></code>, <code class="docutils literal notranslate"><span class="pre">config.py</span></code>)</p>
<ul>
<li><p>Extend <code class="docutils literal notranslate"><span class="pre">TokenBucket</span></code> to support service keys (“obo”, “ols”, “bioportal”)</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">defaults.http.rate_limits</span></code> config section with per-service overrides</p></li>
<li><p>Extend rate limit parser to accept <code class="docutils literal notranslate"><span class="pre">/min</span></code>, <code class="docutils literal notranslate"><span class="pre">/hour</span></code> units (e.g., “2/s”, “5/min”, “1/hour”)</p></li>
<li><p>Default to per-host limit when service-specific limit not configured</p></li>
</ul>
</li>
<li><p><strong>Harden URL validation with allowlist and IDN handling</strong> (<code class="docutils literal notranslate"><span class="pre">download.py</span></code>)</p>
<ul>
<li><p>Add optional <code class="docutils literal notranslate"><span class="pre">allowed_hosts</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">validate_url_security()</span></code></p></li>
<li><p>Implement punycode normalization for Internationalized Domain Names</p></li>
<li><p>Check resolved host against allowlist when provided</p></li>
<li><p>Reject URLs not meeting allowlist criteria with clear error message</p></li>
</ul>
</li>
<li><p><strong>Safe tar.gz/tar.xz extraction</strong> (<code class="docutils literal notranslate"><span class="pre">download.py</span></code>)</p>
<ul>
<li><p>Create <code class="docutils literal notranslate"><span class="pre">extract_tar_safe()</span></code> function mirroring <code class="docutils literal notranslate"><span class="pre">extract_zip_safe()</span></code> logic</p></li>
<li><p>Validate all tar member paths for traversal attacks before extraction</p></li>
<li><p>Apply same compression ratio checks as ZIP extraction</p></li>
<li><p>Support XBRL and regulatory bundles that ship as tarballs</p></li>
</ul>
</li>
<li><p><strong>Deterministic normalization with stable hashing</strong> (<code class="docutils literal notranslate"><span class="pre">validators.py</span></code>, <code class="docutils literal notranslate"><span class="pre">core.py</span></code>)</p>
<ul>
<li><p>Implement TTL canonicalization: sort prefixes and triples before serialization</p></li>
<li><p>Compute SHA-256 hash of normalized (canonical) TTL content</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">normalized_sha256</span></code> and <code class="docutils literal notranslate"><span class="pre">fingerprint</span></code> fields to <code class="docutils literal notranslate"><span class="pre">Manifest</span></code> dataclass</p></li>
<li><p>Write these fields during <code class="docutils literal notranslate"><span class="pre">_write_manifest()</span></code> for cache correctness</p></li>
</ul>
</li>
<li><p><strong>Subprocess isolation for memory-intensive validators</strong> (<code class="docutils literal notranslate"><span class="pre">validators.py</span></code>)</p>
<ul>
<li><p>Modify <code class="docutils literal notranslate"><span class="pre">validate_pronto()</span></code> and <code class="docutils literal notranslate"><span class="pre">validate_owlready2()</span></code> to execute in subprocess</p></li>
<li><p>Pass file path and temp output directory as subprocess arguments</p></li>
<li><p>Read validation results back from JSON written by subprocess</p></li>
<li><p>Preserve existing timeout and memory monitoring in subprocess context</p></li>
</ul>
</li>
<li><p><strong>SPDX license normalization</strong> (<code class="docutils literal notranslate"><span class="pre">resolvers.py</span></code>, <code class="docutils literal notranslate"><span class="pre">core.py</span></code>)</p>
<ul>
<li><p>Create <code class="docutils literal notranslate"><span class="pre">normalize_license_to_spdx()</span></code> function mapping common variants to SPDX IDs</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">_ensure_license_allowed()</span></code> to compare normalized SPDX identifiers</p></li>
<li><p>Support common variations: “CC-BY” → “CC-BY-4.0”, “CC0” → “CC0-1.0”, etc.</p></li>
</ul>
</li>
</ul>
</section>
<section id="capability-upgrades-extend-coverage-without-breaking-changes">
<h3>Capability Upgrades (extend coverage without breaking changes)<a class="headerlink" href="#capability-upgrades-extend-coverage-without-breaking-changes" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>Automatic multi-resolver fallback</strong> (<code class="docutils literal notranslate"><span class="pre">core.py</span></code>)</p>
<ul>
<li><p>Create <code class="docutils literal notranslate"><span class="pre">FallbackResolver</span></code> class wrapping existing resolvers</p></li>
<li><p>Implement automatic fallback through <code class="docutils literal notranslate"><span class="pre">prefer_source</span></code> order on <code class="docutils literal notranslate"><span class="pre">ResolverError</span></code></p></li>
<li><p>Integrate into <code class="docutils literal notranslate"><span class="pre">fetch_one()</span></code> transparently without config changes</p></li>
<li><p>Log fallback attempts with source sequence and success/failure per attempt</p></li>
</ul>
</li>
<li><p><strong>Polite API headers for resolver requests</strong> (<code class="docutils literal notranslate"><span class="pre">resolvers.py</span></code>, <code class="docutils literal notranslate"><span class="pre">config.py</span></code>)</p>
<ul>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">defaults.http.polite_headers</span></code> config section</p></li>
<li><p>Include <code class="docutils literal notranslate"><span class="pre">User-Agent</span></code>, <code class="docutils literal notranslate"><span class="pre">From</span></code>, <code class="docutils literal notranslate"><span class="pre">X-Request-ID</span></code> headers in OLS/BioPortal API calls</p></li>
<li><p>Reduce throttling and improve reproducibility of API interactions</p></li>
<li><p>Default to project-appropriate headers when not configured</p></li>
</ul>
</li>
<li><p><strong>LOV and Ontobee resolver implementations</strong> (<code class="docutils literal notranslate"><span class="pre">resolvers.py</span></code>)</p>
<ul>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">LOVResolver</span></code> for Linked Open Vocabularies SKOS/TTL sources</p></li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">OntobeeResolver</span></code> for OBO domain ontology PURLs</p></li>
<li><p>Register both in <code class="docutils literal notranslate"><span class="pre">RESOLVERS</span></code> dictionary</p></li>
<li><p>Document resolver usage in example <code class="docutils literal notranslate"><span class="pre">sources.yaml</span></code></p></li>
</ul>
</li>
<li><p><strong>fsspec-backed remote storage support</strong> (<code class="docutils literal notranslate"><span class="pre">core.py</span></code>, <code class="docutils literal notranslate"><span class="pre">config.py</span></code>)</p>
<ul>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">ONTOFETCH_STORAGE_URL</span></code> environment variable (e.g., <code class="docutils literal notranslate"><span class="pre">s3://bucket/prefix</span></code>)</p></li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">fsspec</span></code>-based manifest and artifact read/write when URL provided</p></li>
<li><p>Maintain backward compatibility: default to local <code class="docutils literal notranslate"><span class="pre">pystow</span></code> storage</p></li>
<li><p>Enable team-wide cache sharing for multi-user pipelines</p></li>
</ul>
</li>
<li><p><strong>Enhanced CLI with plan, doctor, dry-run</strong> (<code class="docutils literal notranslate"><span class="pre">cli.py</span></code>)</p>
<ul>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">ontofetch</span> <span class="pre">plan</span> <span class="pre">&lt;id&gt;</span></code> subcommand: print <code class="docutils literal notranslate"><span class="pre">FetchPlan</span></code> JSON without downloading</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">ontofetch</span> <span class="pre">doctor</span></code> subcommand: check credentials, filesystem permissions, emit diagnostics</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> flag to <code class="docutils literal notranslate"><span class="pre">pull</span></code> subcommand: log planned actions without execution</p></li>
<li><p>Improve operational visibility and troubleshooting</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="impact">
<h2>Impact<a class="headerlink" href="#impact" title="Link to this heading"></a></h2>
<section id="affected-specs">
<h3>Affected Specs<a class="headerlink" href="#affected-specs" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ontology-downloader</span></code> (multiple requirements modified and added)</p></li>
</ul>
</section>
<section id="affected-code">
<h3>Affected Code<a class="headerlink" href="#affected-code" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src/DocsToKG/OntologyDownload/config.py</span></code> - <strong>MODIFIED</strong>: Pydantic models, rate limit config, polite headers</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/DocsToKG/OntologyDownload/core.py</span></code> - <strong>MODIFIED</strong>: FallbackResolver, fsspec storage, manifest fields</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/DocsToKG/OntologyDownload/download.py</span></code> - <strong>MODIFIED</strong>: HEAD requests, per-service rate limits, tar extraction, URL validation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/DocsToKG/OntologyDownload/validators.py</span></code> - <strong>MODIFIED</strong>: subprocess isolation, deterministic normalization</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/DocsToKG/OntologyDownload/resolvers.py</span></code> - <strong>MODIFIED</strong>: LOV/Ontobee resolvers, polite headers, SPDX normalization</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/DocsToKG/OntologyDownload/cli.py</span></code> - <strong>MODIFIED</strong>: plan/doctor commands, dry-run, extracted formatting</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/DocsToKG/OntologyDownload/optdeps.py</span></code> - <strong>NEW</strong>: centralized optional dependency handling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/DocsToKG/OntologyDownload/cli_utils.py</span></code> - <strong>NEW</strong>: extracted CLI formatting utilities</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tests/ontology_download/*.py</span></code> - <strong>MODIFIED/NEW</strong>: comprehensive test coverage for all new behaviors</p></li>
</ul>
</section>
<section id="breaking-changes">
<h3>Breaking Changes<a class="headerlink" href="#breaking-changes" title="Link to this heading"></a></h3>
<p>None. All changes are backward compatible:</p>
<ul class="simple">
<li><p>Existing <code class="docutils literal notranslate"><span class="pre">sources.yaml</span></code> files continue to work</p></li>
<li><p>New config fields are optional with sensible defaults</p></li>
<li><p>CLI commands remain unchanged, new subcommands are additive</p></li>
<li><p>Manifest schema is extended (added fields), not modified</p></li>
<li><p>Resolver interface unchanged, new resolvers are additions</p></li>
</ul>
</section>
<section id="migration-path">
<h3>Migration Path<a class="headerlink" href="#migration-path" title="Link to this heading"></a></h3>
<p>No migration required. Optional enhancements can be adopted incrementally:</p>
<ol class="arabic simple">
<li><p>Users can add <code class="docutils literal notranslate"><span class="pre">rate_limits</span></code> section to config when needed</p></li>
<li><p>Teams can set <code class="docutils literal notranslate"><span class="pre">ONTOFETCH_STORAGE_URL</span></code> to enable remote storage</p></li>
<li><p>New resolvers and CLI commands available immediately without config changes</p></li>
<li><p>Pydantic validation provides clearer error messages automatically</p></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, DocsToKG Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
